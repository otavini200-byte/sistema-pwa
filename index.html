<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sistema PWA</title>

<style>
:root{
  --primary:#6a4bc9;
  --bg:#f3f4f8;
  --card:#fff;
  --text:#333;
}
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{margin:0;background:var(--bg);color:var(--text)}
.hidden{display:none}

.login{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  width:380px;
  background:var(--card);
  padding:30px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.15);
  animation:fade .4s ease;
}
@keyframes fade{from{opacity:0;transform:translateY(20px)}to{opacity:1}}

h2{text-align:center;margin-bottom:20px}

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-top:10px;
  font-size:14px;
}

button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:bold;
  margin-top:14px;
  cursor:pointer;
  transition:.2s;
}
button:hover{opacity:.9;transform:translateY(-1px)}

.links{
  text-align:center;
  margin-top:12px;
  font-size:13px;
}
.links span{
  cursor:pointer;
  color:var(--primary);
  margin:0 6px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <div class="card">
    <h2>üîê Login</h2>
    <input id="usuario" placeholder="Usu√°rio">
    <input id="senha" type="password" placeholder="Senha">
    <button onclick="entrar()">Entrar</button>

    <div class="links">
      <span onclick="mostrarCadastro()">Criar conta</span> |
      <span onclick="toggleSenha()">üëÅ Ver senha</span>
    </div>
  </div>
</div>

<!-- CADASTRO -->
<div class="login hidden" id="cadastroBox">
  <div class="card">
    <h2>üìù Cadastro</h2>
    <input id="cUser" placeholder="Usu√°rio">
    <input id="cSenha" placeholder="Senha">
    <input id="cEmail" placeholder="Email">
    <button onclick="cadastrar()">Cadastrar</button>
    <button onclick="voltarLogin()">Voltar</button>
  </div>
</div>

<script>
/* ========= URL DO APPS SCRIPT ========= */
const API_URL = "COLE_AQUI_SUA_URL_EXEC";

/* ========= FUN√á√ïES VISUAIS ========= */
function toggleSenha(){
  const s = document.getElementById("senha");
  s.type = s.type === "password" ? "text" : "password";
}

function mostrarCadastro(){
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("cadastroBox").classList.remove("hidden");
}

function voltarLogin(){
  document.getElementById("cadastroBox").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
}

/* ========= API ========= */
async function api(action, ...args){
  const r = await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify({action,args})
  });
  return r.json();
}

/* ========= LOGIN ========= */
async function entrar(){
  const u = usuario.value.trim();
  const s = senha.value.trim();

  if(!u || !s){
    alert("Preencha usu√°rio e senha");
    return;
  }

  const res = await api("login", u, s);
  if(!res.ok){
    alert(res.msg || "Login inv√°lido");
    return;
  }

  alert("Login OK! N√≠vel: " + res.nivel);
}

/* ========= CADASTRO ========= */
async function cadastrar(){
  const u = cUser.value.trim();
  const s = cSenha.value.trim();
  const e = cEmail.value.trim();

  if(!u || !s || !e){
    alert("Preencha todos os campos");
    return;
  }

  const res = await api("cadastrar", u, s, e);
  alert(res.ok ? "Conta criada!" : res.msg);
  if(res.ok) voltarLogin();
}

/* ========= ENTER NO LOGIN ========= */
usuario.addEventListener("keyup",e=>{if(e.key==="Enter")entrar()});
senha.addEventListener("keyup",e=>{if(e.key==="Enter")entrar()});
</script>

</body>
</html>

  <!-- SISTEMA -->
  <div class="hidden" id="sistema">
    <div class="topbar">
      <div class="brand">‚ö° Sistema <span class="pill" id="pillUser">‚Äî</span></div>
      <div style="display:flex;gap:10px;align-items:center;">
        <span class="pill" id="pillNivel">‚Äî</span>
        <button class="btn secondary" style="width:auto;margin:0;padding:10px 12px;" onclick="openConfig()">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="sistema">
      <div class="sidebar">
        <div class="menu-title">MENU</div>
        <div class="menu" id="menuPrincipal">
          <div id="m_transferencia" onclick="abrir('transferencia')">üì¶ Transfer√™ncia <small>Importar</small></div>
          <div id="m_zeramento" onclick="abrir('zeramento')">üîÅ Zeramento <small>Importar</small></div>
          <div id="m_requisicao" onclick="abrir('requisicao')">üìù Requisi√ß√£o <small>Importar</small></div>
        </div>

        <div class="menu-title">CONFIG</div>
        <div class="menu" id="menuConfig">
          <div onclick="abrir('cfgTransfer')">üîß Local Transfer√™ncia <small>De/Para</small></div>
          <div onclick="abrir('tema')">üåó Tema <small>Claro/Escuro</small></div>
          <div id="btnAdminMenu" class="hidden" onclick="abrir('adminPerms')">üõ°Ô∏è Admin <small>Permiss√µes</small></div>
          <div id="btnAdminEmail" class="hidden" onclick="abrir('adminEmail')">‚úâÔ∏è Admin <small>Email</small></div>
          <div onclick="logout()">üö™ Sair <small>Logout</small></div>
        </div>
      </div>

      <div class="conteudo">

        <div class="box hidden fade-in" id="transferencia">
          <h2>üì¶ Transfer√™ncia</h2>
          <div class="tabela-container">
            <table class="tabela-colagem"><tbody></tbody></table>
          </div>
          <div class="row">
            <button class="btn" onclick="importacaoTransferencia()">Importa√ß√£o</button>
            <button class="btn danger" onclick="limparTabela('transferencia')">Limpar</button>
          </div>
          <div class="hint">QTD negativa vira positiva no TXT. QTD=0 n√£o exporta. DE/PARA usa QTD1/QTD2 + ‚ÄúOutro Local‚Äù.</div>
        </div>

        <div class="box hidden fade-in" id="zeramento">
          <h2>üîÅ Zeramento</h2>
          <div class="tabela-container">
            <table class="tabela-colagem"><tbody></tbody></table>
          </div>
          <div class="row">
            <button class="btn" onclick="importacaoZeramento()">Importa√ß√£o</button>
            <button class="btn danger" onclick="limparTabela('zeramento')">Limpar</button>
          </div>
          <div class="hint">QTD negativa vira positiva no TXT. QTD=0 n√£o exporta. Tipo: qtd2&gt;qtd1 ‚Üí E/1905 sen√£o S/5906.</div>
        </div>

        <div class="box hidden fade-in" id="requisicao">
          <h2>üìù Requisi√ß√£o</h2>
          <div class="tabela-container">
            <table class="tabela-colagem"><tbody></tbody></table>
          </div>
          <div class="row">
            <button class="btn" onclick="importacaoRequisicao()">Importa√ß√£o</button>
            <button class="btn danger" onclick="limparTabela('requisicao')">Limpar</button>
          </div>
          <div class="hint">Cole: Pedido | Cliente | C√≥digoItem | Chave5 | Chave6 | Chave7 | Qtd ‚Äî (QTD negativa vira positiva)</div>
        </div>

        <div class="box hidden fade-in" id="cfgTransfer">
          <h2>üîß Local Transfer√™ncia</h2>
          <span class="tag">Coluna 9 = Local informado</span>
          <input id="cfgLocalOutro" placeholder="Outro local (ex: 4044)">
          <button class="btn" onclick="salvarCfgTransfer()">Salvar</button>
          <div class="hint">Se qtd1 &gt; qtd2 ‚Üí Local informado ‚Üí Outro local. Se qtd2 &gt; qtd1 ‚Üí Outro local ‚Üí Local informado.</div>
        </div>

        <div class="box hidden fade-in" id="tema">
          <h2>üåó Tema</h2>
          <div class="row">
            <button class="btn secondary" onclick="setTema('light')">‚òÄÔ∏è Claro</button>
            <button class="btn" onclick="setTema('dark')">üåô Escuro</button>
          </div>
        </div>

        <div class="box hidden fade-in" id="adminEmail">
          <h2>‚úâÔ∏è Admin ‚Äî Alterar Email</h2>
          <div class="row">
            <select id="admEmailUser"></select>
            <input id="admEmailNovo" placeholder="Novo email">
          </div>
          <div class="row">
            <button class="btn" onclick="adminSalvarEmail()">Salvar</button>
            <button class="btn secondary" onclick="adminRecarregar()">Recarregar</button>
          </div>
        </div>

        <div class="box hidden fade-in" id="adminPerms">
          <h2>üõ°Ô∏è Admin ‚Äî Permiss√µes</h2>
          <div id="adminPermsWrap"></div>
          <div class="hint">A planilha pode ter s√≥ 4 colunas; se tiver E/F/G, aqui vira controle fino.</div>
          <div class="row">
            <button class="btn secondary" onclick="adminRecarregar()">Recarregar</button>
            <button class="btn secondary" onclick="abrir('transferencia')">Voltar</button>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* ========= COLE SUA URL /exec AQUI ========= */
const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgYXXJe6aFBSWs4driFdDCn0LrqfQsqa4aMmCMCHKnAQp_nVhWDuVQlbc44beUSG8JFM7PpQ3X-zbj4WQdZ_He9ndHfSPovqKA7x52Osw8do8oT74cSS1cNj7eT8ErJBEXkxx6waJT6vsBRmlM8wA0zwduesHJLtunwnN2QfGkrIO1NIDSw-5_0FYViVePF5pAcn8DcUZDaJqftoyMBATHVOCqr571G8lVrR7TC61UL3HOOfyQZNfTlgetXTzzcubeVRBiGyi0980YBxYrbYWSyEObDLw&lib=McTwOPg6EjKgsOsf3ykd3XBrns8elDHiD";

/* PWA SW */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(function(){});
}

/* Helpers */
function $(id){ return document.getElementById(id); }

function showLogin(id){
  ["loginBox","cadastro","recuperar"].forEach(function(x){ $(x).classList.add("hidden"); });
  $(id).classList.remove("hidden");
}

function toggleSenha(){
  var el = $("senha");
  el.type = (el.type === "password") ? "text" : "password";
}

async function api(action){
  var args = Array.prototype.slice.call(arguments, 1);
  var payload = JSON.stringify({ action: action, args: args });
  var r = await fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: payload
  });
  return await r.json();
}

/* Estado */
var NIVEL = "";
var USUARIO_LOGADO = "";
var PERMS = {transferencia:"EDITAR", zeramento:"EDITAR", requisicao:"EDITAR"};
var COLUNAS_FIXAS = 9;
var codCache = new Map();

var LOCAL_OUTRO_TRANSFER = localStorage.getItem("LOCAL_OUTRO_TRANSFER") || "4044";

/* UI */
function abrir(id){
  var boxes = document.querySelectorAll(".box");
  boxes.forEach(function(b){ b.classList.add("hidden"); });
  $(id).classList.remove("hidden");
}

function setTema(t){
  if(t === "light"){
    document.documentElement.classList.add("light");
  } else {
    document.documentElement.classList.remove("light");
  }
}

/* Tabela estilo planilha */
function criarTabela(boxId, linhas, colunas){
  linhas = linhas || 10;
  colunas = colunas || 9;

  var tbody = document.querySelector("#"+boxId+" .tabela-colagem tbody");
  tbody.innerHTML = "";

  for(var i=0;i<linhas;i++){
    var tr = document.createElement("tr");
    for(var j=0;j<colunas;j++){
      var td = document.createElement("td");
      td.contentEditable = "true";
      td.addEventListener("paste", handlePaste);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

function limparTabela(boxId){
  criarTabela(boxId, 10, COLUNAS_FIXAS);
}

function handlePaste(e){
  e.preventDefault();
  var text = (e.clipboardData || window.clipboardData).getData("text");
  var rows = text.split(/\r?\n/).filter(function(r){ return r !== ""; });

  var startCell = e.target;
  var tr = startCell.parentElement;
  var tbody = tr.parentElement;

  var rowIndex = Array.from(tbody.rows).indexOf(tr);
  var colIndex = Array.from(tr.cells).indexOf(startCell);

  rows.forEach(function(r, i){
    var cols = r.split(/\t/);
    var targetRow = tbody.rows[rowIndex + i];
    if(!targetRow){
      targetRow = tbody.insertRow();
      for(var k=0;k<COLUNAS_FIXAS;k++){
        var td = targetRow.insertCell();
        td.contentEditable = "true";
        td.addEventListener("paste", handlePaste);
      }
    }
    cols.forEach(function(c, j){
      var td = targetRow.cells[colIndex + j];
      if(td) td.innerText = c;
    });
  });
}

/* Valores */
function dataHoje_ptBR(){
  return new Date().toLocaleDateString("pt-BR");
}

function normalizeQTD(str){
  var s = String(str || "0").trim();
  // aceita -5, 1.234,56, etc.
  var v = parseFloat(s.replace(/\./g,"").replace(",", "."));
  if (isNaN(v)) v = 0;
  return v;
}

// ABS garantido AQUI (mesmo que algu√©m chame errado)
function absQTDNumFromText(txt){
  return Math.abs(normalizeQTD(txt));
}

function formatQtdTxtFromNum(n){
  n = Math.abs(Number(n) || 0); // GARANTE POSITIVO
  if (Number.isInteger(n)) return String(n);
  var s = n.toFixed(3).replace(".", ",");
  s = s.replace(/0+$/,"").replace(/,$/,"");
  return s;
}

function baixarComoTXT(nome, texto){
  var blob = new Blob([texto],{type:"text/plain"});
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = nome + ".txt";
  a.click();
}

/* Config Transfer */
function salvarCfgTransfer(){
  var v = String($("cfgLocalOutro").value || "").trim();
  if(!v) return alert("Informe o outro local (ex: 4044).");
  LOCAL_OUTRO_TRANSFER = v;
  localStorage.setItem("LOCAL_OUTRO_TRANSFER", v);
  alert("Salvo!");
}

function carregarCfgTransferUI(){
  if($("cfgLocalOutro")) $("cfgLocalOutro").value = LOCAL_OUTRO_TRANSFER;
}

/* Permiss√µes */
function aplicarPermissoesUI(){
  $("m_transferencia").style.display = (PERMS.transferencia === "BLOQUEAR") ? "none" : "";
  $("m_zeramento").style.display = (PERMS.zeramento === "BLOQUEAR") ? "none" : "";
  $("m_requisicao").style.display = (PERMS.requisicao === "BLOQUEAR") ? "none" : "";

  $("btnAdminMenu").classList.toggle("hidden", NIVEL !== "ADMIN");
  $("btnAdminEmail").classList.toggle("hidden", NIVEL !== "ADMIN");
}

/* Backend helpers */
async function mapearOuCadastrar(chave){
  var key = String(chave || "").trim();
  if(!key) return "";
  var norm = key.toLowerCase();

  if(codCache.has(norm)) return codCache.get(norm);

  var res = await api("cod_get", key);
  if(res.ok && res.found){
    codCache.set(norm, res.value);
    return res.value;
  }

  var saida = prompt('CHAVE n√£o cadastrada (COD A/B):\n"'+key+'"\nDigite o que deve sair no TXT:');
  if(saida === null) throw new Error("Cadastro cancelado: " + key);

  var out = String(saida || "").trim();
  if(!out) throw new Error("Sa√≠da vazia: " + key);

  var saved = await api("cod_set", key, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar COD");

  codCache.set(norm, out);
  return out;
}

async function getLocalPorItem(codigoItem){
  var code = String(codigoItem || "").trim();
  if(!code) return "";

  var res = await api("cod_get_local", code);
  if(res.ok && res.found) return res.value;

  var local = prompt('LOCAL n√£o cadastrado para item "'+code+'" (COD D/E).\nDigite o LOCAL (ex: 164):');
  if(local === null) throw new Error("Cadastro de local cancelado.");

  var out = String(local || "").trim();
  if(!out) throw new Error("LOCAL vazio.");

  var saved = await api("cod_set_local", code, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar local.");

  return out;
}

async function getRequisitantePorUsuario(usuario){
  var u = String(usuario || "").trim().toLowerCase();
  if(!u) return "74";

  var res = await api("req_get", u);
  if(res.ok && res.found) return res.value;

  var req = prompt('Requisitante n√£o cadastrado para "'+u+'".\nDigite o valor (ex: 74):');
  if(req === null) throw new Error("Cadastro cancelado.");

  var out = String(req || "").trim();
  if(!out) throw new Error("Requisitante vazio.");

  var saved = await api("req_set", u, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar requisitante.");

  return out;
}

/* Auth */
async function entrar(){
  if(API_URL.indexOf(https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgYXXJe6aFBSWs4driFdDCn0LrqfQsqa4aMmCMCHKnAQp_nVhWDuVQlbc44beUSG8JFM7PpQ3X-zbj4WQdZ_He9ndHfSPovqKA7x52Osw8do8oT74cSS1cNj7eT8ErJBEXkxx6waJT6vsBRmlM8wA0zwduesHJLtunwnN2QfGkrIO1NIDSw-5_0FYViVePF5pAcn8DcUZDaJqftoyMBATHVOCqr571G8lVrR7TC61UL3HOOfyQZNfTlgetXTzzcubeVRBiGyi0980YBxYrbYWSyEObDLw&lib=McTwOPg6EjKgsOsf3ykd3XBrns8elDHiD) >= 0) return alert("Cole sua URL /exec em API_URL no index.html");

  var u = $("usuario").value;
  var s = $("senha").value;

  var res = await api("login", u, s);
  if(!res.ok) return alert(res.msg || "Usu√°rio ou senha inv√°lidos");

  NIVEL = res.nivel;
  USUARIO_LOGADO = res.usuario;
  PERMS = res.perms || PERMS;

  $("pillUser").textContent = res.usuario;
  $("pillNivel").textContent = res.nivel;

  document.body.classList.remove("lock");
  $("loginBox").classList.add("hidden");
  $("cadastro").classList.add("hidden");
  $("recuperar").classList.add("hidden");

  $("sistema").classList.remove("hidden");

  criarTabela("transferencia",10,COLUNAS_FIXAS);
  criarTabela("zeramento",10,COLUNAS_FIXAS);
  criarTabela("requisicao",10,COLUNAS_FIXAS);

  carregarCfgTransferUI();
  aplicarPermissoesUI();
  abrir("transferencia");

  if(NIVEL === "ADMIN") await adminRecarregar();
}

async function cadastrar(){
  var res = await api("cadastrar", $("cUser").value, $("cSenha").value, $("cEmail").value);
  alert(res.ok ? "Conta criada!" : (res.msg || "Erro"));
  if(res.ok) showLogin("loginBox");
}

async function recuperarSenha(){
  var res = await api("recuperar", $("rUser").value);
  alert(res.ok ? "Email enviado!" : (res.msg || "Erro"));
}

function logout(){
  NIVEL = ""; USUARIO_LOGADO = "";
  $("sistema").classList.add("hidden");
  $("loginBox").classList.remove("hidden");
  document.body.classList.add("lock");
  $("senha").value = "";
}

/* IMPORTA√á√ÉO: NEGATIVOS SEMPRE POSITIVOS + N√ÉO EXPORTA 0 */
async function importacaoTransferencia(){
  try{
    var rows = document.querySelectorAll("#transferencia .tabela-colagem tbody tr");
    var hoje = dataHoje_ptBR();
    var saida = [];

    for (var r=0; r<rows.length; r++){
      var tr = rows[r];
      var c = Array.from(tr.cells).map(function(td){ return String(td.innerText||"").trim(); });
      while(c.length < 9) c.push("");

      var codigo = c[0];
      var chave5 = c[2], chave6 = c[3], chave7 = c[4];

      var qtd1 = normalizeQTD(c[5]||"0");
      var qtd2 = normalizeQTD(c[6]||"0");

      var qtd3AbsNum = absQTDNumFromText(c[7]||"0");
      if(qtd3AbsNum === 0) continue;

      var qtd3Txt = formatQtdTxtFromNum(qtd3AbsNum);

      var localInformado = (c[8]||"164").trim() || "164";
      var outroLocal = String(LOCAL_OUTRO_TRANSFER || "4044").trim();

      if(!codigo && !chave5 && !chave6 && !chave7 && qtd1===0 && qtd2===0) continue;

      var f5 = await mapearOuCadastrar(chave5);
      var f6 = await mapearOuCadastrar(chave6);
      var f7 = await mapearOuCadastrar(chave7);

      // DE/PARA (n√£o √© mais 4044 fixo)
      var origem = localInformado, destino = outroLocal;
      if(qtd2 > qtd1){ origem = outroLocal; destino = localInformado; }

      // valor sempre positivo
      var valor = (qtd3AbsNum * 0.01).toFixed(2).replace(".", ",");

      saida.push(["M1","T",hoje,codigo,f5,f6,f7,origem,destino,qtd3Txt,"0,01",valor,"5949"].join("|"));
    }

    if(!saida.length) return alert("Nada para importar.");
    baixarComoTXT("importacao_transferencia", saida.join("\n"));
  } catch(err){
    alert("Erro: " + err.message);
  }
}

async function importacaoZeramento(){
  try{
    var rows = document.querySelectorAll("#zeramento .tabela-colagem tbody tr");
    var hoje = dataHoje_ptBR();
    var saida = [];

    for (var r=0; r<rows.length; r++){
      var tr = rows[r];
      var c = Array.from(tr.cells).map(function(td){ return String(td.innerText||"").trim(); });
      while(c.length < 9) c.push("");

      var codigo = c[0];
      var chave5 = c[2], chave6 = c[3], chave7 = c[4];

      var qtd1 = normalizeQTD(c[5]||"0");
      var qtd2 = normalizeQTD(c[6]||"0");

      var qtd3AbsNum = absQTDNumFromText(c[7]||"0");
      if(qtd3AbsNum === 0) continue;
      var qtd3Txt = formatQtdTxtFromNum(qtd3AbsNum);

      var local = (c[8]||"164").trim() || "164";

      if(!codigo && !chave5 && !chave6 && !chave7 && qtd1===0 && qtd2===0) continue;

      var f5 = await mapearOuCadastrar(chave5);
      var f6 = await mapearOuCadastrar(chave6);
      var f7 = await mapearOuCadastrar(chave7);

      var tipo = (qtd2 > qtd1) ? "E" : "S";
      var final = (qtd2 > qtd1) ? "1905" : "5906";

      var valor = (qtd3AbsNum * 0.01).toFixed(2).replace(".", ",");

      saida.push(["M1",tipo,hoje,codigo,f5,f6,f7,local,qtd3Txt,"0,01",valor,final].join("|"));
    }

    if(!saida.length) return alert("Nada para importar.");
    baixarComoTXT("importacao_zeramento", saida.join("\n"));
  } catch(err){
    alert("Erro: " + err.message);
  }
}

async function importacaoRequisicao(){
  try{
    var rows = document.querySelectorAll("#requisicao .tabela-colagem tbody tr");
    var hoje = dataHoje_ptBR();
    var requisitante = await getRequisitantePorUsuario(USUARIO_LOGADO);

    var pedidos = new Map();

    for (var r=0; r<rows.length; r++){
      var tr = rows[r];
      var raw = Array.from(tr.cells).map(function(td){ return String(td.innerText||"").trim(); });
      if(raw.every(function(x){return !x;})) continue;

      var pedido = (raw[0]||"").trim();
      var cliente = (raw[1]||"").trim();
      var codigo = (raw[2]||"").trim();
      var k5 = (raw[3]||"").trim();
      var k6 = (raw[4]||"").trim();
      var k7 = (raw[5]||"").trim();

      var qtdAbsNum = absQTDNumFromText(raw[6]||"0");
      if(qtdAbsNum === 0) continue;
      var qtdTxt = formatQtdTxtFromNum(qtdAbsNum);

      if(!pedido || !codigo) continue;

      if(!pedidos.has(pedido)) pedidos.set(pedido, {cliente:cliente, itens:[]});
      if(!pedidos.get(pedido).cliente && cliente) pedidos.get(pedido).cliente = cliente;

      pedidos.get(pedido).itens.push({codigo:codigo, k5:k5, k6:k6, k7:k7, qtd:qtdTxt});
    }

    var out = [];
    pedidos.forEach(async function(){});
    for (const [pedido, obj] of pedidos.entries()){
      out.push(["R",hoje,"1","1",requisitante,"27",pedido+"  -  "+(obj.cliente||""),pedido,"0","0"].join("|"));
      for (var i=0;i<obj.itens.length;i++){
        var it = obj.itens[i];
        var local = await getLocalPorItem(it.codigo);
        out.push(["I","P",it.codigo,it.k5||"",it.k6||"",it.k7||"",it.qtd,"3",local].join("|"));
      }
    }

    if(!out.length) return alert("Nada para importar.");
    baixarComoTXT("importacao_requisicao", out.join("\n"));
  } catch(err){
    alert("Erro: " + err.message);
  }
}

/* Admin */
async function adminRecarregar(){
  var res = await api("admin_listarUsuarios", USUARIO_LOGADO);
  if(!res.ok) return alert(res.msg || "Erro ao listar usu√°rios");

  var sel = $("admEmailUser");
  if(sel){
    sel.innerHTML = "";
    res.usuarios.forEach(function(u){
      var op = document.createElement("option");
      op.value = u.usuario;
      op.textContent = u.usuario + " ("+u.nivel+")";
      sel.appendChild(op);
    });
  }

  renderPermsTable(res.usuarios);
}

async function adminSalvarEmail(){
  var alvo = $("admEmailUser").value;
  var novo = $("admEmailNovo").value;
  var r = await api("admin_alterarEmail", USUARIO_LOGADO, alvo, novo);
  alert(r.ok ? "Email atualizado!" : (r.msg || "Erro"));
}

function renderPermsTable(users){
  var wrap = $("adminPermsWrap");
  if(!wrap) return;
  wrap.innerHTML = "";

  var table = document.createElement("table");
  table.className = "table-admin";

  table.innerHTML =
    "<thead><tr>"+
    "<th>Usu√°rio</th><th>N√≠vel</th><th>Transfer√™ncia</th><th>Zeramento</th><th>Requisi√ß√£o</th><th>A√ß√£o</th>"+
    "</tr></thead>";

  var tb = document.createElement("tbody");

  var niveis = ["ADMIN","OPERADOR","CONSULTA","USER"];
  var perms = ["EDITAR","VISUALIZAR","BLOQUEAR"];

  users.forEach(function(u){
    var tr = document.createElement("tr");

    var selNivel = mkSelect(niveis, u.nivel);
    var selT = mkSelect(perms, u.perms.transferencia);
    var selZ = mkSelect(perms, u.perms.zeramento);
    var selR = mkSelect(perms, u.perms.requisicao);

    var btn = document.createElement("button");
    btn.className = "btn";
    btn.style.margin = "0";
    btn.style.padding = "10px 12px";
    btn.textContent = "Salvar";
    btn.onclick = async function(){
      var resp = await api("admin_salvarPermissoes", USUARIO_LOGADO, u.usuario, selNivel.value, selT.value, selZ.value, selR.value);
      alert(resp.ok ? "Salvo!" : (resp.msg || "Erro"));
    };

    tr.appendChild(tdText(u.usuario));
    tr.appendChild(tdWrap(selNivel));
    tr.appendChild(tdWrap(selT));
    tr.appendChild(tdWrap(selZ));
    tr.appendChild(tdWrap(selR));
    tr.appendChild(tdWrap(btn));
    tb.appendChild(tr);
  });

  table.appendChild(tb);
  wrap.appendChild(table);

  function mkSelect(opts, current){
    var s = document.createElement("select");
    opts.forEach(function(o){
      var op = document.createElement("option");
      op.value = o; op.textContent = o;
      if(String(current||"").toUpperCase() === o) op.selected = true;
      s.appendChild(op);
    });
    return s;
  }
  function tdText(t){ var td=document.createElement("td"); td.textContent=t; return td; }
  function tdWrap(el){ var td=document.createElement("td"); td.appendChild(el); return td; }
}

/* Config shortcut */
function openConfig(){
  abrir("cfgTransfer");
}

/* Enter no login */
$("usuario").addEventListener("keyup", function(e){ if(e.key === "Enter") entrar(); });
$("senha").addEventListener("keyup", function(e){ if(e.key === "Enter") entrar(); });

</script>
</body>
</html>
