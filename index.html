<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#6a4bc9" />

  <style>
    :root{
      --primary:#6a4bc9; --secondary:#2c1a4d;
      --bg:#f2f4f8; --card:#fff; --text:#333;
      --shadow: rgba(0,0,0,0.12); --line:#d7d7d7;
    }
    .dark{ --bg:#121212; --card:#1e1e1e; --text:#f1f1f1; --shadow: rgba(0,0,0,0.5); --line:#444; }
    *{box-sizing:border-box;font-family:Segoe UI,Arial,sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);transition:all .25s;}
    body.lock{overflow:hidden;}

    input, select{
      width:100%; padding:12px; margin-top:10px;
      border-radius:10px; border:1px solid var(--line);
      outline:none; background:var(--card); color:var(--text);
    }
    input:focus, select:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(106,75,201,0.18);}

    button{
      width:100%; padding:12px; border-radius:10px;
      border:none; background:var(--primary); color:#fff;
      cursor:pointer; transition:transform .15s, opacity .15s; margin-top:6px;
    }
    button:hover{opacity:0.92;transform:translateY(-1px);}
    .btn-danger{background:#c0392b;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .row > *{flex:1;min-width:160px;}

    .login{min-height:100vh;display:flex;align-items:center;justify-content:center;}
    .login-card{
      background:var(--card); padding:36px; width:390px;
      border-radius:16px; box-shadow:0 14px 40px var(--shadow);
    }
    .login-card h2{text-align:center;margin:0 0 18px 0;}
    .login-links{text-align:center;margin-top:12px;font-size:13px;}
    .login-links span{cursor:pointer;color:var(--secondary);margin:0 6px;}
    .login-links span:hover{color:var(--primary);}

    .hidden{display:none;}
    .sistema{display:flex;min-height:100vh;}
    .sidebar{
      width:270px;
      background:linear-gradient(180deg,var(--primary),#1b0f30);
      color:#fff; padding:18px; position:relative;
    }
    .sidebar h3{text-align:center;margin:6px 0 14px 0;}
    .menu div{
      padding:12px; margin-bottom:10px;
      background:rgba(255,255,255,.12);
      border-radius:10px; text-align:center;
      cursor:pointer; transition:all .15s; user-select:none;
    }
    .menu div:hover{background:rgba(255,255,255,.22);}
    .menu.inferior{position:absolute;bottom:18px;width:234px;}

    .conteudo{flex:1;padding:26px;}
    .box{
      background:var(--card); padding:22px; border-radius:16px;
      box-shadow:0 10px 26px var(--shadow); max-width:1300px;
      opacity:0; transform:translateY(10px); transition:all .22s;
    }
    .box.show{opacity:1;transform:translateY(0);}

    .tabela-container{border:1px solid var(--line);border-radius:12px;overflow:auto;min-height:260px;background:rgba(255,255,255,0.35);}
    .dark .tabela-container{background:rgba(0,0,0,0.12);}
    .tabela-colagem{width:100%;border-collapse:collapse;}
    .tabela-colagem td{border:1px solid var(--line);padding:7px;font-size:13px;min-width:110px;}
    .tabela-colagem td:focus{outline:none;background:rgba(106,75,201,0.10);}

    .hint{font-size:12px;opacity:.78;margin-top:10px}
  </style>
</head>

<body class="lock">

  <!-- LOGIN -->
  <div class="login" id="loginBox">
    <div class="login-card">
      <h2>ğŸ” Login</h2>
      <input id="usuario" placeholder="UsuÃ¡rio">
      <input id="senha" type="password" placeholder="Senha">
      <button onclick="entrar()">Entrar</button>

      <div class="login-links">
        <span onclick="showOnlyLogin('cadastro')">Criar conta</span> |
        <span onclick="showOnlyLogin('recuperar')">Recuperar senha</span> |
        <span onclick="toggleSenha()">ğŸ‘ Ver senha</span>
      </div>
    </div>
  </div>

  <!-- CADASTRO -->
  <div class="login hidden" id="cadastro">
    <div class="login-card">
      <h2>Criar conta</h2>
      <input id="cUser" placeholder="UsuÃ¡rio">
      <input id="cSenha" placeholder="Senha">
      <input id="cEmail" placeholder="Email">
      <button onclick="cadastrar()">Cadastrar</button>
      <button onclick="showOnlyLogin('loginBox')">Voltar</button>
    </div>
  </div>

  <!-- RECUPERAR -->
  <div class="login hidden" id="recuperar">
    <div class="login-card">
      <h2>Recuperar senha</h2>
      <input id="rUser" placeholder="UsuÃ¡rio">
      <button onclick="recuperarSenha()">Enviar email</button>
      <button onclick="showOnlyLogin('loginBox')">Voltar</button>
    </div>
  </div>

  <!-- SISTEMA -->
  <div class="sistema hidden" id="sistema">
    <div class="sidebar">
      <h3>Sistema</h3>

      <div class="menu" id="menuPrincipal">
        <div id="m_transferencia" onclick="abrir('transferencia')">ğŸ“¦ TransferÃªncia</div>
        <div id="m_zeramento" onclick="abrir('zeramento')">ğŸ” Zeramento</div>
        <div id="m_requisicao" onclick="abrir('requisicao')">ğŸ“ RequisiÃ§Ã£o</div>
      </div>

      <div class="menu inferior" id="menuInferior">
        <div onclick="openConfig()">âš™ï¸ ConfiguraÃ§Ãµes</div>
      </div>

      <div class="menu hidden" id="menuConfig">
        <div onclick="openConta()">ğŸ‘¤ Conta</div>
        <div id="btnAdminMenu" class="hidden" onclick="openAdmin()">ğŸ›¡ï¸ Admin</div>
        <div onclick="backMain()">â¬… Voltar</div>
      </div>

      <div class="menu hidden" id="menuConta">
        <div onclick="abrir('senhaBox')">ğŸ”‘ Alterar senha</div>
        <div onclick="abrir('tema')">ğŸŒ™ Tema</div>
        <div onclick="logout()">ğŸšª Sair</div>
        <div onclick="openConfig()">â¬… Voltar</div>
      </div>

      <div class="menu hidden" id="menuAdmin">
        <div onclick="abrir('adminEmail')">âœ‰ï¸ Alterar Email</div>
        <div onclick="abrir('adminPerms')">ğŸ§© PermissÃµes</div>
        <div onclick="openConfig()">â¬… Voltar</div>
      </div>
    </div>

    <div class="conteudo">
      <div class="box hidden" id="transferencia">
        <h2>ğŸ“¦ TransferÃªncia</h2>
        <div class="tabela-container"><table class="tabela-colagem"><tbody></tbody></table></div>
        <div class="row">
          <button onclick="importacaoTransferencia()">ImportaÃ§Ã£o</button>
          <button class="btn-danger" onclick="limparTabela('transferencia')">Limpar</button>
        </div>
      </div>

      <div class="box hidden" id="zeramento">
        <h2>ğŸ” Zeramento</h2>
        <div class="tabela-container"><table class="tabela-colagem"><tbody></tbody></table></div>
        <div class="row">
          <button onclick="importacaoZeramento()">ImportaÃ§Ã£o</button>
          <button class="btn-danger" onclick="limparTabela('zeramento')">Limpar</button>
        </div>
      </div>

      <div class="box hidden" id="requisicao">
        <h2>ğŸ“ RequisiÃ§Ã£o</h2>
        <div class="tabela-container"><table class="tabela-colagem"><tbody></tbody></table></div>
        <div class="row">
          <button onclick="importacaoRequisicao()">ImportaÃ§Ã£o</button>
          <button class="btn-danger" onclick="limparTabela('requisicao')">Limpar</button>
        </div>
        <div class="hint">Cole: Pedido | Cliente | CÃ³digoItem | Chave5 | Chave6 | Chave7 | Qtd</div>
      </div>

      <div class="box hidden" id="tema">
        <h2>ğŸŒ™ Tema</h2>
        <div class="row">
          <button onclick="setTema('light')">Claro</button>
          <button onclick="setTema('dark')">Escuro</button>
        </div>
      </div>

      <div class="box hidden" id="senhaBox">
        <h2>ğŸ”‘ Alterar senha</h2>
        <input id="novaSenha" placeholder="Nova senha">
        <input id="confirmaSenha" placeholder="Confirmar senha">
        <button onclick="alert('Backend de senha ainda nÃ£o implementado.')">Salvar</button>
      </div>

      <div class="box hidden" id="adminEmail">
        <h2>âœ‰ï¸ Alterar Email (Admin)</h2>
        <div class="row">
          <select id="admEmailUser"></select>
          <input id="admEmailNovo" placeholder="Novo email">
        </div>
        <div class="row">
          <button onclick="adminSalvarEmail()">Salvar Email</button>
          <button class="btn-danger" onclick="openConfig()">Voltar</button>
        </div>
      </div>

      <div class="box hidden" id="adminPerms">
        <h2>ğŸ§© PermissÃµes (Admin)</h2>
        <div id="adminPermsWrap"></div>
        <div class="row">
          <button onclick="adminRecarregar()">Recarregar</button>
          <button class="btn-danger" onclick="openConfig()">Voltar</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= COLE SUA URL /exec AQUI ========= */
const API_URL = "https://script.google.com/macros/s/AKfycbwRkUUhHHU3ymcRaEyhnLki-mXuqUnOV3a3-cFa2NVm4q74c0Wd-MGdqvdQHxfx2sokFg/exec";

/* ===== Debug: se der erro, aparece ===== */
window.addEventListener("error", (e) => {
  alert("Erro no JS: " + (e?.message || e));
});

/* ===== PWA SW ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}

function $(id){ return document.getElementById(id); }
function showOnlyLogin(id){
  ["loginBox","cadastro","recuperar"].forEach(x => $(x).classList.add("hidden"));
  $(id).classList.remove("hidden");
}
function toggleSenha(){
  const el = $("senha");
  el.type = el.type === "password" ? "text" : "password";
}

/* ===== API (CORS-safe) ===== */
async function api(action, ...args){
  const payload = JSON.stringify({ action, args });
  const r = await fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: payload
  });
  return await r.json();
}

/* ===== Estado ===== */
let NIVEL = "";
let USUARIO_LOGADO = "";
let PERMS = {transferencia:"EDITAR", zeramento:"EDITAR", requisicao:"EDITAR"};
const COLUNAS_FIXAS = 9;
const codCache = new Map();

/* ===== Menus ===== */
function hideAllSideMenus(){
  ["menuPrincipal","menuInferior","menuConfig","menuConta","menuAdmin"].forEach(id=>$(id).classList.add("hidden"));
}
function openConfig(){ hideAllSideMenus(); $("menuConfig").classList.remove("hidden"); }
function openConta(){ hideAllSideMenus(); $("menuConta").classList.remove("hidden"); }
function openAdmin(){ hideAllSideMenus(); $("menuAdmin").classList.remove("hidden"); }
function backMain(){ hideAllSideMenus(); $("menuPrincipal").classList.remove("hidden"); $("menuInferior").classList.remove("hidden"); }

function abrir(boxId){
  document.querySelectorAll(".box").forEach(b=>{ b.classList.remove("show"); b.classList.add("hidden"); });
  const box = $(boxId);
  box.classList.remove("hidden");
  setTimeout(()=>box.classList.add("show"),10);
}
function setTema(t){ document.documentElement.classList.toggle("dark", t==="dark"); }

/* ===== Tabelas ===== */
function criarTabela(boxId, linhas=10, colunas=9){
  const tbody = document.querySelector(`#${boxId} .tabela-colagem tbody`);
  tbody.innerHTML="";
  for(let i=0;i<linhas;i++){
    const tr=document.createElement("tr");
    for(let j=0;j<colunas;j++){
      const td=document.createElement("td");
      td.contentEditable="true";
      td.addEventListener("paste", handlePaste);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}
function limparTabela(boxId){ criarTabela(boxId, 10, COLUNAS_FIXAS); }
function handlePaste(e){
  e.preventDefault();
  const text=(e.clipboardData||window.clipboardData).getData("text");
  const rows=text.split(/\r?\n/).filter(r=>r!=="");
  const startCell=e.target, tr=startCell.parentElement, tbody=tr.parentElement;
  const rowIndex=Array.from(tbody.rows).indexOf(tr);
  const colIndex=Array.from(tr.cells).indexOf(startCell);

  rows.forEach((r,i)=>{
    const cols=r.split(/\t/);
    let targetRow=tbody.rows[rowIndex+i];
    if(!targetRow){
      targetRow=tbody.insertRow();
      for(let k=0;k<COLUNAS_FIXAS;k++){
        const td=targetRow.insertCell();
        td.contentEditable="true";
        td.addEventListener("paste", handlePaste);
      }
    }
    cols.forEach((c,j)=>{
      const td=targetRow.cells[colIndex+j];
      if(td) td.innerText=c;
    });
  });
}

/* ===== Utils ===== */
function dataHoje_ptBR(){ return new Date().toLocaleDateString("pt-BR"); }
function normalizeQTD(str){
  const s=(str||"0").toString().trim();
  let v=parseFloat(s.replace(/\./g,"").replace(",", "."));
  if(isNaN(v)) v=0;
  return v;
}
function baixarComoTXT(nome,texto){
  const blob=new Blob([texto],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=nome+".txt";
  a.click();
}

/* ===== PermissÃµes ===== */
function aplicarPermissoesUI(){
  $("m_transferencia").style.display = (PERMS.transferencia==="BLOQUEAR") ? "none" : "";
  $("m_zeramento").style.display = (PERMS.zeramento==="BLOQUEAR") ? "none" : "";
  $("m_requisicao").style.display = (PERMS.requisicao==="BLOQUEAR") ? "none" : "";
  $("btnAdminMenu").classList.toggle("hidden", NIVEL !== "ADMIN");
}

/* ===== Login/Cadastro/Recuperar ===== */
async function entrar(){
  if(API_URL.includes("COLE_AQUI")) return alert("Cole sua URL /exec em API_URL no index.html");

  const u=$("usuario").value;
  const s=$("senha").value;

  const res = await api("login", u, s);
  if(!res.ok) return alert("UsuÃ¡rio ou senha invÃ¡lidos");

  NIVEL=res.nivel;
  USUARIO_LOGADO=res.usuario;
  PERMS=res.perms || PERMS;

  document.body.classList.remove("lock");
  $("loginBox").classList.add("hidden");
  $("cadastro").classList.add("hidden");
  $("recuperar").classList.add("hidden");
  $("sistema").classList.remove("hidden");

  criarTabela("transferencia",10,COLUNAS_FIXAS);
  criarTabela("zeramento",10,COLUNAS_FIXAS);
  criarTabela("requisicao",10,COLUNAS_FIXAS);

  aplicarPermissoesUI();
  backMain();

  if(NIVEL==="ADMIN") await adminRecarregar();
}

async function cadastrar(){
  const res = await api("cadastrar", $("cUser").value, $("cSenha").value, $("cEmail").value);
  alert(res.ok ? "Conta criada!" : (res.msg || "Erro"));
  if(res.ok) showOnlyLogin("loginBox");
}

async function recuperarSenha(){
  const res = await api("recuperar", $("rUser").value);
  alert(res.ok ? "Email enviado!" : (res.msg || "Erro"));
}

function logout(){
  NIVEL=""; USUARIO_LOGADO=""; PERMS={transferencia:"EDITAR", zeramento:"EDITAR", requisicao:"EDITAR"};
  $("sistema").classList.add("hidden");
  $("loginBox").classList.remove("hidden");
  document.body.classList.add("lock");
  $("senha").value="";
  backMain();
}

/* ===== TransferÃªncia/Zeramento/RequisiÃ§Ã£o =====
   (mantÃ©m chamadas pro seu backend atual)
*/
async function mapearOuCadastrar(chave){
  const key=(chave||"").toString().trim();
  if(!key) return "";
  const norm=key.toLowerCase();
  if(codCache.has(norm)) return codCache.get(norm);

  const res=await api("cod_get", key);
  if(res.ok && res.found){ codCache.set(norm,res.value); return res.value; }

  const saida=prompt(`CHAVE nÃ£o cadastrada (COD A/B):\n"${key}"\nDigite o que deve sair no TXT:`);
  if(saida===null) throw new Error("Cadastro cancelado: "+key);
  const out=saida.toString().trim();
  if(!out) throw new Error("SaÃ­da vazia: "+key);

  const saved=await api("cod_set", key, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar COD");

  codCache.set(norm,out);
  return out;
}

async function getLocalPorItem(codigoItem){
  const code=(codigoItem||"").toString().trim();
  if(!code) return "";
  const res=await api("cod_get_local", code);
  if(res.ok && res.found) return res.value;

  const local=prompt(`LOCAL nÃ£o cadastrado para item "${code}" (COD D/E).\nDigite o LOCAL (ex: 164):`);
  if(local===null) throw new Error("Cadastro de local cancelado.");
  const out=local.toString().trim();
  if(!out) throw new Error("LOCAL vazio.");

  const saved=await api("cod_set_local", code, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar local.");
  return out;
}

async function getRequisitantePorUsuario(usuario){
  const u=(usuario||"").toString().trim().toLowerCase();
  if(!u) return "74";
  const res=await api("req_get", u);
  if(res.ok && res.found) return res.value;

  const req=prompt(`Requisitante nÃ£o cadastrado para "${u}".\nDigite o valor (ex: 74):`);
  if(req===null) throw new Error("Cadastro cancelado.");
  const out=req.toString().trim();
  if(!out) throw new Error("Requisitante vazio.");

  const saved=await api("req_set", u, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar requisitante.");
  return out;
}

async function importacaoTransferencia(){
  try{
    const rows=document.querySelectorAll("#transferencia .tabela-colagem tbody tr");
    const hoje=dataHoje_ptBR();
    const saida=[];
    for(const tr of rows){
      const c=[...tr.cells].map(td=>(td.innerText||"").trim());
      while(c.length<9) c.push("");
      const codigo=c[0];
      const chave5=c[2], chave6=c[3], chave7=c[4];
      const qtd1=normalizeQTD(c[5]||"0");
      const qtd2=normalizeQTD(c[6]||"0");
      const qtd3num=normalizeQTD(c[7]||"0");
      const qtd3txt=(c[7]||"0").toString().trim()||"0";
      const local=(c[8]||"164").toString().trim()||"164";
      if(!codigo && qtd1===0 && qtd2===0 && qtd3num===0 && !chave5 && !chave6 && !chave7) continue;

      const f5=await mapearOuCadastrar(chave5);
      const f6=await mapearOuCadastrar(chave6);
      const f7=await mapearOuCadastrar(chave7);

      let origem=local, destino="4044";
      if(qtd2>qtd1){ origem="4044"; destino=local; }

      const valor=(qtd3num*0.01).toFixed(2).replace(".",",");
      saida.push(["M1","T",hoje,codigo,f5,f6,f7,origem,destino,qtd3txt,"0,01",valor,"5949"].join("|"));
    }
    if(!saida.length) return alert("Nada para importar.");
    baixarComoTXT("importacao_transferencia", saida.join("\n"));
  }catch(err){ alert("Erro: "+err.message); }
}

async function importacaoZeramento(){
  try{
    const rows=document.querySelectorAll("#zeramento .tabela-colagem tbody tr");
    const hoje=dataHoje_ptBR();
    const saida=[];
    for(const tr of rows){
      const c=[...tr.cells].map(td=>(td.innerText||"").trim());
      while(c.length<9) c.push("");
      const codigo=c[0];
      const chave5=c[2], chave6=c[3], chave7=c[4];
      const qtd1=normalizeQTD(c[5]||"0");
      const qtd2=normalizeQTD(c[6]||"0");
      const qtd3num=normalizeQTD(c[7]||"0");
      const qtd3txt=(c[7]||"0").toString().trim()||"0";
      const local=(c[8]||"164").toString().trim()||"164";
      if(!codigo && qtd1===0 && qtd2===0 && qtd3num===0 && !chave5 && !chave6 && !chave7) continue;

      const f5=await mapearOuCadastrar(chave5);
      const f6=await mapearOuCadastrar(chave6);
      const f7=await mapearOuCadastrar(chave7);

      const tipo=(qtd2>qtd1)?"E":"S";
      const final=(qtd2>qtd1)?"1905":"5906";
      const valor=(qtd3num*0.01).toFixed(2).replace(".",",");

      saida.push(["M1",tipo,hoje,codigo,f5,f6,f7,local,qtd3txt,"0,01",valor,final].join("|"));
    }
    if(!saida.length) return alert("Nada para importar.");
    baixarComoTXT("importacao_zeramento", saida.join("\n"));
  }catch(err){ alert("Erro: "+err.message); }
}

async function importacaoRequisicao(){
  try{
    const rows=document.querySelectorAll("#requisicao .tabela-colagem tbody tr");
    const hoje=dataHoje_ptBR();
    const requisitante=await getRequisitantePorUsuario(USUARIO_LOGADO);

    const pedidos=new Map();
    for(const tr of rows){
      const raw=[...tr.cells].map(td=>(td.innerText||"").trim());
      if(raw.every(x=>!x)) continue;
      const pedido=(raw[0]||"").trim();
      const cliente=(raw[1]||"").trim();
      const codigo=(raw[2]||"").trim();
      const k5=(raw[3]||"").trim();
      const k6=(raw[4]||"").trim();
      const k7=(raw[5]||"").trim();
      const qtd=(raw[6]||"0").toString().trim()||"0";
      if(!pedido || !codigo) continue;

      if(!pedidos.has(pedido)) pedidos.set(pedido,{cliente,itens:[]});
      else if(!pedidos.get(pedido).cliente && cliente) pedidos.get(pedido).cliente=cliente;

      pedidos.get(pedido).itens.push({codigo,k5,k6,k7,qtd});
    }

    const out=[];
    for(const [pedido,obj] of pedidos.entries()){
      out.push(["R",hoje,"1","1",requisitante,"27",`${pedido}  -  ${obj.cliente||""}`,pedido,"0","0"].join("|"));
      for(const it of obj.itens){
        const local=await getLocalPorItem(it.codigo);
        out.push(["I","P",it.codigo,it.k5||"",it.k6||"",it.k7||"",it.qtd,"3",local].join("|"));
      }
    }

    if(!out.length) return alert("Nada para importar.");
    baixarComoTXT("importacao_requisicao", out.join("\n"));
  }catch(err){ alert("Erro: "+err.message); }
}

/* ===== Admin ===== */
async function adminRecarregar(){
  const res=await api("admin_listarUsuarios", USUARIO_LOGADO);
  if(!res.ok) return alert(res.msg||"Erro ao listar usuÃ¡rios");
  const sel=$("admEmailUser");
  sel.innerHTML="";
  res.usuarios.forEach(u=>{
    const op=document.createElement("option");
    op.value=u.usuario; op.textContent=u.usuario;
    sel.appendChild(op);
  });
  // se quiser, mantemos a tabela completa depois (jÃ¡ te mando quando pedir)
}

async function adminSalvarEmail(){
  const alvo=$("admEmailUser").value;
  const novo=$("admEmailNovo").value;
  const r=await api("admin_alterarEmail", USUARIO_LOGADO, alvo, novo);
  alert(r.ok ? "Email atualizado!" : (r.msg||"Erro"));
}

/* ===== Enter no login ===== */
$("usuario").addEventListener("keyup",(e)=>{ if(e.key==="Enter") entrar(); });
$("senha").addEventListener("keyup",(e)=>{ if(e.key==="Enter") entrar(); });
</script>

</body>
</html>
