<!DOCTYPE html>
<html lang="pt-BR">
<head>
 <link rel="manifest" href="/sistema-pwa/manifest.json">
<meta name="theme-color" content="#070a12">
<link rel="apple-touch-icon" href="/sistema-pwa/icons/icon-192.png">
<link rel="icon" href="/sistema-pwa/icons/icon-192.png">
<base target="_top">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sistema</title>

<style>
:root{
  /* Futurista / Dark (padr√£o) */
  --primary:#7c3aed;          /* roxo neon */
  --secondary:#a855f7;        /* roxo claro */
  --accent:#22d3ee;           /* ciano neon */
  --accent2:#34d399;          /* verde neon */
  --bg:#070a12;               /* fundo profundo */
  --card:#0d1220;             /* cart√µes */
  --card2:#0b1020;
  --text:#e7e9ee;
  --muted:#9aa4b2;
  --line:rgba(148,163,184,.16);
  --shadow: 0 18px 45px rgba(0,0,0,.55);
  --shadow2: 0 10px 26px rgba(0,0,0,.45);
  --ok:#22c55e;
  --warn:#f59e0b;
  --danger:#ef4444;
  --radius:18px;

  /* extras */
  --glow: 0 0 18px rgba(34,211,238,.22), 0 0 40px rgba(168,85,247,.18);
  --glass: rgba(255,255,255,.06);
  --glass2: rgba(255,255,255,.10);
}

/* Light (quando clicar no bot√£o de tema) */
.dark{
  --primary:#3b2a75;
  --secondary:#6a4bc9;
  --accent:#0ea5e9;
  --accent2:#10b981;
  --bg:#f5f7ff;
  --card:#ffffff;
  --card2:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --line:#e6e9f2;
  --shadow: 0 16px 40px rgba(16,24,40,.12);
  --shadow2: 0 8px 20px rgba(16,24,40,.10);
  --glass: rgba(17,24,39,.04);
  --glass2: rgba(17,24,39,.06);
}


.hidden{ display:none !important; }

html,body{ height:100%; overscroll-behavior:none; }
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  overflow:hidden;
  position:fixed;
  inset:0;
}

*{ box-sizing:border-box; font-family:Segoe UI,Inter,Arial,sans-serif; }

.view{ height:100%; width:100%; animation:fade .18s ease; }
@keyframes fade{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

.toast{
  position:fixed; right:16px; bottom:16px;
  background:var(--card);
  border:1px solid var(--line);
  box-shadow:var(--shadow2);
  padding:12px 14px;
  border-radius:14px;
  display:flex; gap:10px; align-items:flex-start;
  max-width:min(420px, calc(100vw - 32px));
  opacity:0; transform:translateY(10px);
  pointer-events:none;
  transition:all .18s ease;
  z-index:9999;
}
.toast.show{ opacity:1; transform:translateY(0); }
.toast .dot{ width:10px; height:10px; border-radius:999px; margin-top:4px; background:var(--secondary); }
.toast.ok .dot{ background:var(--ok); }
.toast.warn .dot{ background:var(--warn); }
.toast.danger .dot{ background:var(--danger); }
.toast .t-title{ font-weight:800; font-size:13px; }
.toast .t-msg{ font-size:12px; color:var(--muted); margin-top:2px; white-space:pre-wrap; }

.overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.25);
  backdrop-filter: blur(4px);
  display:flex; align-items:center; justify-content:center;
  z-index:9998;
  opacity:0; pointer-events:none;
  transition:opacity .18s ease;
}
.overlay.show{ opacity:1; pointer-events:auto; }
.loading-box{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px 16px;
  box-shadow:var(--shadow2);
  display:flex; align-items:center; gap:10px;
}
.spinner{
  width:18px; height:18px; border-radius:999px;
  border:2px solid rgba(106,75,201,.25);
  border-top-color: var(--secondary);
  animation:spin .8s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }
.loading-text{ font-size:12px; color:var(--muted); }

.auth{
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
}
.login-card{
  width:min(440px, 100%);
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:28px;
}
.brand{ display:flex; align-items:center; gap:12px; margin-bottom:14px; }
.logo{
  width:44px; height:44px; border-radius:16px;
  background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAqFBMVEUAAADvTCEAAAP0TSGdOh70USHuTSPzTyP2TB+FSTmiNBOqKw/0Tx3ySiPmTyj2TCOUNx4nDAYVBgUEAADWSCblTSxXGAt6KBgbCgjdSioAAAh1JRZ/KBcYAAgJBACcQieHUEGjNxyKSTAgCAA2BwCzMgvpUCNiKByUNSNmJRf4VzctFRJFGQtwJxh1KxpqKBhkHhC4OB1fGg4PAAaePBV5Jx2lQSs6HRl1QZu4AAAEMElEQVR4nO3cb1uTUBjHceC4w5qw2QZOnFlmmrM2bWa9/3cWrGxjk/HnnMN9H/x9H3RdPTE+3QjniMxxEEIIIYQQQgghhBBCCCGEOpHX1h80ffDaKP2Hzi89GubHoNdKfv8Tic9xrkZuK4Wjz0TCI9GO0O2/ewNCmu9DCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhPANCb27YfNkaIPw+n3jvtz0a5wAVMLJecZs9hujznH/lr+weRNncixqnKb2CdOOAwgh5B6EEPIPQh5ClX+1rpAitf9VG4QT5+tJ9e5O5k2FUtx/IxE6zlV/VDl/NGgq7MffvQn/HbD0B7nzuqpQSDeZFx4BM6HXQChlmCzIgK3M0E2BdPfCNoTRA+W9vgVhNLsk4zktCGU0G3sTMp9xoZTR9MyhBBoXRssx8YLbrFBGC6L7/CaDQumKaEkONDpDkczGZLD/GVzTiHhOepv4l6kZpl82Pj0nY21laIZSpkAyVC5DQj+IH5j8XMbMWSrFGkh6p3/J0AyTRzLRbmZmmAJZXGWyjAijxRMZaC8DwvVim0/6hX662CbjvJJmoWR2ijr6hekpSr1d2km3MFqeke7o99MpTP/GYjeRT6NQyF7yyGE3kU/nmiaM50zWottpnGEQE/5kuziNM7znOEF9QinuT1kCtZ2lAZMd/X66ZpgsWA7Q0TRD6UYzXrf5rfQIiR++HEyLMFqwnaAWYY/dYjuXujDb8BJ9vGyl1IW8dvT7qQpD+sdnJSkK/YTzRWadmlAkU/rHZyUprWn6MfsJKs1wcnO7ojvwyqnM8MeK6WI7l4JwPObx6KUklSsN5/v8JpWz1I5UZmhHEELIPwgh5B/uhzmh6PwMe4PyL8iuOkLRH9g3wnqfGjF8oD7cBtUQ+jyfD5ZVXSjilYXXmRrCYMjnl/FqVVUoE75Plw5XUehHU3a/RlKxikJ7gVWEcv3uEvWBNq7SDHk/PiupijB7fEZ9nM0rE2bv8FoNLJ9hmMysBpYKfRsevhysRBjEz9RHqNphYTC0crGd67BQMnl3SaViYZi9fWblbiJfoTB0e7buJvIVz7CXzDowwQNCP90udQFYLLR2P7hbkTCaXnZigoXCbD/Y5Rn60cU19YFp61Uh+WdZ6GxPKEW6m3jqyPdg1q4wlEFyYfGOfr9doRTD504Bd4TZWnTJ6wVJ5XJC4fbiTqxFt8sJ06vMis9r5prKn6Ud2PDutS3sxTPqwzHQtjCm/OA4Y22Egu/LWUpthIm9D18O9iL0kwveL4Y07kUYdRX4VxhKi58PlvV3hlG3Ftu51sL0e5DZRz1o7ChYX2Q6O8FU6I/iWXdPUSebYbxg8qFcRpqc/5TWPz4r6deU+gjM5jm/ne5eRRFCCCGEEEIIIYQQQgghhFD9/gCOe2uDL8Gy/gAAAABJRU5ErkJggg==') center/contain no-repeat;
  box-shadow:0 10px 24px rgba(0,0,0,.25);
}
.brand h2{ margin:0; font-size:18px; }
.brand p{ margin:2px 0 0 0; font-size:12px; color:var(--muted); }

label{ display:block; font-size:12px; color:var(--muted); margin-top:12px; }
input,select,button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--card);
  color:var(--text);
  outline:none;
}
input:focus,select:focus{
  border-color:rgba(106,75,201,.55);
  box-shadow:0 0 0 4px rgba(106,75,201,.12);
}
.btn{
  border:none;
  cursor:pointer;
  font-weight:800;
  transition:transform .12s ease, opacity .12s ease;
}
.btn:hover{ opacity:.92; transform:translateY(-1px); }
.btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
.btn-primary{ background:linear-gradient(135deg,var(--secondary),var(--primary)); color:#fff; }
.btn-ghost{ background:transparent; border:1px solid var(--line); color:var(--text); }
.btn-danger{ background:var(--danger); color:#fff; }

.login-links{
  text-align:center;
  margin-top:12px;
  font-size:12px;
  color:var(--muted);
}
.login-links span{
  cursor:pointer;
  color:var(--secondary);
  margin:0 8px;
  user-select:none;
}
.login-links span:hover{ opacity:.85; }

.small{ margin-top:10px; display:none; }
.small.show{ display:block; }
.errBox{
  border:1px solid var(--line);
  background:rgba(240,68,56,.06);
  padding:10px 12px;
  border-radius:14px;
  color:var(--danger);
  font-size:12px;
  line-height:1.35;
}
.errActions{
  display:flex;
  gap:10px;
  margin-top:8px;
  flex-wrap:wrap;
}
.errBtn{
  width:auto;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--card);
  color:var(--text);
  cursor:pointer;
  font-weight:800;
  font-size:12px;
}
.errDetails{
  margin-top:8px;
  padding:10px 12px;
  border-radius:14px;
  border:1px dashed var(--line);
  background:rgba(106,75,201,.06);
  color:var(--text);
  font-size:12px;
  white-space:pre-wrap;
  max-height:160px;
  overflow:auto;
  display:none;
}
.errDetails.show{ display:block; }

.app{ height:100%; display:flex; }
.sidebar{
  width:290px;
  background:linear-gradient(180deg, #24133f, #140b25);
  color:#fff;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.side-top{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px;
  background:rgba(255,255,255,.06);
  border-radius:16px;
}
.side-user{ display:flex; flex-direction:column; gap:2px; }
.side-user b{ font-size:13px; }
.side-user span{ font-size:12px; opacity:.8; }

.icon-btn{
  width:36px; height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;
  cursor:pointer;
  transition:transform .12s ease, opacity .12s ease;
}
.icon-btn:hover{ opacity:.92; transform:translateY(-1px); }

.nav{ display:flex; flex-direction:column; gap:8px; margin-top:6px; }
.nav .item{
  padding:12px;
  border-radius:16px;
  background:rgba(255,255,255,.08);
  cursor:pointer;
  user-select:none;
  transition:transform .12s ease, background .12s ease;
  display:flex; align-items:center; justify-content:space-between;
}
.nav .item:hover{ background:rgba(255,255,255,.14); transform:translateY(-1px); }
.nav .item.active{ background:rgba(255,255,255,.22); }
.nav .item small{ opacity:.8; font-size:12px; }

/* ‚úÖ item bloqueado (sem mudar layout) */
.nav .item.disabled{
  opacity:.55;
  pointer-events:none;
  filter:saturate(.8);
}

.side-bottom{ margin-top:auto; display:flex; flex-direction:column; gap:10px; }

.main{
  flex:1;
  height:100%;
  overflow:hidden;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.topbar{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow2);
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex:0 0 auto;
}
.topbar .title{ display:flex; flex-direction:column; gap:2px; }
.topbar .title b{ font-size:14px; }
.topbar .title span{ font-size:12px; color:var(--muted); }
.pill{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(106,75,201,.06);
  font-size:12px;
}

.card{
  flex:1 1 auto;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow2);
  padding:16px;
  display:flex;
  flex-direction:column;
  min-height:0;
}
.card h2{ font-size:16px; margin:0 0 10px 0; }
.subhint{ font-size:12px; color:var(--muted); margin-top:10px; }

.sheet-wrap{
  flex:1 1 auto;
  border:1px solid var(--line);
  border-radius:14px;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  min-height:0;
}
table.sheet{ width:100%; border-collapse:collapse; }
.sheet thead th{
  position:sticky;
  top:0;
  background:linear-gradient(180deg, rgba(106,75,201,.10), rgba(106,75,201,.06));
  border-bottom:1px solid var(--line);
  padding:10px;
  font-size:12px;
  text-align:left;
  z-index:2;
}
.sheet td{
  border-top:1px solid var(--line);
  border-right:1px solid var(--line);
  padding:8px;
  min-width:130px;
  font-size:13px;
  vertical-align:top;
}
.sheet td:last-child{ border-right:none; }
.sheet td:focus{
  outline:none;
  background:rgba(106,75,201,.10);
  box-shadow: inset 0 0 0 2px rgba(106,75,201,.22);
}

.actions{
  display:flex; gap:10px;
  margin-top:12px;
  flex-wrap:wrap;
}
.actions .btn{ width:auto; padding:12px 16px; border-radius:14px; }

  /* ‚úÖ submenu (Requisi√ß√µes) */
  .subitems{margin-left:10px; border-left:2px solid rgba(255,255,255,.08); padding-left:10px; margin-top:6px;}
  .subitem{padding:10px 12px; border-radius:12px; cursor:pointer; opacity:.95; user-select:none;}
  .subitem:hover{background:rgba(255,255,255,.06);}
  .subitem.active{background:rgba(255,255,255,.09);}
  .subitem.locked{opacity:.5; pointer-events:none;}


/* ‚úÖ Entrada x Sa√≠da - visibilidade maior (escopo pela section) */
#entradaSaida .sheet thead th{ font-size:14px; padding:14px 12px; }
#entradaSaida .sheet td{ font-size:18px; padding:14px 12px; min-width:160px; }
#entradaSaida .sheet td[contenteditable="true"]{ font-weight:800; }
#entradaSaida .sheet-wrap{ border-radius:16px; }
#entradaSaida .es-titlebar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
#entradaSaida .es-kebab{ width:36px; height:36px; border-radius:14px; border:1px solid var(--line); background:rgba(106,75,201,.06); color:var(--text); cursor:pointer; transition:transform .12s ease, opacity .12s ease; }
#entradaSaida .es-kebab:hover{ opacity:.92; transform:translateY(-1px); }
#entradaSaida .es-panel{
  position:absolute; top:52px; right:14px;
  width:min(360px, calc(100vw - 56px));
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:var(--shadow2);
  padding:12px;
  z-index:5;
}
#entradaSaida .es-panel.hidden{ display:none !important; }
#entradaSaida .es-panel h4{ margin:0 0 8px 0; font-size:13px; }
#entradaSaida .es-panel .row{ display:flex; gap:10px; align-items:center; }
#entradaSaida .es-panel input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--card);
  color:var(--text);
  outline:none;
}


/* ‚úÖ Polimento visual (mant√©m paleta) */
.sidebar{
  box-shadow: 0 18px 40px rgba(0,0,0,.35);
}
.side-top{
  border:1px solid rgba(255,255,255,.10);
}
.nav .item, .subitem{
  border:1px solid rgba(255,255,255,.08);
}
.nav .item{
  background:rgba(255,255,255,.07);
}
.nav .item.active{
  background:rgba(255,255,255,.18);
  border-color: rgba(255,255,255,.16);
  box-shadow: 0 10px 22px rgba(0,0,0,.22);
}
.nav .item::before{
  content:"";
  width:6px;
  height:100%;
  border-radius:999px;
  background:transparent;
  position:absolute;
  left:6px; top:0;
}
.nav .item{
  position:relative;
  padding-left:14px;
}
.nav .item.active::before{
  background: rgba(106,75,201,.95);
}
.nav .item small{
  opacity:.75;
}
.subitems{
  margin-left:14px;
  border-left:2px solid rgba(255,255,255,.10);
  padding-left:12px;
}
.subitem{
  background:rgba(255,255,255,.04);
  border-radius:14px;
  margin:6px 0;
}
.subitem.active{
  background:rgba(255,255,255,.10);
}
.topbar{
  backdrop-filter: blur(6px);
}
.card h2{
  letter-spacing:.2px;
}
.pill{
  font-weight:800;
}

/* ‚úÖ Destaque forte do item/pasta selecionada */
.nav .item.active{
  background: linear-gradient(135deg, rgba(106,75,201,.45), rgba(44,26,77,.65));
  border-color: rgba(106,75,201,.9);
  color:#fff;
}

.nav .item.active span{
  font-weight:900;
}

.nav .item.active::before{
  background: var(--secondary);
  box-shadow: 0 0 0 2px rgba(106,75,201,.35);
}

/* subitem selecionado */
.subitem.active{
  background: linear-gradient(135deg, rgba(106,75,201,.35), rgba(44,26,77,.55));
  border:1px solid rgba(106,75,201,.6);
  color:#fff;
  font-weight:800;
}

/* quando pasta est√° aberta (estoque / produ√ß√£o) */
.item.open{
  background: rgba(106,75,201,.25);
  border-color: rgba(106,75,201,.55);
}

/* Modal de Erros (para telas travadas/sem scroll) */
.prod-modal-overlay{
  position:fixed; inset:0; background:rgba(15,23,42,.55);
  display:flex; align-items:center; justify-content:center;
  z-index:9999;
}
.prod-modal{
  width:min(900px, calc(100vw - 24px));
  max-height: min(78vh, 640px);
  overflow:auto;
  background:var(--card, #fff);
  border-radius:14px;
  box-shadow:0 20px 55px rgba(0,0,0,.35);
  padding:14px;
}
.prod-modal-header{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.prod-modal-title{ font-size:14px; font-weight:900; }
.prod-modal-close{
  border:none; background:transparent; cursor:pointer;
  font-size:18px; line-height:1;
  padding:6px 10px; border-radius:10px;
}
.prod-modal-close:hover{ background:rgba(0,0,0,.06); }


/* =========================
   Futurista / Profissional
   ========================= */

/* Fundo com grade sutil + glow */
body{
  background:
    radial-gradient(900px 520px at 16% 10%, rgba(168,85,247,.18), transparent 55%),
    radial-gradient(780px 520px at 86% 18%, rgba(34,211,238,.14), transparent 55%),
    radial-gradient(680px 520px at 50% 92%, rgba(52,211,153,.10), transparent 60%),
    var(--bg);
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    linear-gradient(to bottom, rgba(255,255,255,.035), transparent 24%),
    repeating-linear-gradient(90deg, rgba(255,255,255,.028) 0 1px, transparent 1px 36px),
    repeating-linear-gradient(0deg, rgba(255,255,255,.020) 0 1px, transparent 1px 36px);
  opacity:.22;
  mix-blend-mode: overlay;
}

/* Scrollbar discreta */
*::-webkit-scrollbar{ height:10px; width:10px; }
*::-webkit-scrollbar-thumb{
  background: rgba(148,163,184,.22);
  border:2px solid transparent;
  background-clip: padding-box;
  border-radius:999px;
}
*::-webkit-scrollbar-thumb:hover{ background: rgba(148,163,184,.32); border:2px solid transparent; background-clip:padding-box; }

/* Cart√µes com ‚Äúglass‚Äù */
.topbar,.card,.login-card,.loading-box,.toast{
  background: linear-gradient(180deg, var(--glass2), transparent 120%), var(--card);
  border-color: var(--line);
  box-shadow: var(--shadow2);
}

/* Inputs mais ‚Äúclean‚Äù */
input,select,textarea,button{
  border-color: var(--line);
}
input,select,textarea{
  background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 90%), var(--card);
}
input:focus,select:focus,textarea:focus{
  border-color: rgba(34,211,238,.55);
  box-shadow: 0 0 0 4px rgba(34,211,238,.12), var(--glow);
}

/* Bot√µes com neon sutil */
.btn-primary{
  background:
    linear-gradient(135deg, rgba(34,211,238,.92), rgba(168,85,247,.92));
  box-shadow: 0 10px 22px rgba(0,0,0,.22), var(--glow);
}
.btn-ghost{
  background: rgba(255,255,255,.02);
}
.btn:hover{ filter:saturate(1.05); }

/* Sidebar mais futurista */
.sidebar{
  background:
    radial-gradient(700px 420px at 20% 10%, rgba(34,211,238,.18), transparent 55%),
    radial-gradient(740px 520px at 70% 25%, rgba(168,85,247,.20), transparent 60%),
    linear-gradient(180deg, rgba(13,18,32,.88), rgba(7,10,18,.96));
  border-right: 1px solid rgba(148,163,184,.14);
  box-shadow: 0 22px 60px rgba(0,0,0,.55);
}
.side-top{
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(148,163,184,.14);
  backdrop-filter: blur(10px);
}
.icon-btn{
  background: rgba(255,255,255,.06);
  border-color: rgba(148,163,184,.18);
}
.icon-btn:hover{ box-shadow: var(--glow); }

/* Menu: item ativo com glow */
.nav .item, .subitem{
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(148,163,184,.14);
  backdrop-filter: blur(10px);
}
.nav .item.active{
  background:
    linear-gradient(135deg, rgba(34,211,238,.18), rgba(168,85,247,.22));
  border-color: rgba(34,211,238,.35);
  box-shadow: 0 14px 28px rgba(0,0,0,.25), var(--glow);
}
.nav .item.active::before{
  background: linear-gradient(180deg, var(--accent), var(--secondary));
  box-shadow: 0 0 0 2px rgba(34,211,238,.20), var(--glow);
}
.subitem.active{
  background: linear-gradient(135deg, rgba(34,211,238,.14), rgba(168,85,247,.18));
  border-color: rgba(34,211,238,.28);
  box-shadow: 0 10px 22px rgba(0,0,0,.20);
}

/* Tabelas com destaque ao passar o mouse */
.sheet tbody tr:hover td{
  background: rgba(34,211,238,.06);
}
.sheet thead th{
  background:
    linear-gradient(180deg, rgba(34,211,238,.14), rgba(168,85,247,.08));
}

/* Pills */
.pill{
  background: rgba(34,211,238,.08);
  border-color: rgba(34,211,238,.22);
}

/* Toast refinado */
.toast{
  backdrop-filter: blur(12px);
}
.toast .dot{ box-shadow: 0 0 0 4px rgba(34,211,238,.12); }

/* Overlay */
.overlay{
  background: rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
}


/* ===== v12 layout polish (dark / futuristic) ===== */
*{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
::selection{ background: rgba(34,211,238,.22); }

:root{
  --radius-sm: 14px;
  --radius-lg: 22px;
  --ring: 0 0 0 4px rgba(34,211,238,.14);
  --ring2: 0 0 0 4px rgba(168,85,247,.14);
}

/* Scrollbars */
*::-webkit-scrollbar{ width:10px; height:10px; }
*::-webkit-scrollbar-track{ background: rgba(255,255,255,.04); border-radius: 999px; }
*::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.14); border-radius: 999px; border:2px solid rgba(0,0,0,0); background-clip: padding-box; }
*::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.22); border:2px solid rgba(0,0,0,0); background-clip: padding-box; }

/* Sidebar: glass + cleaner */
.sidebar{
  width:300px;
  background: linear-gradient(180deg, rgba(13,18,32,.92), rgba(7,10,18,.86));
  border-right: 1px solid rgba(148,163,184,.18);
  box-shadow: 0 18px 55px rgba(0,0,0,.55);
  backdrop-filter: blur(10px);
}
.side-top{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  border-radius: var(--radius-lg);
}
.icon-btn{
  border-radius: 16px;
}
.icon-btn:focus{ box-shadow: var(--ring); }

/* Nav items: better active */
.nav .item{
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.045);
  border-radius: var(--radius-lg);
  position: relative;
  overflow:hidden;
}
.nav .item::after{
  content:"";
  position:absolute; inset:-1px;
  background: radial-gradient(120px 70px at 22% 10%, rgba(34,211,238,.18), transparent 60%),
              radial-gradient(140px 90px at 82% 50%, rgba(168,85,247,.14), transparent 65%);
  opacity:.0;
  transition: opacity .18s ease;
  pointer-events:none;
}
.nav .item:hover::after{ opacity:1; }
.nav .item.active{
  border-color: rgba(34,211,238,.35);
  background: linear-gradient(135deg, rgba(34,211,238,.12), rgba(168,85,247,.10));
  box-shadow: 0 0 0 1px rgba(34,211,238,.18), 0 10px 26px rgba(0,0,0,.35);
}
.nav .item.active::before{
  content:"";
  position:absolute; left:10px; top:50%;
  width:7px; height:18px; transform:translateY(-50%);
  border-radius:999px;
  background: linear-gradient(180deg, var(--accent), var(--secondary));
  box-shadow: 0 0 12px rgba(34,211,238,.28);
}

/* Topbar: subtle gradient border */
.topbar{
  border-radius: var(--radius-lg);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border: 1px solid rgba(148,163,184,.18);
}
.topbar::before{
  content:"";
  position:absolute;
  pointer-events:none;
}
.topbar{ position:relative; }

/* Inputs: cleaner & hover */
input, select{
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(148,163,184,.18);
  border-radius: var(--radius-sm);
}
input:hover, select:hover{ border-color: rgba(34,211,238,.26); }
input:focus, select:focus{
  border-color: rgba(34,211,238,.42);
  box-shadow: var(--ring);
}

/* Buttons: glow + press */
.btn{
  border-radius: var(--radius-sm);
  letter-spacing: .2px;
}
.btn-primary{
  box-shadow: 0 10px 24px rgba(0,0,0,.45), 0 0 26px rgba(34,211,238,.10);
}
.btn-primary:focus{ box-shadow: 0 10px 24px rgba(0,0,0,.45), var(--ring2); }
.btn:active{ transform: translateY(0px) scale(.99); }

/* Sheets: zebra + hover */
table.sheet tbody tr:nth-child(odd) td{ background: rgba(255,255,255,.012); }
table.sheet tbody tr:hover td{ background: rgba(34,211,238,.06); }

/* Modals: blur and dark close hover */
.prod-modal-overlay{
  background: rgba(2,6,23,.62);
  backdrop-filter: blur(8px);
}
.prod-modal{
  border:1px solid rgba(148,163,184,.18);
  border-radius: var(--radius-lg);
  background: linear-gradient(180deg, rgba(13,18,32,.92), rgba(7,10,18,.88));
}
.prod-modal-close:hover{ background: rgba(255,255,255,.06); }
/* ===== end v12 ===== */

</style>
</head>

<body>

<div id="toast" class="toast">
  <div class="dot"></div>
  <div>
    <div class="t-title" id="toastTitle">Aviso</div>
    <div class="t-msg" id="toastMsg"></div>
  </div>
</div>

<div id="overlay" class="overlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <div class="loading-text" id="overlayText">Processando...</div>
  </div>
</div>

<div id="view_login" class="view auth">
  <div class="login-card">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h2>Sistema</h2>
        <p>Login e importa√ß√£o de arquivos</p>
      </div>
    </div>

    <label>Usu√°rio</label>
    <input id="usuario" placeholder="Digite seu usu√°rio" autocomplete="username">

    <label>Senha</label>
    <input id="senha" type="password" placeholder="Digite sua senha" autocomplete="current-password">

    <button id="btnEntrar" class="btn btn-primary" onclick="entrar()">Entrar</button>

    <div class="login-links">
      <span onclick="trocarView('cadastro')">Criar conta</span> |
      <span onclick="trocarView('recuperar')">Recuperar senha</span> |
      <span onclick="toggleSenha()">üëÅ Ver senha</span>
    </div>

    <div class="small" id="statusLogin">
      <div class="errBox" id="errMsg">‚Äî</div>
      <div class="errActions">
        <button class="errBtn" onclick="toggleErrDetails()">Ver detalhes</button>
        <button class="errBtn" onclick="limparErro()">Fechar</button>
      </div>
      <div class="errDetails" id="errDetails">‚Äî</div>
    </div>
  </div>
</div>

<div id="view_cadastro" class="view auth hidden">
  <div class="login-card">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h2>Criar conta</h2>
        <p>Cadastro r√°pido</p>
      </div>
    </div>

    <label>Usu√°rio</label>
    <input id="cUser" placeholder="Usu√°rio">

    <label>Senha</label>
    <input id="cSenha" type="password" placeholder="Senha">

    <label>Email</label>
    <input id="cEmail" placeholder="Email">

    <div class="actions">
      <button class="btn btn-primary" onclick="cadastrar()">Cadastrar</button>
      <button class="btn btn-ghost" onclick="trocarView('login')">Voltar</button>
    </div>
  </div>
</div>

<div id="view_recuperar" class="view auth hidden">
  <div class="login-card">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h2>Recuperar senha</h2>
        <p>Envia por email</p>
      </div>
    </div>

    <label>Usu√°rio</label>
    <input id="rUser" placeholder="Usu√°rio">

    <div class="actions">
      <button class="btn btn-primary" onclick="recuperarSenha()">Enviar</button>
      <button class="btn btn-ghost" onclick="trocarView('login')">Voltar</button>
    </div>
  </div>
</div>

<div id="view_app" class="view hidden">
  <div class="app">
    <aside class="sidebar">
      <div class="side-top">
        <div class="side-user">
          <b id="sideUser">-</b>
          <span id="sideNivel">-</span>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="icon-btn" title="Tema" onclick="toggleTema()">üåô</button>
          <button class="icon-btn" title="Config" onclick="abrirConfig()">‚öôÔ∏è</button>
        </div>
      </div>

      <div class="nav" id="menuPrincipal">
        <!-- 1) Estoque -->
        <div id="m_estoque" class="item" onclick="toggleSubmenu('sub_estoque')">
          <span>üì¶ Estoque</span><small>Abrir</small>
        </div>

        <div id="sub_estoque" class="subitems hidden">
          <div id="m_requisicao" class="subitem" onclick="toggleSubmenu('sub_requisicao')">üìù Requisi√ß√µes</div>
          <div id="sub_requisicao" class="subitems hidden">
            <div id="m_requisicao_pedidos" class="subitem" onclick="abrir('requisicao')">üìÑ Pedidos</div>
            <div id="m_requisicao_manual" class="subitem" onclick="abrir('requisicaoManual')">‚úçÔ∏è Manual</div>
          </div>

          <div id="m_aba164" class="subitem" onclick="abrir('aba164')">üìå 164</div>
          <div id="m_entradaSaida" class="subitem" onclick="abrir('entradaSaida')">‚öñÔ∏è Entrada x Sa√≠da</div>
        </div>

        <!-- 2) Produ√ß√£o -->
        <div id="m_producao_group" class="item" onclick="toggleSubmenu('sub_producao')">
          <span>üè≠ Produ√ß√£o</span><small>Abrir</small>
        </div>

        <div id="sub_producao" class="subitems hidden">
          <div id="m_producao" class="subitem" onclick="abrir('producao')">‚öñÔ∏è Entrada x Sa√≠da</div>
</div>

        <!-- 3) Transfer√™ncia -->
        <div id="m_transferencia" class="item" onclick="abrir('transferencia')">
          <span>üì¶ Transfer√™ncia</span><small>Editar</small>
        </div>

        <!-- 4) Zeramento -->
        <div id="m_zeramento" class="item" onclick="abrir('zeramento')">
          <span>üîÅ Zeramento</span><small>Editar</small>
        </div>
</div>

      <div class="nav hidden" id="menuConfig">
        <div class="item" onclick="abrir('cfgTransfer')">
          <span>üîÅ Transfer√™ncia (Locais)</span><small>Config</small>
        </div>

        <div class="item" onclick="abrir('cfgSenha')">
          <span>üîë Mudar senha</span><small>Conta</small>
        </div>

        <div id="btnAdminMenu" class="item hidden" onclick="abrir('adminPerms')">
          <span>üõ°Ô∏è Admin</span><small>Controle</small>
        </div>
        <div class="item" onclick="voltarMenu()">
          <span>‚¨Ö Voltar</span><small>Menu</small>
        </div>
      </div>

      <div class="side-bottom">
        <!-- ‚úÖ Sair + vers√£o ao lado (v2.1) -->
        <div style="display:flex; align-items:center; gap:10px;">
          <button class="btn btn-ghost" onclick="sair()">üö™ Sair</button>
          <span id="appVersion" style="opacity:.85; font-size:12px;">v2.1</span>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <b id="topTitle">Transfer√™ncia</b>
          <span id="topSubtitle">Cole seus dados e clique em Importa√ß√£o</span>
        </div>
        <div class="pill" id="pillUser">‚Äî</div>
      </div>

      <section class="card hidden" id="transferencia">
        <h2>üì¶ Transfer√™ncia</h2>

        <div class="sheet-wrap">
          <table class="sheet">
            <thead>
              <tr>
                <th>C√≥digo</th><th>Descri√ß√£o</th><th>Chave5</th><th>Chave6</th><th>Chave7</th>
                <th>QTD1</th><th>QTD2</th><th>QTD3</th><th>Local</th><th>Destino</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="actions">
          <button class="btn btn-primary" onclick="importacaoTransferencia()">Importa√ß√£o</button>
          <button class="btn btn-ghost" onclick="limparTabela('transferencia')">Limpar</button>
        </div>

        <div class="subhint">‚úÖ Cole e importe.</div>
      </section>

      <section class="card hidden" id="zeramento">
        <h2>üîÅ Zeramento</h2>

        <div class="sheet-wrap">
          <table class="sheet">
            <thead>
              <tr>
                <th>C√≥digo</th><th>Descri√ß√£o</th><th>Chave5</th><th>Chave6</th><th>Chave7</th>
                <th>QTD1</th><th>QTD2</th><th>QTD3</th><th>Local</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="actions">
          <button class="btn btn-primary" onclick="importacaoZeramento()">Importa√ß√£o</button>
          <button class="btn btn-ghost" onclick="limparTabela('zeramento')">Limpar</button>
        </div>

        <div class="subhint">‚úÖ Cole e importe.</div>
      </section>

      <section class="card hidden" id="requisicao">
        <h2>üìù Requisi√ß√£o</h2>

        <div class="sheet-wrap">
          <table class="sheet">
            <thead>
              <tr>
                <th>Pedido</th><th>Cliente</th><th>C√≥digo Item</th><th>Chave5</th><th>Chave6</th><th>Chave7</th>
                <th>Qtd</th><th>(vazio)</th><th>(vazio)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="actions">
          <button class="btn btn-primary" onclick="importacaoRequisicao()">Importa√ß√£o</button>
          <button class="btn btn-ghost" onclick="limparTabela('requisicao')">Limpar</button>
        </div>

        <div class="subhint">‚úÖ Cole v√°rios pedidos que o sistema separa pelo n√∫mero do pedido e importe.</div>
      </section>

      <section class="card hidden" id="requisicaoManual">
        <h2>‚úçÔ∏è Requisi√ß√£o Manual</h2>
        <div class="subhint">Cole ou digite a requisi√ß√£o manual.</div>

        <div class="grid2" style="margin-top:10px;">
          <input id="reqManualPedido" class="in" placeholder="Pedido (opcional)" />
          <input id="reqManualCliente" class="in" placeholder="Cliente (opcional)" />
        </div>

        <div style="margin-top:10px;">
          <textarea id="reqManualTexto" class="in" rows="8" placeholder="Escreva aqui..." style="width:100%; min-height:180px; resize:vertical;"></textarea>
        </div>

        <div class="actions" style="margin-top:10px;">
          <button class="btn btn-primary" onclick="importacaoRequisicaoManual()">Gerar RI </button>
          <button class="btn btn-ghost" onclick="limparReqManual()">Limpar</button>
        </div>
      </section>

      
      
      <section class="card hidden" id="aba164" style="overflow:hidden;">
        <h2>üìå 164 </h2>

        <div class="subhint">
          Cole as 2 planilhas abaixo . O sistema soma itens iguais Se n√£o sobrar nada, o 164 est√° certo.
        </div>

        <div id="wrap164Inputs" style="display:block;">
          <h3 style="margin:14px 0 8px 0; font-size:14px;">Planilha A</h3>
          <div class="sheet-wrap" style="flex:0 0 auto; max-height:150px;">
            <table class="sheet" id="tbl164A">
              <thead>
                <tr>
                  <th>C√≥digo Local</th><th>C√≥digo Produto</th><th>Nome do Produto</th><th>Grade 1</th><th>Grade 2</th><th>Grade 3</th><th>Qtde Estoque</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <h3 style="margin:14px 0 8px 0; font-size:14px;">Planilha B</h3>
          <div class="sheet-wrap" style="flex:0 0 auto; max-height:150px;">
            <table class="sheet" id="tbl164B">
              <thead>
                <tr>
                  <th>C√≥digo Produto</th><th>Nome do Produto</th><th>Grade 1</th><th>Grade 2</th><th>Grade 3</th><th>Un. Med.</th><th>Quant. Liberada</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" onclick="comparar164()">Comparar</button>
          <button class="btn btn-ghost" onclick="limpar164()">Limpar</button>
          <button class="btn btn-ghost" onclick="toggleInputs164()">Mostrar mais</button>
</div>

        <div id="sobras164" style="flex:1 1 auto; min-height:0; display:flex; flex-direction:column;">
          <div class="subhint" id="res164Hint">‚Äî</div>

          <h3 style="margin:10px 0 8px 0; font-size:14px;">Divergencia</h3>
          <div class="sheet-wrap" style="flex:1 1 auto; min-height:180px;">
            <table class="sheet" id="tbl164Res">
              <thead>
                <tr><th>Item</th><th>Quantidade</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>





      
      

<section class="card hidden" id="producao" style="overflow:hidden;">
  <h2>‚öñÔ∏è Entrada x Sa√≠da (Produ√ß√£o)</h2>

  <div class="subhint" style="margin-top:10px;">
    Cole as <b>2 planilhas</b> abaixo (mesmo layout do 164).<br>
    <b>A) Entrada</b> = itens que entraram no setor (componentes)<br>
    <b>B) Sa√≠da</b> = itens que sa√≠ram do setor (produto final)<br>
    Nesta confer√™ncia, o sistema faz a regra <b>3 por 1</b>: para cada <b>1</b> sa√≠da, espera <b>3</b> na entrada do <b>mesmo nome + grades</b>.
  </div>

  <div id="wrapProdInputs" style="display:block;">
    <h3 style="margin:14px 0 8px 0; font-size:14px;">Planilha A ‚Äî Entrada</h3>
    <div class="sheet-wrap" id="prodWrapA" style="flex:0 0 auto; max-height:150px;">
      <table class="sheet" id="tblProdA">
        <thead>
          <tr>
            <th>C√≥digo Local</th><th>C√≥digo Produto</th><th>Nome</th><th>Grade 1</th><th>Grade 2</th><th>Grade 3</th><th>Quantidade</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 style="margin:14px 0 8px 0; font-size:14px;">Planilha B ‚Äî Sa√≠da</h3>
    <div class="sheet-wrap" id="prodWrapB" style="flex:0 0 auto; max-height:150px;">
      <table class="sheet" id="tblProdB">
        <thead>
          <tr>
            <th>C√≥digo Local</th><th>C√≥digo Produto</th><th>Nome</th><th>Grade 1</th><th>Grade 2</th><th>Grade 3</th><th>Quantidade</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="actions" style="margin-top:14px;">
    <button class="btn btn-primary" onclick="prodConferir3por1()">Conferir</button>
    <button class="btn btn-ghost" onclick="prodLimpar()">Limpar</button>
    <button class="btn btn-ghost" onclick="prodToggleMore()">Mostrar mais</button>
  </div>

  <div id="prod_status" class="subhint" style="margin-top:10px;">‚Äî</div>

  
  <div id="prod_errorBox" class="sheet-wrap" style="display:none; margin-top:10px; padding:10px; border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.08); border-radius:12px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight:700; color:#b91c1c;">Erro (detalhes)</div>
      <button class="btn btn-ghost" style="padding:6px 10px;" onclick="document.getElementById('prod_errorBox').style.display='none';">Fechar</button>
    </div>
    <pre id="prod_errorText" style="white-space:pre-wrap; margin:10px 0 0 0; font-size:12px; color:#7f1d1d;"></pre>
  </div>
<h3 style="margin:12px 0 8px 0; font-size:14px;">Resultado</h3>
  <div class="sheet-wrap" style="overflow:hidden;">
    <table class="sheet" style="width:100%;">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Grade 1</th>
          <th>Grade 2</th>
          <th>Grade 3</th>
          <th>Entrada</th>
          <th>Esperado (Sa√≠da √ó 3)</th>
          <th>Diferen√ßa</th>
        </tr>
      </thead>
      <tbody id="prod_tbody"></tbody>
    </table>
  </div>

  
  <h3 style="margin:12px 0 8px 0; font-size:14px;">Erros</h3>
  <div class="subhint" style="margin-top:0;">Mostra itens que n√£o batem, ou que aparecem s√≥ em uma das planilhas.</div>

  <div class="actions" style="margin-top:10px;">
    <button class="btn btn-primary" onclick="prodAbrirErros()" style="display:flex;align-items:center;gap:8px;">
      Ver erros <span id="prod_err_badge" style="display:inline-block;min-width:22px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.18);font-weight:900;">0</span>
    </button>
  </div>


  <div class="subhint" style="margin-top:10px;">
    ‚úÖ Dica: Diferen√ßa <b>0</b> = bateu. Diferen√ßa <b>positiva</b> = entrou mais que o esperado. Diferen√ßa <b>negativa</b> = faltou entrada.
  </div>
</section>






<section class="card hidden" id="entradaSaida" style="overflow:hidden;">
        <h2>‚öñÔ∏è Entrada x Sa√≠da</h2>
        <div class="es-titlebar" style="margin-top:10px; position:relative;">
          <div class="subhint" style="margin:0;">
            Resumo no estilo ‚ÄúEntrada x Sa√≠da‚Äù, adaptado ao layout do app (mesma paleta e componentes).
          </div>

          <button class="es-kebab" title="Configurar saldo inicial" onclick="toggleESPanel(event)">‚ãÆ</button>

          <div id="es_panel" class="es-panel hidden">
            <h4>Saldo inicial do m√™s <span id="es_mes_ref" style="color:var(--muted); font-weight:700;"></span></h4>
            <div class="row">
              <input id="es_saldo_mes" placeholder="Ex: 24.453" inputmode="decimal" />
            </div>
            <div class="actions" style="margin-top:10px;">
              <button class="btn btn-primary" style="width:auto;" onclick="aplicarSaldoInicialMes()">Aplicar e salvar</button>
              <button class="btn btn-ghost" style="width:auto;" onclick="toggleESPanel(event, true)">Fechar</button>
            </div>
            <div class="subhint" style="margin-top:8px;">
              ‚úÖ Troque este valor no in√≠cio de cada m√™s. Fica salvo para todos.
            </div>
          </div>
        </div>


        <div style="display:grid; grid-template-columns: 1.15fr 0.95fr; gap:18px; margin-top:14px; align-items:start;">
          <!-- Bloco Esquerdo -->
          <div class="sheet-wrap" style="overflow:hidden;">
            <table class="sheet" style="width:100%;">
              <thead>
                <tr>
                  <th colspan="2" style="text-align:center;">Entrada x Sa√≠da</th>
                </tr>
              </thead>
              <tbody>
                <tr><td style="font-weight:800;">Saldo inicial</td><td contenteditable="true" oninput="recalcularEntradaSaida()">0</td></tr>
                <tr><td style="font-weight:800;">Entrada</td><td contenteditable="true" oninput="recalcularEntradaSaida()">0</td></tr>
                <tr><td style="font-weight:800;">Sa√≠da</td><td contenteditable="true" oninput="recalcularEntradaSaida()">0</td></tr>
                <tr><td style="font-weight:800;">Ajuste</td><td contenteditable="true" oninput="recalcularEntradaSaida()">0</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Bloco Direito -->
          <div class="sheet-wrap" style="overflow:hidden;">
            <table class="sheet" style="width:100%;">
              <thead>
                <tr>
                  <th colspan="2" style="text-align:center;">Resultado</th>
                </tr>
              </thead>
              <tbody>
                <tr><td style="font-weight:800;">Total</td><td id="es_total">0</td></tr>
                <tr><td style="font-weight:800;">Real</td><td contenteditable="true" id="es_real" oninput="recalcularEntradaSaida()">0</td></tr>
                <tr>
                  <td style="font-weight:800;">Diferen√ßa</td>
                  <td id="es_diff" style="font-weight:900;"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="recalcularEntradaSaida()">Recalcular</button>
          <button class="btn btn-ghost" onclick="limparEntradaSaida()">Limpar</button>
        </div>

        <div class="subhint">
          ‚úÖ Voc√™ pode digitar valores direto nas c√©lulas. ‚ÄúTotal‚Äù = Saldo inicial + Entrada + Sa√≠da + Ajuste. ‚ÄúDiferen√ßa‚Äù = Real ‚àí Total.
        </div>
      </section>

<section class="card hidden" id="cfgTransfer">
        <h2>üîÅ Transfer√™ncia (Locais)</h2>
        <label>Outro Local (ex: 4044)</label>
        <input id="cfgLocalOutro" placeholder="4044">
        <div class="actions">
          <button class="btn btn-primary" onclick="salvarCfgTransfer()">Salvar</button>
          <button class="btn btn-ghost" onclick="voltarMenu()">Voltar</button>
        </div>
        <div class="subhint">Se ‚ÄúDestino‚Äù estiver vazio, usa o Local aqui determinado.</div>
      </section>

      <section class="card hidden" id="cfgSenha">
        <h2>üîë Mudar senha</h2>

        <label>Senha atual</label>
        <input id="senhaAtual" type="password" placeholder="Senha atual">

        <label>Nova senha</label>
        <input id="senhaNova" type="password" placeholder="Nova senha">

        <label>Confirmar nova senha</label>
        <input id="senhaNova2" type="password" placeholder="Confirmar nova senha">

        <div class="actions">
          <button class="btn btn-primary" onclick="salvarSenha()">Salvar</button>
          <button class="btn btn-ghost" onclick="voltarMenu()">Voltar</button>
        </div>

        <div class="subhint">Use uma senha que voc√™ n√£o compartilha.</div>
      </section>

      <section class="card hidden" id="adminPerms">
        <h2>üõ°Ô∏è Admin</h2>

        <h3 style="margin:10px 0 0 0; font-size:14px;">‚úâÔ∏è Alterar Email</h3>
        <div class="actions" style="gap:10px">
          <select id="admEmailUser" style="min-width:220px"></select>
          <input id="admEmailNovo" placeholder="Novo email">
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="adminSalvarEmail()">Salvar Email</button>
          <button class="btn btn-ghost" onclick="adminRecarregar()">Recarregar</button>
        </div>

        <h3 style="margin:16px 0 0 0; font-size:14px;">üß© Permiss√µes</h3>
        <div id="adminPermsWrap"></div>
      </section>

    </main>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbztsAvRCZV_5Nx5bbcOagmMdu27Bs4hbZO12upvwdOTvYuJIDKIt7Xpb0IuShVIHIYV7A/exec";
const APP_VERSION = "3.0";

let LAST_VIEW_ID = "transferencia";

let MOV_ORIGEM = ""; // "M1" (Matriz) ou "M3" (Filial)

async function escolherMovOrigemSePreciso(){
  if (MOV_ORIGEM) return MOV_ORIGEM;

  // 1 = Matriz (M1) | 3 = Filial (M3)
  let v = "";
  while(v !== "1" && v !== "3"){
    v = prompt("Origem do movimento:\n\nDigite 1 para Matriz (M1)\nDigite 3 para Filial (M3)", "1");
    if(v === null) throw new Error("Sele√ß√£o de origem cancelada.");
    v = String(v).trim();
  }

  MOV_ORIGEM = (v === "1") ? "M1" : "M3";
  toast("ok","Origem", MOV_ORIGEM === "M1" ? "Matriz selecionada (M1)" : "Filial selecionada (M3)");
  return MOV_ORIGEM;
}

function resetMovOrigem(){
  MOV_ORIGEM = "";
  toast("ok","Origem","Sele√ß√£o de origem resetada.");
}


const COL_DEFAULT = 9;
const COL_TRANSFER = 10;

let NIVEL = "";
let USUARIO_LOGADO = "";
let PERMS = {transferencia:"EDITAR", zeramento:"EDITAR", requisicao:"EDITAR", requisicaoPedidos:"EDITAR", requisicaoManual:"EDITAR", aba164:"EDITAR", entradaSaida:"EDITAR", producao:"EDITAR"};
const codCache = new Map();

/* ‚úÖ Esquema de Grade por C√≥digo (descobre onde vai Cor/Tamanho/Sexo) */

/* ‚úÖ Normaliza√ß√£o (busca no banco via COD) */
async function normalizarCorParaGrade(cor){
  let c = String(cor||"").trim();
  if(!c) c = "Preto";
  const up = c.toUpperCase();

  // default compat√≠vel com suas planilhas: Preto -> PRE
  if(up === "PRETO") return "PRE";

  // tenta buscar no banco: chave "__COR__<NOME>"
  const key = "__COR__" + up;
  const res = await api("cod_get", key);
  if(res && res.ok && res.found){
    const v = String(res.value||"").trim();
    if(v) return v;
  }

  // fallback: tenta abreviar (3 letras) sem quebrar
  if(up.length >= 3) return up.slice(0,3);
  return up || "PRE";
}

async function normalizarSexoParaGrade(sexo){
  let s = String(sexo||"").trim();
  if(!s) s = "Masculino";
  const up = s.toUpperCase();

  // tenta buscar no banco: "__SEXO__MASCULINO" -> "MASC" etc
  const key = "__SEXO__" + up;
  const res = await api("cod_get", key);
  if(res && res.ok && res.found){
    const v = String(res.value||"").trim();
    if(v) return v;
  }

  // defaults comuns
  if(up === "MASCULINO") return "M";
  if(up === "FEMININO") return "F";
  return up;
}
const gradeSchemaCache = new Map(); // codigo -> {colorCol, sizeCol, genderCol}

function _isGenderVal(v){
  const t = String(v||"").trim().toUpperCase();
  return ["MASCULINO","FEMININO","INFANTIL","UNISSEX"].includes(t);
}
function _isSizeVal(v){
  const t = String(v||"").trim().toUpperCase();
  if(!t) return false;
  if(["PP","P","M","G","GG","XG","XGG","2XGG","3XGG","4XGG","EG","EGG","UN","U"].includes(t)) return true;
  if(/^\d{2}$/.test(t)){
    const n = parseInt(t,10);
    return n >= 20 && n <= 60;
  }
  if(/^\d{2}(PP|P|M|G|GG|XG|XGG|EG|EGG)$/.test(t)) return true;
  return false;
}
function _isColorVal(v){
  const t = String(v||"").trim().toUpperCase();
  if(!t) return false;
  const baseColors = new Set(["PRETO","BRANCO","VERDE","AZUL","VERMELHO","AMARELO","ROSA","LARANJA","CINZA","MARROM","BEGE","NATURAL","OFFWHITE","OFF-WHITE"]);
  if(baseColors.has(t)) return true;
  const parts = t.split(/\s+/);
  if(parts.length>=2 && baseColors.has(parts[0])) return true; // ex: VERDE MILITAR, AZUL MARINHO, AMARELO NEON
  return false;
}
function inferGradeSchemaFromValues(g1,g2,g3){
  const vals = [g1,g2,g3].map(v=>String(v||"").trim());
  const schema = { colorCol:null, sizeCol:null, genderCol:null };
  vals.forEach((v, idx)=>{
    const col = idx+1;
    if(_isGenderVal(v) && !schema.genderCol) schema.genderCol = col;
    else if(_isColorVal(v) && !schema.colorCol) schema.colorCol = col;
    else if(_isSizeVal(v) && !schema.sizeCol) schema.sizeCol = col;
  });
  // defaults razo√°veis: se n√£o detectou, cor=2 e tamanho=3
  if(!schema.colorCol) schema.colorCol = 2;
  if(!schema.sizeCol) schema.sizeCol = 3;
  return schema;
}
async function getGradeSchema(codigo){
  const code = String(codigo||"").trim();
  if(!code) return {colorCol:2,sizeCol:3,genderCol:null};
  if(gradeSchemaCache.has(code)) return gradeSchemaCache.get(code);

  const key = "__SCHEMA__" + code;
  const res = await api("cod_get", key);
  if(res && res.ok && res.found){
    try{
      const obj = JSON.parse(res.value || "{}");
      if(obj && obj.colorCol && obj.sizeCol){
        gradeSchemaCache.set(code, obj);
        return obj;
      }
    }catch(_){}
  }
  const def = {colorCol:2,sizeCol:3,genderCol:null};
  gradeSchemaCache.set(code, def);
  return def;
}
async function saveGradeSchema(codigo, schema){
  const code = String(codigo||"").trim();
  if(!code || !schema) return;
  gradeSchemaCache.set(code, schema);
  const key = "__SCHEMA__" + code;
  await api("cod_set", key, JSON.stringify(schema));
}
let LOCAL_OUTRO_TRANSFER = localStorage.getItem("LOCAL_OUTRO_TRANSFER") || "4044";

let ADMIN_USERS = [];
let ADMIN_SELECTED = "";

function $(id){ return document.getElementById(id); }

function trocarView(nome){
  ["login","cadastro","recuperar","app"].forEach(v => $("view_"+v).classList.add("hidden"));
  $("view_"+nome).classList.remove("hidden");
  limparErro();
}

function loading(on, text){
  $("overlayText").textContent = text || "Processando...";
  $("overlay").classList.toggle("show", !!on);
}

let toastTimer=null;
function toast(type,title,msg){
  const t = $("toast");
  t.className = "toast " + (type||"");
  $("toastTitle").textContent = title||"";
  $("toastMsg").textContent = msg||"";
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove("show"), 2600);
}

function mostrarErro(msgCurta, detalhes=""){
  $("statusLogin").classList.add("show");
  $("errMsg").textContent = msgCurta || "Ocorreu um erro.";
  $("errDetails").textContent = detalhes || "";
  $("errDetails").classList.remove("show");
}
function limparErro(){
  $("statusLogin").classList.remove("show");
  $("errMsg").textContent = "";
  $("errDetails").textContent = "";
  $("errDetails").classList.remove("show");
}
function toggleErrDetails(){
  $("errDetails").classList.toggle("show");
}

function toggleSenha(){
  const s = $("senha");
  s.type = (s.type === "password") ? "text" : "password";
}

function toggleTema(){
  document.documentElement.classList.toggle("dark");
  toast("ok","Tema","Tema alternado.");
}

function abrirConfig(){
  $("menuPrincipal").classList.add("hidden");
  $("menuConfig").classList.remove("hidden");
}
function voltarMenu(){
  $("menuConfig").classList.add("hidden");
  $("menuPrincipal").classList.remove("hidden");
}
function setActiveNav(key){
  document.querySelectorAll("#menuPrincipal .item, #menuPrincipal .subitem")
    .forEach(el=>el.classList.remove("active"));
  const el = $("m_"+key);
  if(el) el.classList.add("active");
}


// üî• marca pasta aberta
function toggleSubmenu(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.toggle("hidden");

  const parent = el.previousElementSibling;
  if(parent && parent.classList.contains("item")){
    parent.classList.toggle("open", !el.classList.contains("hidden"));
  }
}

function limparReqManual(){
  const t = document.getElementById("reqManualTexto");
  if(t) t.value = "";
  const p = document.getElementById("reqManualPedido");
  const c = document.getElementById("reqManualCliente");
  if(p) p.value = "";
  if(c) c.value = "";
  toast("ok","Manual","Campo limpo.");
}
function setTop(title,subtitle){
  $("topTitle").textContent=title;
  $("topSubtitle").textContent=subtitle;
}
function abrir(id){
  if(id !== "aba164"){ LAST_VIEW_ID = id; }
  document.querySelectorAll(".main .card").forEach(s=>s.classList.add("hidden"));
  $(id).classList.remove("hidden");

  if(id==="transferencia"){ setTop("Transfer√™ncia","Cole e clique em Importa√ß√£o"); setActiveNav("transferencia"); }
  if(id==="zeramento"){ setTop("Zeramento","Cole e clique em Importa√ß√£o"); setActiveNav("zeramento"); }
  if(id==="requisicao"){ setTop("Requisi√ß√£o","Cole pedidos e clique em Importa√ß√£o"); setActiveNav("requisicao");
    document.getElementById("sub_requisicao")?.classList.remove("hidden");
    document.getElementById("m_requisicao_pedidos")?.classList.add("active");
    document.getElementById("m_requisicao_manual")?.classList.remove("active");
  }
  if(id==="requisicaoManual"){ setTop("Requisi√ß√£o Manual","Digite manualmente"); setActiveNav("requisicao");
    document.getElementById("sub_requisicao")?.classList.remove("hidden");
    document.getElementById("m_requisicao_manual")?.classList.add("active");
    document.getElementById("m_requisicao_pedidos")?.classList.remove("active");
  }
  if(id==="aba164"){ setTop("164",""); setActiveNav("aba164"); }
  if(id==="producao"){ setTop("Entrada x Sa√≠da (Produ√ß√£o)","Cole Entrada e Sa√≠da/Baixa e confira pela composi√ß√£o"); setActiveNav("producao"); try{ const a=document.querySelector("#tblProdA tbody"); const b=document.querySelector("#tblProdB tbody"); if((a && a.children.length===0) || (b && b.children.length===0)) initProducao(); }catch(e){} }
if(id==="entradaSaida"){ setTop("Entrada x Sa√≠da","Resumo r√°pido (Total x Real)"); setActiveNav("entradaSaida"); }
  if(id==="cfgTransfer"){ setTop("Configura√ß√µes","Transfer√™ncia (Locais)"); }
  if(id==="cfgSenha"){ setTop("Configura√ß√µes","Mudar senha"); }
  if(id==="adminPerms"){ setTop("Admin","Gerencie emails e permiss√µes"); }
}

function dataHoje_ptBR(){ return new Date().toLocaleDateString("pt-BR"); }
function norm(s){return (s||"").toString().trim();}
function normalizeQTD(str){
  const s=(str||"0").toString().trim();
  let v=parseFloat(s.replace(/\./g,"").replace(",", "."));
  if(isNaN(v)) v=0;
  return v;
}
function absQTDNumFromText(txt){ return Math.abs(normalizeQTD(txt)); }
function formatQtdTxtFromNum(n){
  if (Number.isInteger(n)) return String(n);
  let s = n.toFixed(3).replace(".", ",");
  s = s.replace(/0+$/,"").replace(/,$/,"");
  return s;
}


// Escape simples para evitar HTML quebrado em tabelas (Produ√ß√£o)
function escapeHtml(value){
  const s = String(value ?? "");
  return s
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function baixarComoTXT(nome,texto){
  const blob=new Blob([texto],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=nome+".txt";
  a.click();
}

async function api(action, ...args){
  const payload = JSON.stringify({ action, args });

  let r, txt;
  try{
    r = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: payload,
      redirect:"follow"
    });
    txt = await r.text();
  }catch(e){
    throw new Error("Sem conex√£o com a API. Verifique internet ou URL /exec.");
  }

  if (txt && (txt.trim().startsWith("<!DOCTYPE html") || txt.includes("<html"))){
    throw new Error("API retornou HTML (Deploy/Permiss√£o). Publique como Web App: Anyone e use a URL /exec.");
  }

  if(!r.ok){
    throw new Error("Falha na API (HTTP "+r.status+").");
  }

  try{
    return JSON.parse(txt);
  }catch(e){
    throw new Error("API respondeu formato inv√°lido (n√£o JSON).");
  }
}

function tableBody(sectionId){
  return document.querySelector(`#${sectionId} table.sheet tbody`);
}
function criarTabela(sectionId, linhas=10, colunas=9){
  const tbody = tableBody(sectionId);
  tbody.innerHTML="";
  for(let i=0;i<linhas;i++){
    const tr=document.createElement("tr");
    for(let j=0;j<colunas;j++){
      const td=document.createElement("td");
      td.contentEditable="true";
      td.addEventListener("paste", handlePaste);
      td.addEventListener("keydown", handleGridNav);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}
function limparTabela(sectionId){
  let cols = COL_DEFAULT;
  if(sectionId === "transferencia") cols = COL_TRANSFER;
  if(sectionId === "producao") cols = 7;
  criarTabela(sectionId,10,cols);
  toast("ok","Limpar","Tabela limpa.");
}

/* ‚úÖ ABA 164  */
function criarTabelaCustom(tbodyEl, linhas=12, colunas=8){
  tbodyEl.innerHTML="";
  for(let i=0;i<linhas;i++){
    const tr=document.createElement("tr");
    for(let j=0;j<colunas;j++){
      const td=document.createElement("td");
      td.contentEditable="true";
      td.addEventListener("paste", handlePaste);
      td.addEventListener("keydown", handleGridNav);
      tr.appendChild(td);
    }
    tbodyEl.appendChild(tr);
  }
}

function init164(){
  const a = document.querySelector("#tbl164A tbody");
  const b = document.querySelector("#tbl164B tbody");
  const r = document.querySelector("#tbl164Res tbody");
  if(a) criarTabelaCustom(a, 12, 7);
  if(b) criarTabelaCustom(b, 12, 7);
  if(r) r.innerHTML="";
  const hint = document.getElementById("res164Hint");
  if(hint) hint.textContent = "‚Äî";
}

function limpar164(){
  init164();
initProducao();
initProducao();
    carregarEntradaSaidaCompartilhado();
  const wrap = document.getElementById("wrap164Inputs");
  if(wrap) wrap.style.display = "block";
  toast("ok","164","Tabelas limpas.");
}

function toggleInputs164(){
  const wrap = document.getElementById("wrap164Inputs");
  if(!wrap) return;
  const showing = wrap.style.display !== "none";
  wrap.style.display = showing ? "none" : "block";
  // quando mostrar, sobe um pouco para facilitar colar
  if(!showing){
    wrap.scrollIntoView({behavior:"smooth", block:"start"});
  }
}

function mapFrom164Table(tbody, kind){
  // kind: "A" ou "B"
  const map = new Map(); // key -> soma
  const rows = Array.from(tbody.querySelectorAll("tr"));

  const norm = (s)=> (s||"").toString().trim();
  const lower = (s)=> norm(s).toLowerCase();

  // defaults (caso a planilha seja colada sem cabe√ßalho)
  let cols = (kind === "A")
    ? { code: 1, g1: 3, g2: 4, g3: 5, qty: 6 }
    : { code: 0, g1: 2, g2: 3, g3: 4, qty: 6 };

  function detectFromHeader(cells){
    const found = {};
    cells.forEach((c, i)=>{
      const h = lower(c.innerText);

      // code
      if(h.includes("c√≥digo produto") || h.includes("codigo produto")) found.code = i;
      if(h.includes("c√≥digo prod/serv") || h.includes("codigo prod/serv")) found.code = i;
      if(h === "cod." || h === "cod") found.code = i;

      // grades
      if(h.includes("grade 1") || h === "grade1") found.g1 = i;
      if(h.includes("grade 2") || h === "grade2") found.g2 = i;
      if(h.includes("grade 3") || h === "grade3") found.g3 = i;

      // qty
      if(h.includes("qtde estoque") || h.includes("qtd. estoque") || h.includes("qtd estoque")) found.qty = i;
      if(h.includes("quant. liberada") || h.includes("quant liberada")) found.qty = i;
    });

    // se n√£o achou qty, usa √∫ltima coluna
    if(found.qty === undefined) found.qty = cells.length - 1;

    // aplica somente se pelo menos code e qty existem
    if(found.code !== undefined && found.qty !== undefined){
      cols = { ...cols, ...found };
      return true;
    }
    return false;
  }

  // tenta achar cabe√ßalho (linha que cont√©m "grade" e "quant"/"estoque")
  let startRow = 0;
  for(let i=0;i<rows.length;i++){
    const texts = Array.from(rows[i].cells).map(c=>lower(c.innerText)).join(" ");
    if(texts.includes("grade") && (texts.includes("estoque") || texts.includes("quant"))){
      if(detectFromHeader(Array.from(rows[i].cells))){
        startRow = i + 1;
        break;
      }
    }
  }

  for(let i=startRow;i<rows.length;i++){
    const cells = rows[i].cells;
    if(!cells || !cells.length) continue;

    const code = norm(cells[cols.code]?.innerText);
    if(!code) continue;

    const g1 = norm(cells[cols.g1]?.innerText);
    const g2 = norm(cells[cols.g2]?.innerText);
    const g3 = norm(cells[cols.g3]?.innerText);

    const qtyTxt = norm(cells[cols.qty]?.innerText);
    const qty = normalizeQTD(qtyTxt || "0");
    if(isNaN(qty) || qty === 0) continue;

    // chave por c√≥digo + grades (para n√£o misturar tamanhos/cores)
    const key = [code, g1, g2, g3].join("||");
    map.set(key, (map.get(key) || 0) + qty);
  }

  return map;
}

function render164Resultado(diffMap){
  const tbody = document.querySelector("#tbl164Res tbody");
  tbody.innerHTML = "";

  const sobras = [...diffMap.entries()]
    .filter(([_,v]) => Math.abs(v) > 0)
    .sort((a,b)=> a[0].localeCompare(b[0], "pt-BR"));

  if(!sobras.length){
    document.getElementById("res164Hint").textContent = "‚úÖ 164 est√° certo: nenhuma sobra.";
    return;
  }

  document.getElementById("res164Hint").textContent = `‚ö†Ô∏è Existem ${sobras.length} itens com sobra. Veja abaixo:`;

  for(const [key, qtd] of sobras){
    const [code, g1, g2, g3] = key.split("||");
    const parts = [code];
    const grades = [g1,g2,g3].filter(x=>x && x.trim());
    if(grades.length) parts.push(`(${grades.join(" / ")})`);

    const tr = document.createElement("tr");
    const td1 = document.createElement("td");
    const td2 = document.createElement("td");
    td1.textContent = parts.join(" ");
    td2.textContent = formatQtdTxtFromNum(qtd);
    tr.appendChild(td1);
    tr.appendChild(td2);
    tbody.appendChild(tr);
  }
}

function comparar164(){
  try{
    const aBody = document.querySelector("#tbl164A tbody");
    const bBody = document.querySelector("#tbl164B tbody");
    const mapA = mapFrom164Table(aBody, "A");
    const mapB = mapFrom164Table(bBody, "B");

    const diff = new Map();

    // A - B
    for(const [cod, qtdA] of mapA.entries()){
      diff.set(cod, (diff.get(cod) || 0) + qtdA);
    }
    for(const [cod, qtdB] of mapB.entries()){
      diff.set(cod, (diff.get(cod) || 0) - qtdB);
    }

    // remove quase zero
    for(const [cod, v] of diff.entries()){
      if(Math.abs(v) < 0.0000001) diff.delete(cod);
    }

    render164Resultado(diff);

    const wrap = document.getElementById("wrap164Inputs");
    if(wrap) wrap.style.display = "none";

    const anchor = document.getElementById("sobras164");
    if(anchor) anchor.scrollIntoView({behavior:"smooth", block:"start"});

    toast("ok","164","Compara√ß√£o conclu√≠da.");
  }catch(err){
    toast("danger","Erro", err.message || String(err));
  }
}




function handlePaste(e){
  e.preventDefault();
  const text=(e.clipboardData||window.clipboardData).getData("text");
  const rows=text.split(/\r?\n/).filter(r=>r!=="");

  const startCell=e.target, tr=startCell.parentElement, tbody=tr.parentElement;
  const rowIndex=Array.from(tbody.rows).indexOf(tr);
  const colIndex=Array.from(tr.cells).indexOf(startCell);

  const table = tbody.closest("table");
  const colCount = table ? table.querySelectorAll("thead th").length : COL_DEFAULT;
  const tableId = table ? (table.id || "") : "";

  rows.forEach((r,i)=>{
    let cols=r.split(/\t/);

    // ‚úÖ Ajuste especial para Produ√ß√£o (A/B):
    // muitos relat√≥rios v√™m com 6 colunas (sem "C√≥digo Local").
    // Quando colando a partir da 1¬™ coluna, shift +1 para alinhar:
    // [codigo, nome, g1, g2, g3, qtd] -> ["", codigo, nome, g1, g2, g3, qtd]
    if((tableId==="tblProdA" || tableId==="tblProdB") && colCount===7 && colIndex===0){
      // se vier 6 colunas e a √∫ltima parece n√∫mero => assume sem local
      const last = (cols[cols.length-1]||"").trim();
      const isNum = last!=="" && !isNaN(Number(String(last).replace(",", ".")));
      if(cols.length===6 && isNum){
        cols = ["", ...cols];
      }
      // alguns saem com 7 colunas mas ordem diferente; n√£o mexe
    }

    let targetRow=tbody.rows[rowIndex+i];
    if(!targetRow){
      targetRow=tbody.insertRow();
      for(let k=0;k<colCount;k++){
        const td=targetRow.insertCell();
        td.contentEditable="true";
        td.addEventListener("paste", handlePaste);
        td.addEventListener("keydown", handleGridNav);
      }
    }
    cols.forEach((c,j)=>{
      const td=targetRow.cells[colIndex+j];
      if(td) td.innerText=c;
    });
  });
}
function handleGridNav(e){
  if(e.key!=="Enter") return;
  e.preventDefault();
  const td=e.target;
  const tr=td.parentElement;
  const tbody=tr.parentElement;
  const r=Array.from(tbody.rows).indexOf(tr);
  const c=Array.from(tr.cells).indexOf(td);
  const nextRow = tbody.rows[r+1] || tbody.rows[r];
  (nextRow.cells[c] || nextRow.cells[0]).focus();
}

function salvarCfgTransfer(){
  const v = ($("cfgLocalOutro").value || "").trim();
  if(!v) return toast("warn","Aten√ß√£o","Informe o outro local (ex: 4044).");
  LOCAL_OUTRO_TRANSFER = v;
  localStorage.setItem("LOCAL_OUTRO_TRANSFER", v);
  toast("ok","Salvo","Outro Local atualizado.");
}

async function salvarSenha(){
  const atual = ($("senhaAtual").value || "").trim();
  const nova  = ($("senhaNova").value || "").trim();
  const nova2 = ($("senhaNova2").value || "").trim();

  if(!atual || !nova || !nova2) return toast("warn","Aten√ß√£o","Preencha todos os campos.");
  if(nova !== nova2) return toast("warn","Aten√ß√£o","A nova senha n√£o confere.");
  if(nova.length < 3) return toast("warn","Aten√ß√£o","Nova senha muito curta.");

  try{
    loading(true, "Atualizando senha...");
    const r = await api("alterarSenha", USUARIO_LOGADO, atual, nova);
    if(r.ok){
      $("senhaAtual").value="";
      $("senhaNova").value="";
      $("senhaNova2").value="";
      toast("ok","Senha","Senha atualizada!");
      voltarMenu();
      abrir("transferencia");
    }else{
      toast("danger","Senha", r.msg || "Erro ao alterar.");
    }
  }catch(err){
    toast("danger","Erro", err.message);
  }finally{
    loading(false);
  }
}

/* ‚úÖ Menu com cadeado quando bloqueado */
function aplicarPermissoesUI(){
  // item (layout com <span> e <small>)
  function setItem(id, perm, nome, smallDefault){
    const el = $(id);
    if(!el) return;

    const small = el.querySelector("small");
    const span = el.querySelector("span");

    const p = String(perm||"").toUpperCase();
    if(p === "BLOQUEAR"){
      el.classList.add("disabled");
      if(span) span.textContent = `üîí ${nome}`;
      if(small) small.textContent = "Bloqueado";
    }else{
      el.classList.remove("disabled");
      if(span) span.textContent = nome;
      if(small){
        if(p === "VISUALIZAR") small.textContent = "Visualizar";
        else small.textContent = (smallDefault || "Abrir");
      }
    }
  }

  // subitem (texto direto)
  function setSubitem(id, perm, label){
    const el = document.getElementById(id);
    if(!el) return;

    const p = String(perm||"").toUpperCase();
    const blocked = (p === "BLOQUEAR");
    el.classList.toggle("locked", blocked);

    if(blocked){
      if(!el.textContent.includes("üîí")) el.textContent = `üîí ${label}`;
    }else{
      el.textContent = label;
    }
  }

  // ‚úÖ Transfer√™ncia / Zeramento (sempre vis√≠veis)
  setItem("m_transferencia", PERMS.transferencia, "üì¶ Transfer√™ncia", "Editar");
  setItem("m_zeramento",     PERMS.zeramento,     "üîÅ Zeramento",     "Editar");

  // ‚úÖ Requisi√ß√µes granular (Pedidos / Manual)
  // Compat: se n√£o vier granular da API, usa PERMS.requisicao como fallback
  const pReqPed = (PERMS.requisicaoPedidos != null) ? PERMS.requisicaoPedidos : PERMS.requisicao;
  const pReqMan = (PERMS.requisicaoManual  != null) ? PERMS.requisicaoManual  : PERMS.requisicao;

  const pPed = String(pReqPed||"").toUpperCase();
  const pMan = String(pReqMan||"").toUpperCase();

  const reqTudoBloq = (pPed==="BLOQUEAR" && pMan==="BLOQUEAR");

  // Estoque (grupo) depende: Requisi√ß√µes (ped/man) + 164 + EntradaSaida
  const p164  = String(PERMS.aba164||"").toUpperCase();
  const pES   = String(PERMS.entradaSaida||"").toUpperCase();
  const estoqueTudoBloq = (reqTudoBloq && p164==="BLOQUEAR" && pES==="BLOQUEAR");

  const estoqueItem = document.getElementById("m_estoque");
  const estoqueSub  = document.getElementById("sub_estoque");

  if(estoqueItem){
    estoqueItem.classList.toggle("disabled", estoqueTudoBloq);
    const span = estoqueItem.querySelector("span");
    const small = estoqueItem.querySelector("small");
    if(estoqueTudoBloq){
      if(span) span.textContent = "üîí üì¶ Estoque";
      if(small) small.textContent = "Bloqueado";
      if(estoqueSub) estoqueSub.classList.add("hidden");
    }else{
      if(span) span.textContent = "üì¶ Estoque";
      if(small) small.textContent = "Abrir";
    }
  }

  // Requisi√ß√µes (item colaps√°vel dentro do Estoque)
  setSubitem("m_requisicao", reqTudoBloq ? "BLOQUEAR" : "EDITAR", "üìù Requisi√ß√µes");
  const subReq = document.getElementById("sub_requisicao");
  if(subReq){
    // se tudo bloqueado, some o submenu
    if(reqTudoBloq) subReq.classList.add("hidden");
  }
  setSubitem("m_requisicao_pedidos", pReqPed, "üìÑ Pedidos");
  setSubitem("m_requisicao_manual",  pReqMan, "‚úçÔ∏è Manual");

  // Outros itens dentro do Estoque
  setSubitem("m_aba164",       PERMS.aba164,       "üìå 164");
  setSubitem("m_entradaSaida", PERMS.entradaSaida, "‚öñÔ∏è Entrada x Sa√≠da");

  // ‚úÖ Produ√ß√£o (grupo colaps√°vel)
  const pProd = String(PERMS.producao||"").toUpperCase();
  const prodBloq = (pProd==="BLOQUEAR");

  const prodItem = document.getElementById("m_producao_group");
  const prodSub  = document.getElementById("sub_producao");

  if(prodItem){
    prodItem.classList.toggle("disabled", prodBloq);
    const span = prodItem.querySelector("span");
    const small = prodItem.querySelector("small");
    if(prodBloq){
      if(span) span.textContent = "üîí üè≠ Produ√ß√£o";
      if(small) small.textContent = "Bloqueado";
      if(prodSub) prodSub.classList.add("hidden");
    }else{
      if(span) span.textContent = "üè≠ Produ√ß√£o";
      if(small) small.textContent = "Abrir";
    }
  }
  setSubitem("m_producao", PERMS.producao, "‚öñÔ∏è Entrada x Sa√≠da");
// ‚úÖ Admin menu
  $("btnAdminMenu").classList.toggle("hidden", NIVEL !== "ADMIN");
}



async function mapearOuCadastrar(chave){
  const key=(chave||"").toString().trim();
  if(!key) return "";
  const norm=key.toLowerCase();
  if(codCache.has(norm)) return codCache.get(norm);

  const res=await api("cod_get", key);
  if(res.ok && res.found){ codCache.set(norm,res.value); return res.value; }

  const saida=prompt(`CHAVE n√£o cadastrada (COD A/B):\n"${key}"\nDigite o que deve sair no TXT:`);
  if(saida===null) throw new Error("Cadastro cancelado: "+key);
  const out=saida.toString().trim();
  if(!out) throw new Error("Sa√≠da vazia: "+key);

  const saved=await api("cod_set", key, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar COD");
  codCache.set(norm,out);
  return out;
}

async function autoCadastrarParaManual(descricao, codigo){
  const desc = (descricao||"").toString().trim();
  const cod = (codigo||"").toString().trim();
  if(!desc || !cod) return;
  // cadastra SOMENTE pelo nome do produto (sem cor/sexo), se a descri√ß√£o vier com isso o manual remove depois.
  const res = await api("cod_get", desc);
  if(res.ok && res.found) return;
  await api("cod_set", desc, cod);
  codCache.set(desc.toLowerCase(), cod);
}
async function getLocalPorItem(codigoItem){
  const code=(codigoItem||"").toString().trim();
  if(!code) return "";
  const res=await api("cod_get_local", code);
  if(res.ok && res.found) return res.value;

  const local=prompt(`LOCAL n√£o cadastrado para item "${code}".\nDigite o LOCAL (ex: 164):`);
  if(local===null) throw new Error("Cadastro de local cancelado.");
  const out=local.toString().trim();
  if(!out) throw new Error("LOCAL vazio.");

  const saved=await api("cod_set_local", code, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar local.");
  return out;
}
async function getRequisitantePorUsuario(usuario){
  const u=(usuario||"").toString().trim().toLowerCase();
  if(!u) return "74";
  const res=await api("req_get", u);
  if(res.ok && res.found) return res.value;

  const req=prompt(`Requisitante n√£o cadastrado para "${u}".\nDigite o valor (ex: 74):`);
  if(req===null) throw new Error("Cadastro cancelado.");
  const out=req.toString().trim();
  if(!out) throw new Error("Requisitante vazio.");

  const saved=await api("req_set", u, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar requisitante.");
  return out;
}

async function entrar(){
  limparErro();
  const u = $("usuario").value.trim();
  const s = $("senha").value.trim();
  if(!u || !s) return toast("warn","Aten√ß√£o","Preencha usu√°rio e senha.");

  const btn = $("btnEntrar");
  btn.disabled = true;
  const oldTxt = btn.textContent;
  btn.textContent = "Entrando...";
  loading(true, "Validando login...");

  try{
    const res = await api("login", u, s);
    if(!res.ok){
      const msg = (res.msg || "Usu√°rio ou senha inv√°lidos.");
      toast("danger","Login", msg);
      mostrarErro("Falha no login.", msg);
      return;
    }

    NIVEL = (res.nivel || "").toUpperCase();
    USUARIO_LOGADO = res.usuario || u;
    PERMS = res.perms || PERMS;

    trocarView("app");

    $("sideUser").textContent = USUARIO_LOGADO;
    $("sideNivel").textContent = NIVEL;
    $("pillUser").textContent = `${USUARIO_LOGADO} ‚Ä¢ ${NIVEL}`;
    $("appVersion").textContent = "v" + APP_VERSION;

    criarTabela("transferencia",10,COL_TRANSFER);
    criarTabela("zeramento",10,COL_DEFAULT);
    criarTabela("requisicao",10,COL_DEFAULT);
    criarTabela("producao",10,7);
    init164();
initProducao();

    $("cfgLocalOutro").value = LOCAL_OUTRO_TRANSFER;

    aplicarPermissoesUI();
    voltarMenu();
    abrir("transferencia");

    toast("ok","Bem-vindo",`Voc√™ entrou como ${NIVEL}.`);
    if(NIVEL==="ADMIN") adminRecarregar();

  }catch(err){
    mostrarErro("N√£o foi poss√≠vel entrar agora.", err.message);
    toast("danger","Erro", err.message);
  }finally{
    loading(false);
    btn.disabled = false;
    btn.textContent = oldTxt;
  }
}

async function cadastrar(){
  limparErro();
  try{
    loading(true, "Criando conta...");
    const res = await api("cadastrar", $("cUser").value, $("cSenha").value, $("cEmail").value);
    if(res.ok){
      toast("ok","Cadastro","Conta criada!");
      trocarView("login");
    }else{
      toast("danger","Cadastro",res.msg || "Erro");
    }
  }catch(err){
    toast("danger","Erro",err.message);
  }finally{
    loading(false);
  }
}

async function recuperarSenha(){
  limparErro();
  try{
    loading(true, "Enviando email...");
    const res = await api("recuperar", $("rUser").value);
    toast(res.ok?"ok":"danger","Recuperar", res.ok ? "Email enviado!" : (res.msg || "Erro"));
  }catch(err){
    toast("danger","Erro",err.message);
  }finally{
    loading(false);
  }
}

function sair(){
  NIVEL=""; USUARIO_LOGADO="";
  $("senha").value="";
  trocarView("login");
  toast("ok","Saiu","Voc√™ voltou para o login.");
}


function importacaoProducao(){
  toast("ok","Produ√ß√£o","Importa√ß√£o de produ√ß√£o em desenvolvimento.");
}



/* ‚úÖ Entrada x Sa√≠da (Resumo) - compartilhado (salva na API p/ todos) */
function _esMesRef(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`; // YYYY-MM
}
function _esKey(suf){ return `__ENTRADA_SAIDA__${_esMesRef()}__${suf}`; }

function _parseBRNum(v){
  const s = String(v||"0").trim();
  // aceita "24.453" como separador de milhar e "," decimal
  let n = parseFloat(s.replace(/\./g,"").replace(",", "."));
  if(isNaN(n)) n = 0;
  return n;
}
function _fmtBRIntOrDec(n){
  if (Number.isInteger(n)) return String(n);
  let s = n.toFixed(3).replace(".", ",");
  s = s.replace(/0+$/,"").replace(/,$/,"");
  return s;
}

let _esSaveTimer = null;

function _getEsLeftCells(){
  const sec = document.getElementById("entradaSaida");
  if(!sec) return null;
  const rows = sec.querySelectorAll("tbody tr");
  // rows 0..3: saldo/entrada/saida/ajuste (tabela esquerda)
  return {
    saldoTd: rows[0]?.cells[1],
    entradaTd: rows[1]?.cells[1],
    saidaTd: rows[2]?.cells[1],
    ajusteTd: rows[3]?.cells[1],
  };
}

function _getEsRealTd(){
  return document.getElementById("es_real");
}

function _scheduleSalvarEntradaSaida(){
  clearTimeout(_esSaveTimer);
  _esSaveTimer = setTimeout(()=> salvarEntradaSaidaCompartilhado(), 450);
}

async function salvarEntradaSaidaCompartilhado(){
  try{
    const left = _getEsLeftCells();
    const realTd = _getEsRealTd();
    if(!left || !realTd) return;

    const payload = {
      saldo: (left.saldoTd?.innerText||"0").trim(),
      entrada: (left.entradaTd?.innerText||"0").trim(),
      saida: (left.saidaTd?.innerText||"0").trim(),
      ajuste: (left.ajusteTd?.innerText||"0").trim(),
      real: (realTd?.innerText||"0").trim(),
      ts: Date.now()
    };

    await api("cod_set", _esKey("DATA"), JSON.stringify(payload));
  }catch(err){
    console.warn("Falha ao salvar Entrada x Sa√≠da:", err.message || err);
  }
}

async function carregarEntradaSaidaCompartilhado(){
  try{
    const mesEl = document.getElementById("es_mes_ref");
    if(mesEl) mesEl.textContent = `(${_esMesRef()})`;

    const res = await api("cod_get", _esKey("DATA"));
    if(!res || !res.ok || !res.found) {
      recalcularEntradaSaida();
      return;
    }
    let obj = null;
    try{ obj = JSON.parse(res.value || "{}"); }catch(_){ obj = null; }
    if(!obj) { recalcularEntradaSaida(); return; }

    const left = _getEsLeftCells();
    const realTd = _getEsRealTd();
    if(left?.saldoTd) left.saldoTd.innerText = obj.saldo ?? "0";
    if(left?.entradaTd) left.entradaTd.innerText = obj.entrada ?? "0";
    if(left?.saidaTd) left.saidaTd.innerText = obj.saida ?? "0";
    if(left?.ajusteTd) left.ajusteTd.innerText = obj.ajuste ?? "0";
    if(realTd) realTd.innerText = obj.real ?? "0";

    const inp = document.getElementById("es_saldo_mes");
    if(inp) inp.value = (obj.saldo ?? "0");

    recalcularEntradaSaida();
  }catch(err){
    console.warn("Falha ao carregar Entrada x Sa√≠da:", err.message || err);
    recalcularEntradaSaida();
  }
}

function recalcularEntradaSaida(){
  const sec = document.getElementById("entradaSaida");
  if(!sec) return;

  const rows = sec.querySelectorAll("tbody tr");
  const saldo = _parseBRNum(rows[0]?.cells[1]?.innerText);
  const entrada = _parseBRNum(rows[1]?.cells[1]?.innerText);
  const saida = _parseBRNum(rows[2]?.cells[1]?.innerText);
  const ajuste = _parseBRNum(rows[3]?.cells[1]?.innerText);

  const total = saldo + entrada + saida + ajuste;

  const realEl = document.getElementById("es_real");
  const real = _parseBRNum(realEl?.innerText);

  const diff = real - total;

  const totalEl = document.getElementById("es_total");
  const diffEl  = document.getElementById("es_diff");

  if(totalEl) totalEl.textContent = _fmtBRIntOrDec(total);
  if(diffEl){
    diffEl.textContent = _fmtBRIntOrDec(diff);
    diffEl.style.background = Math.abs(diff) < 0.0000001 ? "rgba(18,183,106,.12)" : "rgba(240,68,56,.10)";
    diffEl.style.borderRadius = "12px";
    diffEl.style.textAlign = "center";
  }

  _scheduleSalvarEntradaSaida();
}

function limparEntradaSaida(){
  const sec = document.getElementById("entradaSaida");
  if(!sec) return;
  const cells = sec.querySelectorAll("tbody td[contenteditable='true']");
  cells.forEach(td => td.innerText = "0");
  const totalEl = document.getElementById("es_total");
  const diffEl  = document.getElementById("es_diff");
  if(totalEl) totalEl.textContent = "0";
  if(diffEl){ diffEl.textContent = ""; diffEl.style.background = ""; }
  toast("ok","Entrada x Sa√≠da","Campos limpos.");
  salvarEntradaSaidaCompartilhado();
}

/* ‚úÖ Menu 3 pontos (saldo inicial do m√™s) */
function toggleESPanel(ev, forceClose=false){
  if(ev) ev.stopPropagation();
  const p = document.getElementById("es_panel");
  if(!p) return;
  if(forceClose){ p.classList.add("hidden"); return; }
  p.classList.toggle("hidden");
  const mesEl = document.getElementById("es_mes_ref");
  if(mesEl) mesEl.textContent = `(${_esMesRef()})`;
}

// fecha painel clicando fora
document.addEventListener("click", (e)=>{
  const p = document.getElementById("es_panel");
  const sec = document.getElementById("entradaSaida");
  if(!p || !sec) return;
  if(p.classList.contains("hidden")) return;
  if(sec.contains(e.target)) return;
  p.classList.add("hidden");
});

async function aplicarSaldoInicialMes(){
  const inp = document.getElementById("es_saldo_mes");
  const v = (inp?.value || "").trim();
  if(!v) return toast("warn","Entrada x Sa√≠da","Informe o saldo inicial do m√™s.");
  const left = _getEsLeftCells();
  if(left?.saldoTd) left.saldoTd.innerText = v;
  recalcularEntradaSaida();
  await salvarEntradaSaidaCompartilhado();
  toast("ok","Entrada x Sa√≠da","Saldo inicial aplicado e salvo para todos.");
  toggleESPanel(null, true);
}

/* IMPORTA√á√ïES */
async function importacaoTransferencia(){
  try{
    loading(true, "Gerando TXT...");
    const mov = await escolherMovOrigemSePreciso();
    const rows=tableBody("transferencia").querySelectorAll("tr");
    const hoje=dataHoje_ptBR();
    const out=[];

    for(const tr of rows){
      const c=[...tr.cells].map(td=>(td.innerText||"").trim());
      while(c.length<COL_TRANSFER) c.push("");

      const codigo=c[0];
      const descricao=c[1]||"";
      // ‚úÖ sempre que gerar transfer√™ncia, cadastra automaticamente para Requisi√ß√£o Manual (COD A/B)
      await autoCadastrarParaManual(descricao, codigo);
      const chave5=c[2], chave6=c[3], chave7=c[4];
      const qtd1=normalizeQTD(c[5]||"0");
      const qtd2=normalizeQTD(c[6]||"0");

      const qtd3Abs = absQTDNumFromText(c[7]||"0");
      if(qtd3Abs === 0) continue;
      const qtd3Txt = formatQtdTxtFromNum(qtd3Abs);

      const localInformado=(c[8]||"164").trim() || "164";

      // ‚úÖ 10¬™ coluna destino por linha; fallback config
      let destinoLinha = (c[9] || "").trim();
      if(!destinoLinha) destinoLinha = (LOCAL_OUTRO_TRANSFER||"4044").trim();

      const f5=await mapearOuCadastrar(chave5);
      const f6=await mapearOuCadastrar(chave6);
      const f7=await mapearOuCadastrar(chave7);

      let origem=localInformado, destino=destinoLinha;
      if(qtd2>qtd1){ origem=destinoLinha; destino=localInformado; }

      const valor=(qtd3Abs*0.01).toFixed(2).replace(".",",");

      out.push([mov,"T",hoje,codigo,f5,f6,f7,origem,destino,qtd3Txt,"0,01",valor,"5949"].join("|"));
    }

    if(!out.length) return toast("warn","Importa√ß√£o","Nada para importar.");
    baixarComoTXT("importacao_transferencia", out.join("\n"));
    toast("ok","Importa√ß√£o",`${out.length} linhas geradas.`);
  }catch(err){
    toast("danger","Erro",err.message);
  }finally{
    loading(false);
  }
}

async function importacaoZeramento(){
  try{
    loading(true, "Gerando TXT...");
    const mov = await escolherMovOrigemSePreciso();
    const rows=tableBody("zeramento").querySelectorAll("tr");
    const hoje=dataHoje_ptBR();
    const out=[];

    for(const tr of rows){
      const c=[...tr.cells].map(td=>(td.innerText||"").trim());
      while(c.length<COL_DEFAULT) c.push("");

      const codigo=c[0];
      const chave5=c[2], chave6=c[3], chave7=c[4];
      const qtd1=normalizeQTD(c[5]||"0");
      const qtd2=normalizeQTD(c[6]||"0");

      const qtd3Abs = absQTDNumFromText(c[7]||"0");
      if(qtd3Abs === 0) continue;
      const qtd3Txt = formatQtdTxtFromNum(qtd3Abs);

      const local=(c[8]||"164").trim() || "164";

      const f5=await mapearOuCadastrar(chave5);
      const f6=await mapearOuCadastrar(chave6);
      const f7=await mapearOuCadastrar(chave7);

      const tipo=(qtd2>qtd1)?"E":"S";
      const final=(qtd2>qtd1)?"1905":"5906";
      const valor=(qtd3Abs*0.01).toFixed(2).replace(".",",");

      out.push([mov,tipo,hoje,codigo,f5,f6,f7,local,qtd3Txt,"0,01",valor,final].join("|"));
    }

    if(!out.length) return toast("warn","Importa√ß√£o","Nada para importar.");
    baixarComoTXT("importacao_zeramento", out.join("\n"));
    toast("ok","Importa√ß√£o",`${out.length} linhas geradas.`);
  }catch(err){
    toast("danger","Erro",err.message);
  }finally{
    loading(false);
  }
}

async function importacaoRequisicao(){
  try{
    loading(true, "Gerando TXT...");
    const rows=tableBody("requisicao").querySelectorAll("tr");
    const hoje=dataHoje_ptBR();
    const requisitante=await getRequisitantePorUsuario(USUARIO_LOGADO);

    const pedidos=new Map();
    for(const tr of rows){
      const raw=[...tr.cells].map(td=>(td.innerText||"").trim());
      if(raw.every(x=>!x)) continue;

      const pedido=(raw[0]||"").trim();
      const cliente=(raw[1]||"").trim();
      const codigo=(raw[2]||"").trim();
      const k5=(raw[3]||"").trim();
      const k6=(raw[4]||"").trim();
      const k7=(raw[5]||"").trim();

      const qtdAbs = absQTDNumFromText(raw[6]||"0");
      if(qtdAbs === 0) continue;
      const qtd = formatQtdTxtFromNum(qtdAbs);

      if(!pedido || !codigo) continue;

      if(!pedidos.has(pedido)) pedidos.set(pedido,{cliente,itens:[]});
      else if(!pedidos.get(pedido).cliente && cliente) pedidos.get(pedido).cliente=cliente;

      pedidos.get(pedido).itens.push({codigo,k5,k6,k7,qtd});
    }

    const out=[];
    for(const [pedido,obj] of pedidos.entries()){
      out.push(["R",hoje,"1","1",requisitante,"27",`${pedido}  -  ${obj.cliente||""}`,pedido,"0","0"].join("|"));
      for(const it of obj.itens){
        const local=await getLocalPorItem(it.codigo);
        out.push(["I","P",it.codigo,it.k5||"",it.k6||"",it.k7||"",it.qtd,"3",local].join("|"));
      }
    }

    if(!out.length) return toast("warn","Importa√ß√£o","Nada para importar.");
    baixarComoTXT("importacao_requisicao", out.join("\n"));
    toast("ok","Importa√ß√£o",`${out.length} linhas geradas.`);
  }catch(err){
    toast("danger","Erro",err.message);
  }finally{
    loading(false);
  }
}


/* ‚úÖ Requisi√ß√£o Manual -> mesmo TXT de Pedidos (mensagens variadas) */
function _extractPedidoCliente(text){
  const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return {pedido:"", cliente:"", rest:""};
  const m = lines[0].match(/^(\d{4}-\d{6})\s+(.+)$/);
  if(m){
    return { pedido: m[1], cliente: m[2].trim(), rest: lines.slice(1).join("\n") };
  }
  return { pedido:"", cliente:"", rest: lines.join("\n") };
}

function _normText(t){
  return String(t||"")
    .replace(/[‚Äú‚Äù"]/g,"")
    .replace(/\t/g," ")
    .replace(/[,\.;:]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

function _normalizeGrade(tok){
  let t = String(tok||"").toUpperCase().trim();
    if(t === "4XG" || t === "4X") t = "4XGG";
  if(t === "XG") t = "XG"; // keep
  if(t === "XGG") t = "XGG";
  return t;
}

function _isGrade(tok){
  const t = String(tok||"").toUpperCase().trim();
  return ["PP","P","M","G","GG","XG","XGG","2XGG","3XGG","4XGG","EG","EGG","UN","U"].includes(t) || /^\d{2}$/.test(t) || /^\d{2}(PP|P|M|G|GG|XG|XGG|EG|EGG)$/.test(t);
}

function _tokenizeManual(text){
  return _normText(text).split(" ").filter(Boolean);
}

function _splitJoinedQtyGrade(tok){
  const t = String(tok||"").toUpperCase().trim();
  const m = t.match(/^(\d+)(PP|P|M|G|GG|XG|XGG|2XGG|3XGG|4XGG|EG|EGG)$/);
  if(!m) return null;
  return { qty: parseInt(m[1],10), grade: m[2] };
}

function _detectColorAndRemove(tokens){
  const up = tokens.map(t=>String(t||"").toUpperCase());
  const baseColors = new Set(["PRETO","BRANCO","VERDE","AZUL","VERMELHO","AMARELO","ROSA","LARANJA","CINZA","MARROM","BEGE","NATURAL","OFFWHITE","OFF-WHITE"]);
  const mods = new Set(["MILITAR","MARINHO","NEON","OURO","CLARO","ESCURO"]);
  for(let i=0;i<up.length;i++){
    if(baseColors.has(up[i])){
      let color = up[i];
      let rm = [i];
      if(i+1<up.length && mods.has(up[i+1])){
        color = (up[i] + " " + up[i+1]).trim();
        rm = [i,i+1];
      }
      const cleaned = tokens.filter((_,idx)=>!rm.includes(idx));
      return { color, tokens: cleaned };
    }
  }
  return { color:"PRETO", tokens };
}

function _detectGenderAndRemove(tokens){
  const up = tokens.map(t=>String(t||"").toUpperCase());
  for(let i=0;i<up.length;i++){
    if(["MASCULINO","FEMININO","INFANTIL","UNISSEX"].includes(up[i])){
      const gender = up[i].charAt(0) + up[i].slice(1).toLowerCase();
      const cleaned = tokens.filter((_,idx)=>idx!==i);
      return { gender, tokens: cleaned };
    }
  }
  return { gender:"", tokens };
}

function _removeNoiseWords(arr){
  const stop = new Set(["E","DE","DA","DO","DAS","DOS","PRA","PRO","PARA","O","A","OS","AS","NO","NA","NOS","NAS","LINHA"]);
  return arr.filter(w => !stop.has(String(w||"").toUpperCase()));
}

function _parseManualItems(text){
  const toks = _tokenizeManual(text);
  const items = [];
  let cur = { defaultQty:null, nameTokens:[], pairs:[] };

  function flush(){
    const name = _normText(_removeNoiseWords(cur.nameTokens).join(" "));
    if(name || cur.pairs.length){
      items.push({ name, pairs: cur.pairs.slice(), defaultQty: cur.defaultQty || 1 });
    }
    cur = { defaultQty:null, nameTokens:[], pairs:[] };
  }

  for(let i=0;i<toks.length;i++){
    const tok = toks[i];
    const next = toks[i+1];

    // ‚úÖ remo√ß√£o de item: se tiver "nao vai", "n√£o vai", "retirar", "remover", "tira"
    const upTok = String(tok||"").toUpperCase();
    const upNext = String(next||"").toUpperCase();
    if(upTok === "NAO" || upTok === "N√ÉO"){
      if(upNext === "VAI"){
        cur.neg = true;
        continue;
      }
    }
    if(upTok === "RETIRAR" || upTok === "REMOVER" || upTok === "TIRAR" || upTok === "TIRA" || upTok === "CANCELAR"){
      cur.neg = true;
      continue;
    }

    const joined = _splitJoinedQtyGrade(tok);
    if(joined){
      cur.pairs.push(joined);
      continue;
    }

    const isNum = /^\d+$/.test(tok);
    const tokIsGrade = _isGrade(tok);

    if(isNum && next && _isGrade(next)){
      cur.pairs.push({ qty: parseInt(tok,10), grade: String(next).toUpperCase() });
      i++;
      continue;
    }

    if(tokIsGrade && next && /^\d+$/.test(next)){
      cur.pairs.push({ qty: parseInt(next,10), grade: String(tok).toUpperCase() });
      i++;
      continue;
    }

    if(tokIsGrade){
      const q = cur.defaultQty ? cur.defaultQty : 1;
      cur.pairs.push({ qty: q, grade: String(tok).toUpperCase() });
      continue;
    }

    if(isNum){
      const n = parseInt(tok,10);
      const nextIsGrade = next && (_isGrade(next) || _splitJoinedQtyGrade(next));
      if(!nextIsGrade){
        if(cur.nameTokens.length || cur.pairs.length){
          flush();
        }
        cur.defaultQty = n;
        continue;
      }
    }

    if(String(tok).toUpperCase()==="E"){
      const n1 = toks[i+1];
      const n2 = toks[i+2];

      // caso: "e 1 xgg" => mais um tamanho do MESMO item
      if(n1 && /^\d+$/.test(n1) && n2 && _isGrade(n2)){
        cur.pairs.push({ qty: parseInt(n1,10), grade: _normalizeGrade(n2) });
        i += 2; // consume "1 xgg"
        continue;
      }

      // caso: "e xgg 1" => mais um tamanho do MESMO item
      if(n1 && _isGrade(n1) && n2 && /^\d+$/.test(n2)){
        cur.pairs.push({ qty: parseInt(n2,10), grade: _normalizeGrade(n1) });
        i += 2; // consume "xgg 1"
        continue;
      }

      // caso: "e 2XGG" (colado) => mais um tamanho do MESMO item
      const joined = n1 ? _splitJoinedQtyGrade(n1) : null;
      if(joined){
        cur.pairs.push(joined);
        i += 1;
        continue;
      }

      // se for "e" seguido de n√∫mero que n√£o √© tamanho, a√≠ sim quebra item
      if(n1 && /^\d+$/.test(n1) && !(n2 && _isGrade(n2))){
        if(cur.nameTokens.length || cur.pairs.length){
          flush();
        }
        continue;
      }
    }

    cur.nameTokens.push(tok);
  }
  flush();
  return items;
}

async function importacaoRequisicaoManual(){
  try{
    loading(true, "Gerando TXT...");
    const texto = (document.getElementById("reqManualTexto")?.value || "").trim();
    if(!texto) return toast("warn","Manual","Cole ou digite o texto da requisi√ß√£o.");

    const extra = _extractPedidoCliente(texto);
    const pedidoInp = (document.getElementById("reqManualPedido")?.value || "").trim();
    const clienteInp = (document.getElementById("reqManualCliente")?.value || "").trim();

    let pedido = pedidoInp || extra.pedido || ("MANUAL-" + Date.now());
    let cliente = clienteInp || extra.cliente || "";

    const corpo = _normText(extra.rest || texto);

    const parsed = _parseManualItems(corpo);

    const itens = [];
    for(const it of parsed){
      if(!it.name) continue;

      // cor e sexo s√£o ATRIBUTOS de grade, n√£o entram no c√≥digo do produto
      let tks = _tokenizeManual(it.name);
      const genderInfo = _detectGenderAndRemove(tks);
      tks = genderInfo.tokens;
      const colorInfo = _detectColorAndRemove(tks);
      tks = colorInfo.tokens;

      const nomeProduto = _normText(_removeNoiseWords(tks).join(" "));
      if(!nomeProduto) continue;

      const codigo = await mapearOuCadastrar(nomeProduto);
      const schema = await getGradeSchema(codigo);

      // base g1/g2/g3
      const base = { g1:"", g2:"", g3:"" };
      const setCol = (col, val)=>{
        if(!val) return;
        if(col===1) base.g1 = val;
        else if(col===2) base.g2 = val;
        else if(col===3) base.g3 = val;
      };
      const corGrade = await normalizarCorParaGrade(colorInfo.color || "Preto");
      setCol(schema.colorCol, corGrade);
      if(schema.genderCol){
        const sexoGrade = await normalizarSexoParaGrade(genderInfo.gender || "Masculino");
        setCol(schema.genderCol, sexoGrade);
      }

      const pairs = (it.pairs||[]).length ? it.pairs : [{qty: it.defaultQty || 1, grade:""}];

      for(const p of pairs){
        const g = { ...base };
        const gradeVal = String(p.grade||"").toUpperCase().trim();
        if(gradeVal){
          if(schema.sizeCol===1) g.g1 = gradeVal;
          else if(schema.sizeCol===2) g.g2 = gradeVal;
          else g.g3 = gradeVal;
        }
        itens.push({ codigo, k5:g.g1, k6:g.g2, k7:g.g3, qtd: formatQtdTxtFromNum(p.qty) });
      }
    }

    if(!itens.length){
      return toast("warn","Manual","N√£o consegui identificar itens. Exemplos: 'jaqueta canguru 2 EGG' ou 'EGG 2 jaqueta canguru'.");
    }

    const hoje = dataHoje_ptBR();
    const requisitante = await getRequisitantePorUsuario(USUARIO_LOGADO);

    const out = [];
    out.push(["R",hoje,"1","1",requisitante,"27",`${pedido}  -  ${cliente}`.trim(),pedido,"0","0"].join("|"));

    for(const it of itens){
      const local = await getLocalPorItem(it.codigo);
      out.push(["I","P",it.codigo,it.k5||"",it.k6||"",it.k7||"",it.qtd,"3",local||""].join("|"));
    }

    baixarComoTXT("importacao_requisicao_manual", out.join("\n"));
    toast("ok","Manual","TXT gerado.");
  }catch(err){
    toast("danger","Erro", err.message || String(err));
  }finally{
    loading(false);
  }
}

/* ADMIN */
async function adminRecarregar(){
  try{
    const res = await api("admin_listarUsuarios", USUARIO_LOGADO);
    if(!res.ok) return toast("danger","Admin", res.msg || "Sem permiss√£o");

    ADMIN_USERS = Array.isArray(res.usuarios) ? res.usuarios : [];

    // select de email (mantido)
    const selEmail = $("admEmailUser");
    selEmail.innerHTML="";
    ADMIN_USERS.forEach(u=>{
      const op=document.createElement("option");
      op.value=u.usuario;

      const isBlocked = (String(u.nivel||"").toUpperCase()==="BLOQUEADO")
        || (String(u.perms?.transferencia||"").toUpperCase()==="BLOQUEAR"
            && String(u.perms?.zeramento||"").toUpperCase()==="BLOQUEAR"
            && String(u.perms?.requisicao||"").toUpperCase()==="BLOQUEAR"
            && String(u.perms?.aba164||"").toUpperCase()==="BLOQUEAR");

      op.textContent = isBlocked ? `üîí ${u.usuario}` : u.usuario;
      selEmail.appendChild(op);
    });

    renderAdminPermEditor();

  }catch(err){
    toast("danger","Erro", err.message);
  }
}

function renderAdminPermEditor(){
  const wrap = $("adminPermsWrap");
  wrap.innerHTML = "";

  if(!ADMIN_USERS.length){
    wrap.innerHTML = `<div class="subhint">Nenhum usu√°rio encontrado.</div>`;
    return;
  }

  const rowTop = document.createElement("div");
  rowTop.className = "actions";
  rowTop.style.gap = "10px";

  const selUser = document.createElement("select");
  selUser.style.minWidth = "240px";

  ADMIN_USERS.forEach(u=>{
    const op = document.createElement("option");
    op.value = u.usuario;

    const isBlocked = (String(u.nivel||"").toUpperCase()==="BLOQUEADO")
      || (String(u.perms?.transferencia||"").toUpperCase()==="BLOQUEAR"
          && String(u.perms?.zeramento||"").toUpperCase()==="BLOQUEAR"
          && String(u.perms?.requisicao||"").toUpperCase()==="BLOQUEAR"
            && String(u.perms?.aba164||"").toUpperCase()==="BLOQUEAR");

    op.textContent = isBlocked ? `üîí ${u.usuario}` : u.usuario;
    selUser.appendChild(op);
  });

  if(ADMIN_SELECTED){
    selUser.value = ADMIN_SELECTED;
  } else {
    ADMIN_SELECTED = ADMIN_USERS[0].usuario;
    selUser.value = ADMIN_SELECTED;
  }

  selUser.onchange = () => {
    ADMIN_SELECTED = selUser.value;
    renderAdminPermForm();
  };

  rowTop.appendChild(selUser);
  wrap.appendChild(rowTop);

  const formBox = document.createElement("div");
  formBox.id = "adminPermForm";
  formBox.style.marginTop = "10px";
  wrap.appendChild(formBox);

  renderAdminPermForm();
}

function renderAdminPermForm(){
  const form = document.getElementById("adminPermForm");
  if(!form) return;

  const u = ADMIN_USERS.find(x => String(x.usuario) === String(ADMIN_SELECTED)) || ADMIN_USERS[0];

  const isBlocked = (String(u.nivel||"").toUpperCase()==="BLOQUEADO")
    || (String(u.perms?.transferencia||"").toUpperCase()==="BLOQUEAR"
        && String(u.perms?.zeramento||"").toUpperCase()==="BLOQUEAR"
        && String(u.perms?.requisicao||"").toUpperCase()==="BLOQUEAR"
            && String(u.perms?.aba164||"").toUpperCase()==="BLOQUEAR");

  form.innerHTML = "";

  const header = document.createElement("div");
  header.innerHTML = `<b>${isBlocked ? "üîí " : ""}${u.usuario}</b> <span style="color:var(--muted); font-size:12px;">(${u.nivel})</span>`;
  form.appendChild(header);

  const rowNivel = document.createElement("div");
  rowNivel.className = "actions";
  rowNivel.style.gap = "10px";

  const selNivel = document.createElement("select");
  ["USER","CONSULTA","ADMIN","BLOQUEADO"].forEach(n=>{
    const op=document.createElement("option");
    op.value=n;
    op.textContent=n;
    if(String(u.nivel||"USER").toUpperCase()===n) op.selected=true;
    selNivel.appendChild(op);
  });

  rowNivel.appendChild(selNivel);
  form.appendChild(rowNivel);

  function makePermSelect(label, val){
    const wrapSel = document.createElement("div");
    wrapSel.style.minWidth = "160px";

    const lb = document.createElement("div");
    lb.style.fontSize = "12px";
    lb.style.color = "var(--muted)";
    lb.style.marginBottom = "6px";
    lb.textContent = label;

    const sel = document.createElement("select");
    ["EDITAR","VISUALIZAR","BLOQUEAR"].forEach(p=>{
      const op=document.createElement("option");
      op.value=p; op.textContent=p;
      if(String(val||"EDITAR").toUpperCase()===p) op.selected=true;
      sel.appendChild(op);
    });

    wrapSel.appendChild(lb);
    wrapSel.appendChild(sel);
    return {wrapSel, sel};
  }

  const rowPerm = document.createElement("div");
  rowPerm.className = "actions";
  rowPerm.style.gap = "10px";

  const pT = makePermSelect("Transfer√™ncia", u.perms?.transferencia);
  const pZ = makePermSelect("Zeramento",     u.perms?.zeramento);

  // Requisi√ß√µes granular (Pedidos / Manual) - fallback para u.perms?.requisicao
  const pRP = makePermSelect("Req. Pedidos", u.perms?.requisicaoPedidos ?? u.perms?.requisicao);
  const pRM = makePermSelect("Req. Manual",  u.perms?.requisicaoManual  ?? u.perms?.requisicao);

  const p164 = makePermSelect("164",      u.perms?.aba164);
  const pES  = makePermSelect("Entrada x Sa√≠da",  u.perms?.entradaSaida);
  const pP   = makePermSelect("Produ√ß√£o",         u.perms?.producao);

  rowPerm.appendChild(pT.wrapSel);
  rowPerm.appendChild(pZ.wrapSel);
  rowPerm.appendChild(pRP.wrapSel);
  rowPerm.appendChild(pRM.wrapSel);
  rowPerm.appendChild(p164.wrapSel);
  rowPerm.appendChild(pES.wrapSel);
  rowPerm.appendChild(pP.wrapSel);
  form.appendChild(rowPerm);

  const rowBtn = document.createElement("div");
  rowBtn.className = "actions";

  const btnSalvar = document.createElement("button");
  btnSalvar.className = "btn btn-primary";
  btnSalvar.style.width = "auto";
  btnSalvar.textContent = "Salvar";

  btnSalvar.onclick = async () => {
    try{
      loading(true, "Salvando permiss√µes...");
      const r = await api(
        "admin_salvarPermissoes",
        USUARIO_LOGADO,
        u.usuario,
        selNivel.value,
        pT.sel.value,
        pZ.sel.value,

        // compat antigo: requisicao (um s√≥) ‚Äì se pedidos/manual iguais, usa o mesmo; se diferente, usa EDITAR
        (pRP.sel.value === pRM.sel.value ? pRP.sel.value : "EDITAR"),
        p164.sel.value,

        // novos (granular)
        pRP.sel.value,   // requisicaoPedidos
        pRM.sel.value,   // requisicaoManual
        pES.sel.value,   // entradaSaida
        pP.sel.value     // producao
      );
      toast(r.ok ? "ok" : "danger", "Admin", r.ok ? "Salvo!" : (r.msg || "Erro"));
      if(r.ok) await adminRecarregar();
    }catch(err){
      toast("danger","Erro", err.message);
    }finally{
      loading(false);
    }
  };

  rowBtn.appendChild(btnSalvar);
  form.appendChild(rowBtn);

  const hint = document.createElement("div");
  hint.className = "subhint";
  hint.textContent = "Dica: selecione NIVEL = BLOQUEADO para impedir o login (cadeado).";
  form.appendChild(hint);
}

async function adminSalvarEmail(){
  try{
    const alvo=$("admEmailUser").value;
    const novo=$("admEmailNovo").value;
    const r=await api("admin_alterarEmail", USUARIO_LOGADO, alvo, novo);
    toast(r.ok?"ok":"danger","Admin", r.ok ? "Email atualizado!" : (r.msg||"Erro"));
  }catch(err){
    toast("danger","Erro",err.message);
  }
}

$("usuario").addEventListener("keyup",(e)=>{ if(e.key==="Enter") entrar(); });
$("senha").addEventListener("keyup",(e)=>{ if(e.key==="Enter") entrar(); });

$("appVersion").textContent = "v" + APP_VERSION;
trocarView("login");
init164();
initProducao();

// ‚úÖ PWA (GitHub Pages em /sistema-pwa/)
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sistema-pwa/sw.js").catch(console.log);
}


/* =========================
   ‚úÖ Entrada x Sa√≠da (Produ√ß√£o) - 2 planilhas (layout do 164)
   - Planilha A: Entrada (componentes)
   - Planilha B: Sa√≠da (produto final)
   - Regra: 3 por 1 (Sa√≠da √ó 3 = Esperado na Entrada) por NOME + GRADES
   - Mostra erros com ‚Äúonde deu erro‚Äù
   ========================= */

let _prodMore = false;

function initProducao(){
  const a = document.querySelector("#tblProdA tbody");
  const b = document.querySelector("#tblProdB tbody");
  if(a) criarTabelaCustom(a, 12, 7);
  if(b) criarTabelaCustom(b, 12, 7);
  const r = document.getElementById("prod_tbody"); if(r) r.innerHTML="";
  const e = document.getElementById("prod_err_tbody"); if(e) e.innerHTML="";
  const st = document.getElementById("prod_status"); if(st) st.textContent="‚Äî";
}

function prodToggleMore(){
  const wrap = document.getElementById("wrapProdInputs");
  // Se inputs estiverem escondidos (ap√≥s conferir), mostra de volta
  if(wrap && (wrap.style.display === "none")){
    wrap.style.display = "block";
    toast("ok","Produ√ß√£o","Mostrando as planilhas.");
    return;
  }

  _prodMore = !_prodMore;
  const h = _prodMore ? 260 : 150;
  const a = document.getElementById("prodWrapA");
  const b = document.getElementById("prodWrapB");
  if(a) a.style.maxHeight = h+"px";
  if(b) b.style.maxHeight = h+"px";

  const btns = [...document.querySelectorAll('#producao .actions .btn')];
  const btn = btns.find(x => (x.textContent||"").toLowerCase().includes("mostrar"));
  if(btn) btn.textContent = _prodMore ? "Mostrar menos" : "Mostrar mais";
}

function prodLimpar(){
  initProducao();
  toast("ok","Produ√ß√£o","Limpo.");
}

function _prodNormName(s){
  return String(s||"")
    .toUpperCase()
    .replace(/\s+/g," ")
    .trim();
}
function _prodKeyNome(nome,g1,g2,g3){
  return [_prodNormName(nome), String(g1||"").trim(), String(g2||"").trim(), String(g3||"").trim()].join("¬¶");
}

function _prodMapFromTable(tbodyEl){
  const map = new Map();
  if(!tbodyEl) return map;
  const rows = Array.from(tbodyEl.rows||[]);
  for(const tr of rows){
    const c = Array.from(tr.cells||[]).map(td => norm(td.innerText));
    // colunas esperadas: [local, codigo, nome, g1, g2, g3, qtd]
    const nome = c[2] || "";
    const g1 = c[3] || "";
    const g2 = c[4] || "";
    const g3 = c[5] || "";
    const qtd = normalizeQTD(c[6] || "0");
    if(!nome || !qtd) continue;

    const k = _prodKeyNome(nome,g1,g2,g3);
    map.set(k, (map.get(k)||0) + qtd);
  }
  return map;
}

function _prodRowsFromTable(tbodyEl){
  const out = [];
  if(!tbodyEl) return out;
  const rows = Array.from(tbodyEl.rows||[]);
  for(const tr of rows){
    const c = Array.from(tr.cells||[]).map(td => norm(td.innerText));
    const nome = c[2] || "";
    const g1 = c[3] || "";
    const g2 = c[4] || "";
    const g3 = c[5] || "";
    const qtd = normalizeQTD(c[6] || "0");
    if(!nome || !qtd) continue;
    out.push({nome, g1, g2, g3, qtd});
  }
  return out;
}


function _prodRenderTabelaResultado(rowsOut){
  const tb = document.getElementById("prod_tbody");
  if(!tb) return;
  tb.innerHTML="";
  const frag=document.createDocumentFragment();
  for(const r of rowsOut){
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.nome)}</td>
      <td>${escapeHtml(r.g1||"")}</td>
      <td>${escapeHtml(r.g2||"")}</td>
      <td>${escapeHtml(r.g3||"")}</td>
      <td>${formatQtdTxtFromNum(r.ent)}</td>
      <td>${formatQtdTxtFromNum(r.esp)}</td>
      <td style="font-weight:900;">${formatQtdTxtFromNum(r.dif)}</td>
    `;
    frag.appendChild(tr);
  }
  tb.appendChild(frag);
}

let _prodUltimosErrosTxt = "";

function _prodRenderErros(errRows){
  const tb = document.getElementById("prod_err_tbody");
  if(!tb) return;
  tb.innerHTML="";
  const frag=document.createDocumentFragment();
  const lines=[];
  for(const e of errRows){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(e.onde)}</td><td>${escapeHtml(e.item)}</td><td>${escapeHtml(e.det)}</td>`;
    frag.appendChild(tr);
    lines.push(`${e.onde}\t${e.item}\t${e.det}`);
  }
  tb.appendChild(frag);
  _prodUltimosErrosTxt = lines.join("\n");
  const badge = document.getElementById("prod_err_badge");
  if(badge) badge.textContent = String(errRows.length||0);
}

function prodBaixarErros(){
  if(!_prodUltimosErrosTxt){
    toast("warn","Produ√ß√£o","Sem erros para baixar.");
    return;
  }
  baixarComoTXT("erros_producao", _prodUltimosErrosTxt);
  toast("ok","Produ√ß√£o","Erros baixados.");
}


function prodAbrirErros(){
  const modal = document.getElementById("prodErrModal");
  if(!modal) return;
  modal.classList.remove("hidden");
  // garante foco no topo
  try{ modal.querySelector(".prod-modal")?.scrollTo({top:0}); }catch(e){}
}
function prodFecharErros(ev){
  // se chamado por click no overlay, fecha; se chamado por bot√£o, tamb√©m fecha
  const modal = document.getElementById("prodErrModal");
  if(!modal) return;
  modal.classList.add("hidden");
}


function prodConferir3por1(){
  try{
    const aBody = document.querySelector("#tblProdA tbody");
    const bBody = document.querySelector("#tblProdB tbody");
    const st = document.getElementById("prod_status");

    const sizeSet = new Set([
      "PP","P","M","G","GG","XG","XGG","EG","EGG","XXG","XXXG","XXXXG",
      "XPP","XP","XM","XG","XGG","XEG","XEGG"
    ]);

    const norm = (s)=>String(s||"")
      .toUpperCase()
      .replace(/\s+/g," ")
      .trim()
      .replaceAll("CALCA","CAL√áA")
      .replaceAll("GALPAO","GALP√ÉO");

    const parseNum = (v)=>{
      const t = String(v||"").trim().replace(/\./g,"").replace(",",".");
      const n = Number(t);
      return isNaN(n) ? 0 : n;
    };

    function rowToObj(cellTexts){
      const cells = cellTexts.map(x=>String(x||"").trim());
      // tira vazios do fim
      while(cells.length && !cells[cells.length-1]) cells.pop();
      if(cells.length < 3) return null;

      // qty = √∫ltimo n√∫mero
      const qty = parseNum(cells[cells.length-1]);
      if(!qty) return null;

      // detecta se tem "C√≥digo Local" (primeira coluna local num√©rico + segunda coluna c√≥digo)
      const c0 = cells[0] || "";
      const c1 = cells[1] || "";
      const isNum0 = c0 && !isNaN(Number(String(c0).replace(",", ".")));
      const isNum1 = c1 && !isNaN(Number(String(c1).replace(",", ".")));
      const looksLikeCode = (s)=>/^[0-9A-Z\/-]+$/i.test(String(s||"").trim()) && /\d/.test(String(s||""));

      // muitos relat√≥rios v√™m como: LOCAL (num) | C√ìDIGO (alfa-num) | NOME | ... | QTD
      const hasLocalCode = !!(isNum0 && (isNum1 || looksLikeCode(c1)) && cells.length >= 4);

      let code="", name="", attrsStart=0;
      if(hasLocalCode){
        code = cells[1];
        name = cells[2] || "";
        attrsStart = 3;
      }else{
        code = cells[0];
        name = cells[1] || "";
        attrsStart = 2;
      }
      if(!name) return null;

      // atributos entre name e qty
      const attrs = cells.slice(attrsStart, cells.length-1).filter(x=>String(x).trim()!=="").map(norm);

      let g1="", g2="", g3="";

      // g√™nero (grade1) e tamanho (grade2)
      for(const a of attrs){
        if(!g1 && (/\bMASCULINO\b/.test(a) || /\bFEMININO\b/.test(a))) g1 = a;
        if(!g2 && (sizeSet.has(a) || /^[PEXGM]{1,4}G?$/.test(a) || /^X{1,4}G$/.test(a) || /^E(GG?)$/.test(a) || /^XXG$/.test(a) || /^XXXG$/.test(a))) g2 = a;
      }

      // cor/grade3: pega a 1¬™ "coisa" que n√£o √© g√™nero nem tamanho (e junta cores de 2 palavras comuns)
      const others = [];
      for(const a of attrs){
        if(/\bMASCULINO\b/.test(a) || /\bFEMININO\b/.test(a)) continue;
        if(a === g2) continue;
        if(sizeSet.has(a) || /^[PEXGM]{1,4}G?$/.test(a) || /^X{1,4}G$/.test(a) || /^E(GG?)$/.test(a) || /^XXG$/.test(a) || /^XXXG$/.test(a)) continue;
        others.push(a);
      }
      if(others.length){
        // tenta montar cores de 2 palavras (ex: AMARELO OURO)
        const o0 = others[0];
        const o1 = others[1] || "";
        if((o0==="AMARELO" && o1==="OURO") || (o0==="AZUL" && o1==="MARINHO") || (o0==="CINZA" && o1==="CLARO") || (o0==="CINZA" && o1==="ESCURO")){
          g3 = `${o0} ${o1}`.trim();
        }else{
          g3 = o0;
        }
      }

      return { code: norm(code), nome: norm(name), g1, g2, g3, qtd: qty };
    }

    function rowsFromTbody(tbody){
      const out=[];
      const rows = Array.from((tbody && tbody.rows) ? tbody.rows : []);
      for(const tr of rows){
        const cellTexts = Array.from(tr.cells||[]).map(td=>td.innerText);
        const obj = rowToObj(cellTexts);
        if(obj) out.push(obj);
      }
      return out;
    }

    const rowsEntrada = rowsFromTbody(aBody);
    const rowsSaida   = rowsFromTbody(bBody);

    if(!rowsEntrada.length) return toast("warn","Produ√ß√£o","Preencha/cole a Planilha A (Entrada).");
    if(!rowsSaida.length)   return toast("warn","Produ√ß√£o","Preencha/cole a Planilha B (Sa√≠da/Baixa).");

    const isManga = (nome)=>/\bMANGA\b/.test(norm(nome)) || /\bPAR DE MANGA\b/.test(norm(nome));

    // fam√≠lias mais comuns
    const familias = ["COMBATE","POP","ELITE","BRAVO","STORM","CORREIOS","PADR√ÉO","PADRAO","SANTA CRUZ","OCEANPACT"];
    const pickFamilia = (nome)=>{
      const n0 = norm(nome);
      const n = n0.replace(/\s+/g,' ').trim();
      for(const f of familias){
        const ff = norm(f).replace(/\s+/g,' ').trim();
        if(!ff) continue;
        // match por palavra (ex: '... - COMBATE ...')
        const esc = ff.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&');
        const rx = new RegExp('(^|[^A-Z√Ä-√ö0-9])'+esc+'([^A-Z√Ä-√ö0-9]|$)');
        if(rx.test(n)) return ff;
        if(n.includes(ff)) return ff;
      }
      return "";
    };

    // entrada agregada por key (nome + grades; grades vazias viram coringa '*')
    const mEntrada = new Map();
    const entradaNames = new Set();
    for(const r of rowsEntrada){
      const nome = norm(r.nome);
      entradaNames.add(nome);
      const g1 = norm(r.g1);
      const g2 = norm(r.g2);
      const g2k = g2 ? g2 : "*";
      const g3 = norm(r.g3);
      const g1k = g1 ? g1 : "*";
      const g3k = g3 ? g3 : "*";
      const k = `${nome}¬¶${g1k}¬¶${g2k}¬¶${g3k}`;
      mEntrada.set(k, (mEntrada.get(k)||0) + r.qtd);
    }

    // helper: score simples por match de tokens
    const tokenize = (s)=> norm(s).split(/[^A-Z√Ä-√ö0-9]+/).filter(t=>t && t.length>1);
    const scoreName = (candidate, outNome, familia, categoria)=>{
      const c = norm(candidate);
      let s = 0;
      if(familia && c.includes(familia)) s += 100;
      if(categoria && c.includes(categoria)) s += 50;
      const outT = new Set(tokenize(outNome));
      for(const t of tokenize(c)){ if(outT.has(t)) s += 3; }
      return s;
    };

    function findComponentName(outRow, categoria){
  const familia = pickFamilia(outRow.nome);
  const outNome = norm(outRow.nome);

  let bestName = "";
  let bestScore = -1;

  // prefer√™ncias por categoria (pra bater com seu exemplo: CORPO CAL√áA / CORTE JAQUETA / MANGA JAQUETA)
  const prefer = {
    "CAL√áA": [/\bCORPO\s+CAL√áA\b/, /\bCORPO\s+DA\s+CAL√áA\b/, /\bCAL√áA\b/],
    "JAQUETA": [/\bCORTE\s+JAQUETA\b/, /\bJAQUETA\b/],
    "MANGA": [/\bMANGA\s+JAQUETA\b/, /\bPAR\s+DE\s+MANGA\b/, /\bMANGA\b/]
  };

  const prefs = prefer[categoria] || [new RegExp("\\b"+categoria+"\\b")];

  for(const n of entradaNames){
    const nn = norm(n);

    // categoria b√°sica
    if(!prefs.some(rx => rx.test(nn))) continue;

    // combate consome combate (mesma fam√≠lia)
    if(familia && !nn.includes(familia)) continue;

    let sc = scoreName(nn, outNome, familia, categoria);

    // b√¥nus por casar com a prefer√™ncia mais forte
    if(prefs[0] && prefs[0].test(nn)) sc += 80;
    else if(prefs[1] && prefs[1].test(nn)) sc += 40;

    if(sc > bestScore){
      bestScore = sc;
      bestName = nn;
    }
  }
  return bestName;
}
    // lookup na entrada com suporte a coringa '*' (quando o item da Entrada n√£o tem grade preenchida)
    function entradaQty(nome, g1, g2, g3){
      const n = norm(nome);
      const a = g1 ? norm(g1) : "";
      const b = g2 ? norm(g2) : "";
      const c = g3 ? norm(g3) : "";

      const keys = [
        `${n}¬¶${a}¬¶${b}¬¶${c}`,
        `${n}¬¶${a}¬¶${b}¬¶*`,
        `${n}¬¶${a}¬¶*¬¶${c}`,
        `${n}¬¶*¬¶${b}¬¶${c}`,
        `${n}¬¶${a}¬¶*¬¶*`,
        `${n}¬¶*¬¶${b}¬¶*`,
        `${n}¬¶*¬¶*¬¶${c}`,
        `${n}¬¶*¬¶*¬¶*`
      ];

      let sum = 0;
      for(const k of keys){
        const v = mEntrada.get(k);
        if(v) sum += v;
      }
      return sum;
    }




    // esperado por key (nomeComp + grades herdadas do output)
    const esperado = new Map();
    const errRows = [];

    for(const out of rowsSaida){
      const qOut = out.qtd || 0;
      if(qOut<=0) continue;

      const fam = pickFamilia(out.nome);
      // se n√£o achar fam√≠lia, segue mesmo assim (n√£o bloqueia)

      const compCalca  = findComponentName(out, "CAL√áA");
      const compJaq    = findComponentName(out, "JAQUETA");
      const compManga  = findComponentName(out, "MANGA");

      if(!compCalca) errRows.push({onde:"Mapeamento", item:`${out.nome} (${[out.g1,out.g2,out.g3].filter(Boolean).join(" / ")})`, det:"N√£o achei CAL√áA da mesma fam√≠lia na Entrada"});
      if(!compJaq)   errRows.push({onde:"Mapeamento", item:`${out.nome} (${[out.g1,out.g2,out.g3].filter(Boolean).join(" / ")})`, det:"N√£o achei JAQUETA da mesma fam√≠lia na Entrada"});
      if(!compManga) errRows.push({onde:"Mapeamento", item:`${out.nome} (${[out.g1,out.g2,out.g3].filter(Boolean).join(" / ")})`, det:"N√£o achei MANGA da mesma fam√≠lia na Entrada"});

      const add = (nomeComp, categoria)=>{
        if(!nomeComp) return;
        const nome = norm(nomeComp);
        const g1 = norm(out.g1);
        const g2 = norm(out.g2);
        // ‚úÖ s√≥ ignora grade quando o componente na Entrada n√£o tiver (a√≠ ele foi salvo como '*')
        const g3 = norm(out.g3);
        const g1k = g1 ? g1 : "*";
        const g2k = g2 ? g2 : "*";
        const g3k = g3 ? g3 : "*";
        const k = `${nome}¬¶${g1k}¬¶${g2k}¬¶${g3k}`;
        esperado.set(k, (esperado.get(k)||0) + qOut);
      };

      // 3 por 1 (1 cal√ßa + 1 jaqueta + 1 manga)
      add(compCalca,"CAL√áA");
      add(compJaq,"JAQUETA");
      add(compManga,"MANGA");
    }

    const keys = new Set([...mEntrada.keys(), ...esperado.keys()]);
    const rowsOut=[];
    for(const k of keys){
      const [nome,g1,g2,g3] = k.split("¬¶");
      const ent = entradaQty(nome, g1, g2, g3);
      const esp = esperado.get(k)||0;
      const dif = ent - esp;
      rowsOut.push({nome, g1, g2, g3, ent, esp, dif});

            if(esp!==0 && ent===0){
        errRows.push({onde:"Entrada", item:`${nome} (${[g1,g2,g3].filter(Boolean).join(" / ")})`, det:`Faltou entrada (esperado ${formatQtdTxtFromNum(esp)})`});
      }else if(Math.abs(dif) > 1e-9){
const det = dif>0
          ? `Sobra ${formatQtdTxtFromNum(dif)} (Entrada ${formatQtdTxtFromNum(ent)} vs Esperado ${formatQtdTxtFromNum(esp)})`
          : `Falta ${formatQtdTxtFromNum(Math.abs(dif))} (Entrada ${formatQtdTxtFromNum(ent)} vs Esperado ${formatQtdTxtFromNum(esp)})`;
        errRows.push({onde:"Confer√™ncia", item:`${nome} (${[g1,g2,g3].filter(Boolean).join(" / ")})`, det});
      }
    }

    rowsOut.sort((a,b)=> (a.nome||"").localeCompare(b.nome||"", "pt-BR") || (a.g2||"").localeCompare(b.g2||"", "pt-BR"));

    _prodRenderTabelaResultado(rowsOut);

    // erros √∫nicos
    const uniq = new Set();
    const errUniq = [];
    for(const e of errRows){
      const key = `${e.onde}¬¶${e.item}¬¶${e.det}`;
      if(uniq.has(key)) continue;
      uniq.add(key);
      errUniq.push(e);
    }
    _prodRenderErros(errUniq);
    if(errUniq.length>0) prodAbrirErros();

    const totalSaida = rowsSaida.reduce((s,r)=>s+(r.qtd||0),0);
    const totalEsperado = Array.from(esperado.values()).reduce((s,v)=>s+v,0);
    const ok3 = Math.abs(totalEsperado - (totalSaida*3)) < 1e-9;

    const msg3 = ok3
      ? `Regra 3 por 1 OK (Esperado total ${formatQtdTxtFromNum(totalEsperado)} = Sa√≠da total ${formatQtdTxtFromNum(totalSaida)} √ó 3)`
      : `Aten√ß√£o: regra 3 por 1 n√£o fechou (Esperado total ${formatQtdTxtFromNum(totalEsperado)} vs Sa√≠da total ${formatQtdTxtFromNum(totalSaida)} √ó 3 = ${formatQtdTxtFromNum(totalSaida*3)})`;

    if(errUniq.length===0){
      st.innerHTML = `‚úÖ Bateu! ${msg3}`;
      toast("ok","Produ√ß√£o","Confer√™ncia OK.");
    }else{
      st.innerHTML = `‚ö† Encontramos ${errUniq.length} item(ns) com diverg√™ncia. ${msg3}`;
      toast("warn","Produ√ß√£o","H√° diverg√™ncias. Veja a tabela de erros.");
    }

  }catch(err){
    console.error(err);
    const box = document.getElementById("prod_errorBox");
    const pre = document.getElementById("prod_errorText");
    const msg = (err && err.stack) ? err.stack : String(err);
    if(pre) pre.textContent = msg;
    if(box) box.style.display = "block";
    const st = document.getElementById("prod_status");
    if(st) st.innerHTML = "‚ùå Ocorreu um erro ao conferir. Veja os detalhes abaixo.";
    toast("danger","Produ√ß√£o","Erro ao conferir. Detalhes exibidos na tela.");
  }
}



/* ===== Global error handler: mostra erro na tela (sem console) ===== */
(function(){
  function showGlobalErr(msg, stack){
    try{
      var box = document.getElementById("prod_errorBox");
      var pre = document.getElementById("prod_errorText");
      var st  = document.getElementById("prod_status");
      if(pre) pre.textContent = (stack ? (msg+"\n\n"+stack) : msg);
      if(box) box.style.display = "block";
      if(st) st.innerHTML = "‚ùå Ocorreu um erro. Detalhes exibidos abaixo.";
      // tenta abrir modal de erros tamb√©m, se existir
      if(typeof prodAbrirErros === "function"){ /* noop */ }
    }catch(e){}
  }

  window.addEventListener("error", function(ev){
    var msg = (ev && ev.message) ? String(ev.message) : "Erro desconhecido";
    var stack = ev && ev.error && ev.error.stack ? String(ev.error.stack) : "";
    showGlobalErr(msg, stack);
  });

  window.addEventListener("unhandledrejection", function(ev){
    var msg = "Promise rejeitada sem tratamento";
    var stack = "";
    if(ev && ev.reason){
      if(typeof ev.reason === "string") msg = ev.reason;
      else {
        msg = ev.reason.message || msg;
        stack = ev.reason.stack || "";
      }
    }
    showGlobalErr(msg, stack);
  });

  // garante que a fun√ß√£o do bot√£o existe (evita "n√£o definida")
  document.addEventListener("DOMContentLoaded", function(){
    try{
      if(typeof window.prodConferir3por1 !== "function" && typeof prodConferir3por1 === "function"){
        window.prodConferir3por1 = prodConferir3por1;
      }
    }catch(e){}
  });
})();

</script>

<!-- Modal de Erros (Produ√ß√£o) -->
<div id="prodErrModal" class="hidden">
  <div class="prod-modal-overlay" onclick="prodFecharErros(event)">
    <div class="prod-modal" onclick="event.stopPropagation()">
      <div class="prod-modal-header">
        <div class="prod-modal-title">Erros da Confer√™ncia</div>
        <button class="prod-modal-close" aria-label="Fechar" onclick="prodFecharErros()">‚úï</button>
      </div>

      <div class="subhint" style="margin-top:0;">
        Itens que n√£o batem, ou que aparecem s√≥ em uma das planilhas.
      </div>

      <div class="sheet-wrap" style="margin-top:10px; overflow:hidden;">
        <table class="sheet" style="width:100%;">
          <thead>
            <tr>
              <th>Onde</th>
              <th>Item</th>
              <th>Detalhe</th>
            </tr>
          </thead>
          <tbody id="prod_err_tbody"></tbody>
        </table>
      </div>

      <div class="actions" style="margin-top:10px;">
        <button class="btn btn-ghost" onclick="prodBaixarErros()">Baixar erros (TXT)</button>
        <button class="btn btn-primary" onclick="prodFecharErros()">Fechar</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
