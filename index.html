<!DOCTYPE html>
<html lang="pt-BR">
<head>
<base target="_top">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sistema</title>

<style>
:root{
  --primary:#2c1a4d;
  --secondary:#6a4bc9;
  --bg:#f3f5fb;
  --card:#ffffff;
  --text:#1f2430;
  --muted:#667085;
  --line:#e5e7ee;
  --shadow: 0 10px 30px rgba(16,24,40,.10);
  --shadow2: 0 6px 18px rgba(16,24,40,.08);
  --ok:#12b76a;
  --warn:#f79009;
  --danger:#f04438;
  --radius:16px;
}
.dark{
  --bg:#0f1116;
  --card:#171a22;
  --text:#f3f4f6;
  --muted:#a7afbd;
  --line:#2a2f3a;
  --shadow: 0 12px 30px rgba(0,0,0,.45);
  --shadow2: 0 8px 18px rgba(0,0,0,.35);
}

/* ‚úÖ BLOQUEIA ‚ÄúROLAGEM/BORRACHA‚Äù NO SITE TODO */
html,body{
  height:100%;
  overscroll-behavior: none;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  overflow:hidden;             /* ‚úÖ sem scroll da p√°gina */
  position:fixed;              /* ‚úÖ impede ‚Äúarrastar‚Äù/bounce */
  inset:0;
}

*{ box-sizing:border-box; font-family:Segoe UI,Inter,Arial,sans-serif; }
.hidden{display:none;}

/* ---------- Toast ---------- */
.toast{
  position:fixed;
  right:16px;
  bottom:16px;
  background:var(--card);
  border:1px solid var(--line);
  box-shadow:var(--shadow2);
  padding:12px 14px;
  border-radius:14px;
  display:flex;
  gap:10px;
  align-items:flex-start;
  max-width:min(420px, calc(100vw - 32px));
  opacity:0;
  transform:translateY(10px);
  pointer-events:none;
  transition:all .18s ease;
  z-index:9999;
}
.toast.show{ opacity:1; transform:translateY(0); }
.toast .dot{ width:10px; height:10px; border-radius:999px; margin-top:4px; background:var(--secondary); }
.toast.ok .dot{ background:var(--ok); }
.toast.warn .dot{ background:var(--warn); }
.toast.danger .dot{ background:var(--danger); }
.toast .t-title{ font-weight:800; font-size:13px; }
.toast .t-msg{ font-size:12px; color:var(--muted); margin-top:2px; white-space:pre-wrap; }

/* ---------- Login (sem scroll) ---------- */
.login{
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
}
.login-card{
  width:min(440px, 100%);
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:28px;
  animation:fade .22s ease;
}
@keyframes fade{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
.brand{ display:flex; align-items:center; gap:12px; margin-bottom:14px; }
.logo{
  width:44px; height:44px; border-radius:16px;
  background:linear-gradient(135deg,var(--secondary),var(--primary));
  box-shadow:0 10px 24px rgba(106,75,201,.25);
}
.brand h2{ margin:0; font-size:18px; }
.brand p{ margin:2px 0 0 0; font-size:12px; color:var(--muted); }

label{ display:block; font-size:12px; color:var(--muted); margin-top:12px; }
input,select,button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--card);
  color:var(--text);
  outline:none;
}
input:focus,select:focus{
  border-color:rgba(106,75,201,.55);
  box-shadow:0 0 0 4px rgba(106,75,201,.12);
}
.btn{
  border:none;
  cursor:pointer;
  font-weight:800;
  transition:transform .12s ease, opacity .12s ease;
}
.btn:hover{ opacity:.92; transform:translateY(-1px); }
.btn-primary{ background:linear-gradient(135deg,var(--secondary),var(--primary)); color:#fff; }
.btn-ghost{ background:transparent; border:1px solid var(--line); color:var(--text); }
.btn-danger{ background:var(--danger); color:#fff; }

.login-links{
  text-align:center;
  margin-top:12px;
  font-size:12px;
  color:var(--muted);
}
.login-links span{
  cursor:pointer;
  color:var(--secondary);
  margin:0 8px;
  user-select:none;
}
.login-links span:hover{ opacity:.85; }

.small{ font-size:12px; color:var(--muted); margin-top:10px; white-space:pre-wrap; }

/* ---------- App Shell (sem scroll) ---------- */
.app{
  height:100%;
  display:flex;
}

/* Sidebar fixa */
.sidebar{
  width:290px;
  background:linear-gradient(180deg, #24133f, #140b25);
  color:#fff;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.side-top{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 10px;
  background:rgba(255,255,255,.06);
  border-radius:16px;
}
.side-user{ display:flex; flex-direction:column; gap:2px; }
.side-user b{ font-size:13px; }
.side-user span{ font-size:12px; opacity:.8; }
.icon-btn{
  width:36px; height:36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;
  cursor:pointer;
  transition:transform .12s ease, opacity .12s ease;
}
.icon-btn:hover{ opacity:.92; transform:translateY(-1px); }

.nav{ display:flex; flex-direction:column; gap:8px; margin-top:6px; }
.nav .item{
  padding:12px 12px;
  border-radius:16px;
  background:rgba(255,255,255,.08);
  cursor:pointer;
  user-select:none;
  transition:transform .12s ease, background .12s ease;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.nav .item:hover{ background:rgba(255,255,255,.14); transform:translateY(-1px); }
.nav .item.active{ background:rgba(255,255,255,.22); }
.nav .item small{ opacity:.8; font-size:12px; }

.side-bottom{ margin-top:auto; display:flex; flex-direction:column; gap:10px; }

/* Main sem scroll: quem rola √© s√≥ a planilha */
.main{
  flex:1;
  height:100%;
  overflow:hidden;         /* ‚úÖ bloqueia scroll aqui tamb√©m */
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.topbar{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow2);
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex:0 0 auto;
}
.topbar .title{ display:flex; flex-direction:column; gap:2px; }
.topbar .title b{ font-size:14px; }
.topbar .title span{ font-size:12px; color:var(--muted); }
.pill{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(106,75,201,.06);
  font-size:12px;
}

/* Card ocupa o resto da tela e n√£o cria scroll geral */
.card{
  flex:1 1 auto;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow2);
  padding:16px;
  display:flex;
  flex-direction:column;
  min-height:0;            /* ‚úÖ important√≠ssimo para flex + overflow */
}
.card h2{ font-size:16px; margin:0 0 10px 0; }
.subhint{ font-size:12px; color:var(--muted); margin-top:10px; }

/* S√≥ aqui pode rolar */
.sheet-wrap{
  flex:1 1 auto;
  border:1px solid var(--line);
  border-radius:14px;
  overflow:auto;                  /* ‚úÖ √∫nico scroll permitido */
  -webkit-overflow-scrolling: touch;
  min-height:0;                   /* ‚úÖ */
}
table.sheet{ width:100%; border-collapse:collapse; }
.sheet thead th{
  position:sticky;
  top:0;
  background:linear-gradient(180deg, rgba(106,75,201,.10), rgba(106,75,201,.06));
  border-bottom:1px solid var(--line);
  padding:10px;
  font-size:12px;
  text-align:left;
  z-index:2;
}
.sheet td{
  border-top:1px solid var(--line);
  border-right:1px solid var(--line);
  padding:8px;
  min-width:130px;
  font-size:13px;
  vertical-align:top;
}
.sheet td:last-child{ border-right:none; }
.sheet td:focus{
  outline:none;
  background:rgba(106,75,201,.10);
  box-shadow: inset 0 0 0 2px rgba(106,75,201,.22);
}

.actions{
  display:flex;
  gap:10px;
  margin-top:12px;
  flex-wrap:wrap;
  flex:0 0 auto;
}
.actions .btn{ width:auto; padding:12px 16px; border-radius:14px; }
</style>
</head>

<body>

<!-- Toast -->
<div id="toast" class="toast">
  <div class="dot"></div>
  <div>
    <div class="t-title" id="toastTitle">Aviso</div>
    <div class="t-msg" id="toastMsg"></div>
  </div>
</div>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <div class="login-card">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h2>Sistema</h2>
        <p>Login e importa√ß√£o de arquivos</p>
      </div>
    </div>

    <label>Usu√°rio</label>
    <input id="usuario" placeholder="Digite seu usu√°rio" autocomplete="username">

    <label>Senha</label>
    <input id="senha" type="password" placeholder="Digite sua senha" autocomplete="current-password">

    <button class="btn btn-primary" onclick="entrar()">Entrar</button>

    <!-- ‚úÖ VOLTARAM A FUNCIONAR (calls showLogin) -->
    <div class="login-links">
      <span onclick="showLogin('cadastro')">Criar conta</span> |
      <span onclick="showLogin('recuperar')">Recuperar senha</span> |
      <span onclick="toggleSenha()">üëÅ Ver senha</span>
    </div>

    <div class="small" id="statusLogin"></div>
  </div>
</div>

<!-- CADASTRO -->
<div class="login hidden" id="cadastro">
  <div class="login-card">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h2>Criar conta</h2>
        <p>Cadastro r√°pido</p>
      </div>
    </div>

    <label>Usu√°rio</label>
    <input id="cUser" placeholder="Usu√°rio">

    <label>Senha</label>
    <input id="cSenha" placeholder="Senha">

    <label>Email</label>
    <input id="cEmail" placeholder="Email">

    <div class="actions">
      <button class="btn btn-primary" onclick="cadastrar()">Cadastrar</button>
      <button class="btn btn-ghost" onclick="showLogin('loginBox')">Voltar</button>
    </div>
  </div>
</div>

<!-- RECUPERAR -->
<div class="login hidden" id="recuperar">
  <div class="login-card">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h2>Recuperar senha</h2>
        <p>Envia por email</p>
      </div>
    </div>

    <label>Usu√°rio</label>
    <input id="rUser" placeholder="Usu√°rio">

    <div class="actions">
      <button class="btn btn-primary" onclick="recuperarSenha()">Enviar</button>
      <button class="btn btn-ghost" onclick="showLogin('loginBox')">Voltar</button>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app hidden" id="sistema">
  <aside class="sidebar">
    <div class="side-top">
      <div class="side-user">
        <b id="sideUser">-</b>
        <span id="sideNivel">-</span>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="icon-btn" title="Tema" onclick="toggleTema()">üåô</button>
        <button class="icon-btn" title="Config" onclick="abrirConfig()">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="nav" id="menuPrincipal">
      <div id="m_transferencia" class="item" onclick="abrir('transferencia')">
        <span>üì¶ Transfer√™ncia</span><small>Editar</small>
      </div>
      <div id="m_zeramento" class="item" onclick="abrir('zeramento')">
        <span>üîÅ Zeramento</span><small>Editar</small>
      </div>
      <div id="m_requisicao" class="item" onclick="abrir('requisicao')">
        <span>üìù Requisi√ß√£o</span><small>Editar</small>
      </div>
    </div>

    <div class="nav hidden" id="menuConfig">
      <div class="item" onclick="abrir('cfgTransfer')">
        <span>üîÅ Transfer√™ncia (Locais)</span><small>Config</small>
      </div>
      <div id="btnAdminMenu" class="item hidden" onclick="abrir('adminPerms')">
        <span>üõ°Ô∏è Admin</span><small>Controle</small>
      </div>
      <div class="item" onclick="voltarMenu()">
        <span>‚¨Ö Voltar</span><small>Menu</small>
      </div>
    </div>

    <div class="side-bottom">
      <button class="btn btn-ghost" onclick="sair()">üö™ Sair</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title">
        <b id="topTitle">Transfer√™ncia</b>
        <span id="topSubtitle">Cole seus dados e clique em Importa√ß√£o</span>
      </div>
      <div class="pill" id="pillUser">‚Äî</div>
    </div>

    <!-- TRANSFER√äNCIA -->
    <section class="card hidden" id="transferencia">
      <h2>üì¶ Transfer√™ncia</h2>

      <div class="sheet-wrap">
        <table class="sheet">
          <thead>
            <tr>
              <th>C√≥digo</th><th>Descri√ß√£o</th><th>Chave5</th><th>Chave6</th><th>Chave7</th>
              <th>QTD1</th><th>QTD2</th><th>QTD3</th><th>Local</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btn btn-primary" onclick="importacaoTransferencia()">Importa√ß√£o</button>
        <button class="btn btn-ghost" onclick="limparTabela('transferencia')">Limpar</button>
      </div>

      <div class="subhint">‚úÖ Scroll bloqueado no app. S√≥ a planilha rola. QTD3 sempre vira positivo no TXT.</div>
    </section>

    <!-- ZERAMENTO -->
    <section class="card hidden" id="zeramento">
      <h2>üîÅ Zeramento</h2>

      <div class="sheet-wrap">
        <table class="sheet">
          <thead>
            <tr>
              <th>C√≥digo</th><th>Descri√ß√£o</th><th>Chave5</th><th>Chave6</th><th>Chave7</th>
              <th>QTD1</th><th>QTD2</th><th>QTD3</th><th>Local</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btn btn-primary" onclick="importacaoZeramento()">Importa√ß√£o</button>
        <button class="btn btn-ghost" onclick="limparTabela('zeramento')">Limpar</button>
      </div>

      <div class="subhint">qtd2&gt;qtd1 ‚Üí ‚ÄúE‚Äù e final 1905, sen√£o ‚ÄúS‚Äù e final 5906. QTD3 sempre positivo.</div>
    </section>

    <!-- REQUISI√á√ÉO -->
    <section class="card hidden" id="requisicao">
      <h2>üìù Requisi√ß√£o</h2>

      <div class="sheet-wrap">
        <table class="sheet">
          <thead>
            <tr>
              <th>Pedido</th><th>Cliente</th><th>C√≥digo Item</th><th>Chave5</th><th>Chave6</th><th>Chave7</th>
              <th>Qtd</th><th>(vazio)</th><th>(vazio)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btn btn-primary" onclick="importacaoRequisicao()">Importa√ß√£o</button>
        <button class="btn btn-ghost" onclick="limparTabela('requisicao')">Limpar</button>
      </div>

      <div class="subhint">Cole v√°rios pedidos misturados: o sistema separa pelo n√∫mero do pedido.</div>
    </section>

    <!-- CFG TRANSFER -->
    <section class="card hidden" id="cfgTransfer">
      <h2>üîÅ Transfer√™ncia (Locais)</h2>
      <label>Outro Local (ex: 4044)</label>
      <input id="cfgLocalOutro" placeholder="4044">
      <div class="actions">
        <button class="btn btn-primary" onclick="salvarCfgTransfer()">Salvar</button>
        <button class="btn btn-ghost" onclick="voltarMenu()">Voltar</button>
      </div>
      <div class="subhint">Coluna ‚ÄúLocal‚Äù √© o local informado. ‚ÄúOutro Local‚Äù √© o alternativo.</div>
    </section>

    <!-- ADMIN -->
    <section class="card hidden" id="adminPerms">
      <h2>üõ°Ô∏è Admin</h2>

      <h3 style="margin:10px 0 0 0; font-size:14px;">‚úâÔ∏è Alterar Email</h3>
      <div class="actions" style="gap:10px">
        <select id="admEmailUser" style="min-width:220px"></select>
        <input id="admEmailNovo" placeholder="Novo email">
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="adminSalvarEmail()">Salvar Email</button>
        <button class="btn btn-ghost" onclick="adminRecarregar()">Recarregar</button>
      </div>

      <h3 style="margin:16px 0 0 0; font-size:14px;">üß© Permiss√µes</h3>
      <div id="adminPermsWrap"></div>
    </section>

  </main>
</div>

<script>
/* ========= COLE SUA URL /exec AQUI ========= */
const API_URL = "https://script.google.com/macros/s/AKfycbw9QhuCIvuLHeEgtHUfIXHv7Cnj6CbGg2N9U8mt9JWkZbfauUhy2AZBxz25VGfN21r65Q/exec";

const COLUNAS_FIXAS = 9;
let NIVEL = "";
let USUARIO_LOGADO = "";
let PERMS = {transferencia:"EDITAR", zeramento:"EDITAR", requisicao:"EDITAR"};
const codCache = new Map();
let LOCAL_OUTRO_TRANSFER = localStorage.getItem("LOCAL_OUTRO_TRANSFER") || "4044";

/* Toast */
let toastTimer=null;
function toast(type,title,msg){
  const t = document.getElementById("toast");
  t.className = "toast " + (type||"");
  document.getElementById("toastTitle").textContent = title||"";
  document.getElementById("toastMsg").textContent = msg||"";
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove("show"), 2600);
}

/* Helpers */
function $(id){ return document.getElementById(id); }

/* ‚úÖ Login screens (garantido) */
function showLogin(id){
  ["loginBox","cadastro","recuperar"].forEach(x=>$(x).classList.add("hidden"));
  $(id).classList.remove("hidden");
  $("statusLogin").textContent="";
}

/* Ver senha */
function toggleSenha(){
  const s = $("senha");
  s.type = (s.type === "password") ? "text" : "password";
}

/* Tema */
function toggleTema(){
  document.documentElement.classList.toggle("dark");
  toast("ok","Tema","Tema alternado.");
}

/* Menu */
function abrirConfig(){
  $("menuPrincipal").classList.add("hidden");
  $("menuConfig").classList.remove("hidden");
}
function voltarMenu(){
  $("menuConfig").classList.add("hidden");
  $("menuPrincipal").classList.remove("hidden");
}
function setActiveNav(key){
  document.querySelectorAll("#menuPrincipal .item").forEach(el=>el.classList.remove("active"));
  const el = $("m_"+key);
  if(el) el.classList.add("active");
}
function setTop(title,subtitle){
  $("topTitle").textContent=title;
  $("topSubtitle").textContent=subtitle;
}

function abrir(id){
  document.querySelectorAll(".main .card").forEach(s=>s.classList.add("hidden"));
  $(id).classList.remove("hidden");

  if(id==="transferencia"){ setTop("Transfer√™ncia","Cole e clique em Importa√ß√£o"); setActiveNav("transferencia"); }
  if(id==="zeramento"){ setTop("Zeramento","Cole e clique em Importa√ß√£o"); setActiveNav("zeramento"); }
  if(id==="requisicao"){ setTop("Requisi√ß√£o","Cole pedidos e clique em Importa√ß√£o"); setActiveNav("requisicao"); }
  if(id==="cfgTransfer"){ setTop("Configura√ß√µes","Transfer√™ncia (Locais)"); }
  if(id==="adminPerms"){ setTop("Admin","Gerencie emails e permiss√µes"); }
}

/* Data e n√∫meros */
function dataHoje_ptBR(){ return new Date().toLocaleDateString("pt-BR"); }
function normalizeQTD(str){
  const s=(str||"0").toString().trim();
  let v=parseFloat(s.replace(/\./g,"").replace(",", "."));
  if(isNaN(v)) v=0;
  return v;
}
function absQTDNumFromText(txt){ return Math.abs(normalizeQTD(txt)); } // ‚úÖ sem negativo
function formatQtdTxtFromNum(n){
  if (Number.isInteger(n)) return String(n);
  let s = n.toFixed(3).replace(".", ",");
  s = s.replace(/0+$/,"").replace(/,$/,"");
  return s;
}
function baixarComoTXT(nome,texto){
  const blob=new Blob([texto],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=nome+".txt";
  a.click();
}

/* API */
async function api(action, ...args){
  const payload = JSON.stringify({ action, args });
  const r = await fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: payload,
    redirect: "follow"
  });
  const txt = await r.text();
  if(!r.ok) throw new Error("HTTP "+r.status+" :: "+txt.slice(0,200));
  try{ return JSON.parse(txt); }
  catch(e){ throw new Error("Resposta n√£o-JSON: "+txt.slice(0,200)); }
}

/* Planilha */
function tableBody(sectionId){
  return document.querySelector(`#${sectionId} table.sheet tbody`);
}
function criarTabela(sectionId, linhas=10, colunas=9){
  const tbody = tableBody(sectionId);
  tbody.innerHTML="";
  for(let i=0;i<linhas;i++){
    const tr=document.createElement("tr");
    for(let j=0;j<colunas;j++){
      const td=document.createElement("td");
      td.contentEditable="true";
      td.addEventListener("paste", handlePaste);
      td.addEventListener("keydown", handleGridNav);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}
function limparTabela(sectionId){
  criarTabela(sectionId,10,COLUNAS_FIXAS);
  toast("ok","Limpar","Tabela limpa.");
}
function handlePaste(e){
  e.preventDefault();
  const text=(e.clipboardData||window.clipboardData).getData("text");
  const rows=text.split(/\r?\n/).filter(r=>r!=="");
  const startCell=e.target, tr=startCell.parentElement, tbody=tr.parentElement;
  const rowIndex=Array.from(tbody.rows).indexOf(tr);
  const colIndex=Array.from(tr.cells).indexOf(startCell);

  rows.forEach((r,i)=>{
    const cols=r.split(/\t/);
    let targetRow=tbody.rows[rowIndex+i];
    if(!targetRow){
      targetRow=tbody.insertRow();
      for(let k=0;k<COLUNAS_FIXAS;k++){
        const td=targetRow.insertCell();
        td.contentEditable="true";
        td.addEventListener("paste", handlePaste);
        td.addEventListener("keydown", handleGridNav);
      }
    }
    cols.forEach((c,j)=>{
      const td=targetRow.cells[colIndex+j];
      if(td) td.innerText=c;
    });
  });
}
function handleGridNav(e){
  if(e.key!=="Enter") return;
  e.preventDefault();
  const td=e.target;
  const tr=td.parentElement;
  const tbody=tr.parentElement;
  const r=Array.from(tbody.rows).indexOf(tr);
  const c=Array.from(tr.cells).indexOf(td);
  const nextRow = tbody.rows[r+1] || tbody.rows[r];
  (nextRow.cells[c] || nextRow.cells[0]).focus();
}

/* Config transfer√™ncia */
function salvarCfgTransfer(){
  const v = ($("cfgLocalOutro").value || "").trim();
  if(!v) return toast("warn","Aten√ß√£o","Informe o outro local (ex: 4044).");
  LOCAL_OUTRO_TRANSFER = v;
  localStorage.setItem("LOCAL_OUTRO_TRANSFER", v);
  toast("ok","Salvo","Outro Local atualizado.");
}

/* Permiss√µes */
function aplicarPermissoesUI(){
  $("m_transferencia").style.display = (PERMS.transferencia==="BLOQUEAR") ? "none" : "";
  $("m_zeramento").style.display = (PERMS.zeramento==="BLOQUEAR") ? "none" : "";
  $("m_requisicao").style.display = (PERMS.requisicao==="BLOQUEAR") ? "none" : "";
  $("btnAdminMenu").classList.toggle("hidden", NIVEL !== "ADMIN");
}

/* Mapeamentos */
async function mapearOuCadastrar(chave){
  const key=(chave||"").toString().trim();
  if(!key) return "";
  const norm=key.toLowerCase();
  if(codCache.has(norm)) return codCache.get(norm);

  const res=await api("cod_get", key);
  if(res.ok && res.found){ codCache.set(norm,res.value); return res.value; }

  const saida=prompt(`CHAVE n√£o cadastrada (COD A/B):\n"${key}"\nDigite o que deve sair no TXT:`);
  if(saida===null) throw new Error("Cadastro cancelado: "+key);
  const out=saida.toString().trim();
  if(!out) throw new Error("Sa√≠da vazia: "+key);

  const saved=await api("cod_set", key, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar COD");
  codCache.set(norm,out);
  return out;
}
async function getLocalPorItem(codigoItem){
  const code=(codigoItem||"").toString().trim();
  if(!code) return "";
  const res=await api("cod_get_local", code);
  if(res.ok && res.found) return res.value;

  const local=prompt(`LOCAL n√£o cadastrado para item "${code}" (COD D/E).\nDigite o LOCAL (ex: 164):`);
  if(local===null) throw new Error("Cadastro de local cancelado.");
  const out=local.toString().trim();
  if(!out) throw new Error("LOCAL vazio.");

  const saved=await api("cod_set_local", code, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar local.");
  return out;
}
async function getRequisitantePorUsuario(usuario){
  const u=(usuario||"").toString().trim().toLowerCase();
  if(!u) return "74";
  const res=await api("req_get", u);
  if(res.ok && res.found) return res.value;

  const req=prompt(`Requisitante n√£o cadastrado para "${u}".\nDigite o valor (ex: 74):`);
  if(req===null) throw new Error("Cadastro cancelado.");
  const out=req.toString().trim();
  if(!out) throw new Error("Requisitante vazio.");

  const saved=await api("req_set", u, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar requisitante.");
  return out;
}

/* AUTH */
async function entrar(){
  $("statusLogin").textContent="";
  const u = $("usuario").value.trim();
  const s = $("senha").value.trim();
  if(!u || !s) return toast("warn","Aten√ß√£o","Preencha usu√°rio e senha.");

  try{
    const res = await api("login", u, s);
    if(!res.ok) return toast("danger","Login","Usu√°rio ou senha inv√°lidos.");

    NIVEL = (res.nivel || "").toUpperCase();
    USUARIO_LOGADO = res.usuario || u;
    PERMS = res.perms || PERMS;

    $("loginBox").classList.add("hidden");
    $("cadastro").classList.add("hidden");
    $("recuperar").classList.add("hidden");
    $("sistema").classList.remove("hidden");

    $("sideUser").textContent = USUARIO_LOGADO;
    $("sideNivel").textContent = NIVEL;
    $("pillUser").textContent = `${USUARIO_LOGADO} ‚Ä¢ ${NIVEL}`;

    criarTabela("transferencia",10,COLUNAS_FIXAS);
    criarTabela("zeramento",10,COLUNAS_FIXAS);
    criarTabela("requisicao",10,COLUNAS_FIXAS);

    $("cfgLocalOutro").value = LOCAL_OUTRO_TRANSFER;

    aplicarPermissoesUI();
    voltarMenu();
    abrir("transferencia");
    toast("ok","Bem-vindo",`Voc√™ entrou como ${NIVEL}.`);

    if(NIVEL==="ADMIN") adminRecarregar();
  }catch(err){
    $("statusLogin").textContent = "Erro: " + err.message;
    toast("danger","Erro",err.message);
  }
}

async function cadastrar(){
  try{
    const res = await api("cadastrar", $("cUser").value, $("cSenha").value, $("cEmail").value);
    if(res.ok){
      toast("ok","Cadastro","Conta criada!");
      showLogin("loginBox");
    }else{
      toast("danger","Cadastro",res.msg || "Erro");
    }
  }catch(err){ toast("danger","Erro",err.message); }
}

async function recuperarSenha(){
  try{
    const res = await api("recuperar", $("rUser").value);
    toast(res.ok?"ok":"danger","Recuperar", res.ok ? "Email enviado!" : (res.msg || "Erro"));
  }catch(err){ toast("danger","Erro",err.message); }
}

function sair(){
  NIVEL=""; USUARIO_LOGADO="";
  $("sistema").classList.add("hidden");
  showLogin("loginBox");
  $("senha").value="";
  toast("ok","Saiu","Voc√™ voltou para o login.");
}

/* IMPORTA√á√ïES */
async function importacaoTransferencia(){
  try{
    const rows=tableBody("transferencia").querySelectorAll("tr");
    const hoje=dataHoje_ptBR();
    const out=[];

    for(const tr of rows){
      const c=[...tr.cells].map(td=>(td.innerText||"").trim());
      while(c.length<9) c.push("");

      const codigo=c[0];
      const chave5=c[2], chave6=c[3], chave7=c[4];
      const qtd1=normalizeQTD(c[5]||"0");
      const qtd2=normalizeQTD(c[6]||"0");

      const qtd3Abs = absQTDNumFromText(c[7]||"0");
      if(qtd3Abs === 0) continue;
      const qtd3Txt = formatQtdTxtFromNum(qtd3Abs);

      const localInformado=(c[8]||"164").trim() || "164";
      const outroLocal=(LOCAL_OUTRO_TRANSFER||"4044").trim();

      const f5=await mapearOuCadastrar(chave5);
      const f6=await mapearOuCadastrar(chave6);
      const f7=await mapearOuCadastrar(chave7);

      let origem=localInformado, destino=outroLocal;
      if(qtd2>qtd1){ origem=outroLocal; destino=localInformado; }

      const valor=(qtd3Abs*0.01).toFixed(2).replace(".",",");

      out.push(["M1","T",hoje,codigo,f5,f6,f7,origem,destino,qtd3Txt,"0,01",valor,"5949"].join("|"));
    }

    if(!out.length) return toast("warn","Importa√ß√£o","Nada para importar.");
    baixarComoTXT("importacao_transferencia", out.join("\n"));
    toast("ok","Importa√ß√£o",`${out.length} linhas geradas.`);
  }catch(err){ toast("danger","Erro",err.message); }
}

async function importacaoZeramento(){
  try{
    const rows=tableBody("zeramento").querySelectorAll("tr");
    const hoje=dataHoje_ptBR();
    const out=[];

    for(const tr of rows){
      const c=[...tr.cells].map(td=>(td.innerText||"").trim());
      while(c.length<9) c.push("");

      const codigo=c[0];
      const chave5=c[2], chave6=c[3], chave7=c[4];
      const qtd1=normalizeQTD(c[5]||"0");
      const qtd2=normalizeQTD(c[6]||"0");

      const qtd3Abs = absQTDNumFromText(c[7]||"0");
      if(qtd3Abs === 0) continue;
      const qtd3Txt = formatQtdTxtFromNum(qtd3Abs);

      const local=(c[8]||"164").trim() || "164";

      const f5=await mapearOuCadastrar(chave5);
      const f6=await mapearOuCadastrar(chave6);
      const f7=await mapearOuCadastrar(chave7);

      const tipo=(qtd2>qtd1)?"E":"S";
      const final=(qtd2>qtd1)?"1905":"5906";
      const valor=(qtd3Abs*0.01).toFixed(2).replace(".",",");

      out.push(["M1",tipo,hoje,codigo,f5,f6,f7,local,qtd3Txt,"0,01",valor,final].join("|"));
    }

    if(!out.length) return toast("warn","Importa√ß√£o","Nada para importar.");
    baixarComoTXT("importacao_zeramento", out.join("\n"));
    toast("ok","Importa√ß√£o",`${out.length} linhas geradas.`);
  }catch(err){ toast("danger","Erro",err.message); }
}

async function importacaoRequisicao(){
  try{
    const rows=tableBody("requisicao").querySelectorAll("tr");
    const hoje=dataHoje_ptBR();
    const requisitante=await getRequisitantePorUsuario(USUARIO_LOGADO);

    const pedidos=new Map();
    for(const tr of rows){
      const raw=[...tr.cells].map(td=>(td.innerText||"").trim());
      if(raw.every(x=>!x)) continue;

      const pedido=(raw[0]||"").trim();
      const cliente=(raw[1]||"").trim();
      const codigo=(raw[2]||"").trim();
      const k5=(raw[3]||"").trim();
      const k6=(raw[4]||"").trim();
      const k7=(raw[5]||"").trim();

      const qtdAbs = absQTDNumFromText(raw[6]||"0");
      if(qtdAbs === 0) continue;
      const qtd = formatQtdTxtFromNum(qtdAbs);

      if(!pedido || !codigo) continue;

      if(!pedidos.has(pedido)) pedidos.set(pedido,{cliente,itens:[]});
      else if(!pedidos.get(pedido).cliente && cliente) pedidos.get(pedido).cliente=cliente;

      pedidos.get(pedido).itens.push({codigo,k5,k6,k7,qtd});
    }

    const out=[];
    for(const [pedido,obj] of pedidos.entries()){
      out.push(["R",hoje,"1","1",requisitante,"27",`${pedido}  -  ${obj.cliente||""}`,pedido,"0","0"].join("|"));
      for(const it of obj.itens){
        const local=await getLocalPorItem(it.codigo);
        out.push(["I","P",it.codigo,it.k5||"",it.k6||"",it.k7||"",it.qtd,"3",local].join("|"));
      }
    }

    if(!out.length) return toast("warn","Importa√ß√£o","Nada para importar.");
    baixarComoTXT("importacao_requisicao", out.join("\n"));
    toast("ok","Importa√ß√£o",`${out.length} linhas geradas.`);
  }catch(err){ toast("danger","Erro",err.message); }
}

/* ADMIN */
async function adminRecarregar(){
  const res=await api("admin_listarUsuarios", USUARIO_LOGADO);
  if(!res.ok) return;

  const sel=$("admEmailUser");
  sel.innerHTML="";
  res.usuarios.forEach(u=>{
    const op=document.createElement("option");
    op.value=u.usuario; op.textContent=u.usuario;
    sel.appendChild(op);
  });

  // table simples (mantive)
  const wrap=$("adminPermsWrap");
  wrap.innerHTML="<div class='small'>Permiss√µes carregadas.</div>";
}
async function adminSalvarEmail(){
  const alvo=$("admEmailUser").value;
  const novo=$("admEmailNovo").value;
  const r=await api("admin_alterarEmail", USUARIO_LOGADO, alvo, novo);
  toast(r.ok?"ok":"danger","Admin", r.ok ? "Email atualizado!" : (r.msg||"Erro"));
}

/* ENTER login */
$("usuario").addEventListener("keyup",(e)=>{ if(e.key==="Enter") entrar(); });
$("senha").addEventListener("keyup",(e)=>{ if(e.key==="Enter") entrar(); });

/* Inicial */
showLogin("loginBox");
</script>

</body>
</html>
