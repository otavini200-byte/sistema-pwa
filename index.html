<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#6a4bc9" />

  <style>
    :root{
      --primary:#6a4bc9;
      --primary2:#2c1a4d;
      --bg:#0b0b10;
      --card:#12121a;
      --card2:#171722;
      --text:#f2f2f6;
      --muted:rgba(242,242,246,.75);
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 12px 30px rgba(0,0,0,.32);
      --ok:#27ae60;
      --danger:#c0392b;
      --warn:#f39c12;
    }

    .light{
      --bg:#f2f4f8;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#1f1f2a;
      --muted:rgba(31,31,42,.70);
      --line:rgba(0,0,0,.10);
      --shadow: 0 16px 50px rgba(0,0,0,.12);
      --shadow2: 0 10px 24px rgba(0,0,0,.10);
    }

    *{box-sizing:border-box;font-family:Segoe UI,system-ui,Arial,sans-serif;}
    body{
      margin:0; color:var(--text); background:radial-gradient(1200px 600px at 10% 10%, rgba(106,75,201,.25), transparent 60%),
      radial-gradient(800px 600px at 90% 30%, rgba(44,26,77,.25), transparent 55%),
      var(--bg);
      transition:background .25s,color .25s;
    }
    body.lock{overflow:hidden;}

    .fade-in{animation:fadeIn .22s ease-out both;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:3;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px;
      background:linear-gradient(180deg, rgba(18,18,26,.92), rgba(18,18,26,.65));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .light .topbar{
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      font-weight:700; letter-spacing:.2px;
    }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      background:rgba(255,255,255,.04);
    }
    .light .pill{ background:rgba(0,0,0,.03); }

    /* Buttons / inputs */
    input,select{
      width:100%; padding:12px 12px; margin-top:10px;
      border-radius:12px; border:1px solid var(--line);
      outline:none; background:var(--card2); color:var(--text);
      transition: box-shadow .15s, transform .12s, border-color .15s;
    }
    input:focus,select:focus{
      border-color: rgba(106,75,201,.65);
      box-shadow: 0 0 0 4px rgba(106,75,201,.18);
    }

    .btn{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(135deg, var(--primary), #7b5df0);
      color:#fff; cursor:pointer;
      transition: transform .12s, filter .12s, box-shadow .12s;
      box-shadow: 0 10px 26px rgba(106,75,201,.25);
      margin-top:8px;
      font-weight:650;
    }
    .btn:hover{filter:brightness(1.03);transform:translateY(-1px);}
    .btn:active{transform:translateY(0px);filter:brightness(.98);}
    .btn.secondary{
      background:transparent;
      border:1px solid var(--line);
      box-shadow:none;
      color:var(--text);
    }
    .btn.danger{
      background:linear-gradient(135deg, var(--danger), #e74c3c);
      box-shadow: 0 10px 26px rgba(231,76,60,.20);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .row > *{flex:1; min-width:180px;}

    /* Login */
    .login{
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      padding:22px;
    }
    .login-card{
      width:min(420px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:26px;
      box-shadow:var(--shadow);
    }
    .light .login-card{
      background:var(--card);
    }
    .login-card h2{margin:0 0 8px 0;}
    .sub{color:var(--muted); font-size:13px; margin:0 0 12px 0;}
    .login-links{margin-top:12px; text-align:center; font-size:13px; color:var(--muted);}
    .login-links span{cursor:pointer; color:rgba(106,75,201,1); font-weight:650; margin:0 6px;}
    .login-links span:hover{text-decoration:underline;}

    /* Sistema layout */
    .hidden{display:none;}
    .sistema{display:flex; min-height:100vh;}
    .sidebar{
      width:290px;
      padding:16px;
      border-right:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
    }
    .light .sidebar{background:rgba(255,255,255,.75);}
    .menu-title{color:var(--muted); font-size:12px; letter-spacing:.6px; margin:10px 8px 8px;}
    .menu div{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      margin-bottom:10px;
      cursor:pointer;
      transition: transform .12s, background .12s, border-color .12s;
      user-select:none;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .light .menu div{background:rgba(0,0,0,.03);}
    .menu div:hover{transform:translateY(-1px); border-color:rgba(106,75,201,.35);}
    .menu div small{color:var(--muted); font-weight:600;}

    .conteudo{flex:1; padding:18px;}
    .box{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow2);
      max-width:1400px;
    }
    .light .box{background:var(--card);}
    .box h2{margin:0 0 12px 0;}
    .hint{font-size:12px;color:var(--muted); margin-top:10px}

    /* Table */
    .tabela-container{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:auto;
      min-height:300px;
      background:rgba(0,0,0,.08);
    }
    .light .tabela-container{background:rgba(0,0,0,.02);}
    .tabela-colagem{width:100%; border-collapse:collapse;}
    .tabela-colagem td{
      border:1px solid var(--line);
      padding:8px;
      font-size:13px;
      min-width:120px;
      background:transparent;
    }
    .tabela-colagem td:focus{
      outline:none;
      box-shadow: inset 0 0 0 2px rgba(106,75,201,.35);
      background:rgba(106,75,201,.08);
    }

    /* Admin */
    .table-admin{width:100%; border-collapse:collapse; margin-top:12px;}
    .table-admin th,.table-admin td{border:1px solid var(--line); padding:8px; font-size:13px;}
    .table-admin th{background:rgba(106,75,201,.10); text-align:left;}
    .tag{
      display:inline-block;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
    }

    /* Responsive */
    @media (max-width: 980px){
      .sistema{flex-direction:column;}
      .sidebar{width:100%; border-right:none; border-bottom:1px solid var(--line);}
    }
  </style>
</head>

<body class="lock">

  <!-- LOGIN -->
  <div class="login" id="loginBox">
    <div class="login-card fade-in">
      <h2>üîê Sistema</h2>
      <p class="sub">Entre com seu usu√°rio e senha</p>
      <input id="usuario" placeholder="Usu√°rio">
      <input id="senha" type="password" placeholder="Senha">
      <button class="btn" onclick="entrar()">Entrar</button>

      <div class="login-links">
        <span onclick="showLogin('cadastro')">Criar conta</span> |
        <span onclick="showLogin('recuperar')">Recuperar senha</span> |
        <span onclick="toggleSenha()">üëÅ Ver senha</span>
      </div>
    </div>
  </div>

  <!-- CADASTRO -->
  <div class="login hidden" id="cadastro">
    <div class="login-card fade-in">
      <h2>‚ú® Criar conta</h2>
      <p class="sub">Preencha os dados</p>
      <input id="cUser" placeholder="Usu√°rio">
      <input id="cSenha" placeholder="Senha">
      <input id="cEmail" placeholder="Email">
      <button class="btn" onclick="cadastrar()">Cadastrar</button>
      <button class="btn secondary" onclick="showLogin('loginBox')">Voltar</button>
    </div>
  </div>

  <!-- RECUPERAR -->
  <div class="login hidden" id="recuperar">
    <div class="login-card fade-in">
      <h2>üì© Recuperar senha</h2>
      <p class="sub">Vamos enviar a senha para seu email</p>
      <input id="rUser" placeholder="Usu√°rio">
      <button class="btn" onclick="recuperarSenha()">Enviar</button>
      <button class="btn secondary" onclick="showLogin('loginBox')">Voltar</button>
    </div>
  </div>

  <!-- SISTEMA -->
  <div class="hidden" id="sistema">
    <div class="topbar">
      <div class="brand">‚ö° Sistema <span class="pill" id="pillUser">‚Äî</span></div>
      <div style="display:flex;gap:10px;align-items:center;">
        <span class="pill" id="pillNivel">‚Äî</span>
        <button class="btn secondary" style="width:auto;margin:0;padding:10px 12px;" onclick="openConfig()">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="sistema">
      <div class="sidebar">
        <div class="menu-title">MENU</div>
        <div class="menu" id="menuPrincipal">
          <div id="m_transferencia" onclick="abrir('transferencia')">üì¶ Transfer√™ncia <small>Importar</small></div>
          <div id="m_zeramento" onclick="abrir('zeramento')">üîÅ Zeramento <small>Importar</small></div>
          <div id="m_requisicao" onclick="abrir('requisicao')">üìù Requisi√ß√£o <small>Importar</small></div>
        </div>

        <div class="menu-title">CONFIG</div>
        <div class="menu" id="menuConfig">
          <div onclick="abrir('cfgTransfer')">üîß Local Transfer√™ncia <small>De/Para</small></div>
          <div onclick="abrir('tema')">üåó Tema <small>Claro/Escuro</small></div>
          <div id="btnAdminMenu" class="hidden" onclick="abrir('adminPerms')">üõ°Ô∏è Admin <small>Permiss√µes</small></div>
          <div id="btnAdminEmail" class="hidden" onclick="abrir('adminEmail')">‚úâÔ∏è Admin <small>Email</small></div>
          <div onclick="logout()">üö™ Sair <small>Logout</small></div>
        </div>
      </div>

      <div class="conteudo">

        <div class="box hidden fade-in" id="transferencia">
          <h2>üì¶ Transfer√™ncia</h2>
          <div class="tabela-container">
            <table class="tabela-colagem"><tbody></tbody></table>
          </div>
          <div class="row">
            <button class="btn" onclick="importacaoTransferencia()">Importa√ß√£o</button>
            <button class="btn danger" onclick="limparTabela('transferencia')">Limpar</button>
          </div>
          <div class="hint">QTD negativa vira positiva no TXT. QTD=0 n√£o exporta. DE/PARA usa QTD1/QTD2 + ‚ÄúOutro Local‚Äù.</div>
        </div>

        <div class="box hidden fade-in" id="zeramento">
          <h2>üîÅ Zeramento</h2>
          <div class="tabela-container">
            <table class="tabela-colagem"><tbody></tbody></table>
          </div>
          <div class="row">
            <button class="btn" onclick="importacaoZeramento()">Importa√ß√£o</button>
            <button class="btn danger" onclick="limparTabela('zeramento')">Limpar</button>
          </div>
          <div class="hint">QTD negativa vira positiva no TXT. QTD=0 n√£o exporta. Tipo: qtd2&gt;qtd1 ‚Üí E/1905 sen√£o S/5906.</div>
        </div>

        <div class="box hidden fade-in" id="requisicao">
          <h2>üìù Requisi√ß√£o</h2>
          <div class="tabela-container">
            <table class="tabela-colagem"><tbody></tbody></table>
          </div>
          <div class="row">
            <button class="btn" onclick="importacaoRequisicao()">Importa√ß√£o</button>
            <button class="btn danger" onclick="limparTabela('requisicao')">Limpar</button>
          </div>
          <div class="hint">Cole: Pedido | Cliente | C√≥digoItem | Chave5 | Chave6 | Chave7 | Qtd ‚Äî (QTD negativa vira positiva)</div>
        </div>

        <div class="box hidden fade-in" id="cfgTransfer">
          <h2>üîß Local Transfer√™ncia</h2>
          <span class="tag">Coluna 9 = Local informado</span>
          <input id="cfgLocalOutro" placeholder="Outro local (ex: 4044)">
          <button class="btn" onclick="salvarCfgTransfer()">Salvar</button>
          <div class="hint">Se qtd1 &gt; qtd2 ‚Üí Local informado ‚Üí Outro local. Se qtd2 &gt; qtd1 ‚Üí Outro local ‚Üí Local informado.</div>
        </div>

        <div class="box hidden fade-in" id="tema">
          <h2>üåó Tema</h2>
          <div class="row">
            <button class="btn secondary" onclick="setTema('light')">‚òÄÔ∏è Claro</button>
            <button class="btn" onclick="setTema('dark')">üåô Escuro</button>
          </div>
        </div>

        <div class="box hidden fade-in" id="adminEmail">
          <h2>‚úâÔ∏è Admin ‚Äî Alterar Email</h2>
          <div class="row">
            <select id="admEmailUser"></select>
            <input id="admEmailNovo" placeholder="Novo email">
          </div>
          <div class="row">
            <button class="btn" onclick="adminSalvarEmail()">Salvar</button>
            <button class="btn secondary" onclick="adminRecarregar()">Recarregar</button>
          </div>
        </div>

        <div class="box hidden fade-in" id="adminPerms">
          <h2>üõ°Ô∏è Admin ‚Äî Permiss√µes</h2>
          <div id="adminPermsWrap"></div>
          <div class="hint">A planilha pode ter s√≥ 4 colunas; se tiver E/F/G, aqui vira controle fino.</div>
          <div class="row">
            <button class="btn secondary" onclick="adminRecarregar()">Recarregar</button>
            <button class="btn secondary" onclick="abrir('transferencia')">Voltar</button>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* ========= COLE SUA URL /exec AQUI ========= */
const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgYXXJe6aFBSWs4driFdDCn0LrqfQsqa4aMmCMCHKnAQp_nVhWDuVQlbc44beUSG8JFM7PpQ3X-zbj4WQdZ_He9ndHfSPovqKA7x52Osw8do8oT74cSS1cNj7eT8ErJBEXkxx6waJT6vsBRmlM8wA0zwduesHJLtunwnN2QfGkrIO1NIDSw-5_0FYViVePF5pAcn8DcUZDaJqftoyMBATHVOCqr571G8lVrR7TC61UL3HOOfyQZNfTlgetXTzzcubeVRBiGyi0980YBxYrbYWSyEObDLw&lib=McTwOPg6EjKgsOsf3ykd3XBrns8elDHiD";

/* PWA SW */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(function(){});
}

/* Helpers */
function $(id){ return document.getElementById(id); }

function showLogin(id){
  ["loginBox","cadastro","recuperar"].forEach(function(x){ $(x).classList.add("hidden"); });
  $(id).classList.remove("hidden");
}

function toggleSenha(){
  var el = $("senha");
  el.type = (el.type === "password") ? "text" : "password";
}

async function api(action){
  var args = Array.prototype.slice.call(arguments, 1);
  var payload = JSON.stringify({ action: action, args: args });
  var r = await fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: payload
  });
  return await r.json();
}

/* Estado */
var NIVEL = "";
var USUARIO_LOGADO = "";
var PERMS = {transferencia:"EDITAR", zeramento:"EDITAR", requisicao:"EDITAR"};
var COLUNAS_FIXAS = 9;
var codCache = new Map();

var LOCAL_OUTRO_TRANSFER = localStorage.getItem("LOCAL_OUTRO_TRANSFER") || "4044";

/* UI */
function abrir(id){
  var boxes = document.querySelectorAll(".box");
  boxes.forEach(function(b){ b.classList.add("hidden"); });
  $(id).classList.remove("hidden");
}

function setTema(t){
  if(t === "light"){
    document.documentElement.classList.add("light");
  } else {
    document.documentElement.classList.remove("light");
  }
}

/* Tabela estilo planilha */
function criarTabela(boxId, linhas, colunas){
  linhas = linhas || 10;
  colunas = colunas || 9;

  var tbody = document.querySelector("#"+boxId+" .tabela-colagem tbody");
  tbody.innerHTML = "";

  for(var i=0;i<linhas;i++){
    var tr = document.createElement("tr");
    for(var j=0;j<colunas;j++){
      var td = document.createElement("td");
      td.contentEditable = "true";
      td.addEventListener("paste", handlePaste);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

function limparTabela(boxId){
  criarTabela(boxId, 10, COLUNAS_FIXAS);
}

function handlePaste(e){
  e.preventDefault();
  var text = (e.clipboardData || window.clipboardData).getData("text");
  var rows = text.split(/\r?\n/).filter(function(r){ return r !== ""; });

  var startCell = e.target;
  var tr = startCell.parentElement;
  var tbody = tr.parentElement;

  var rowIndex = Array.from(tbody.rows).indexOf(tr);
  var colIndex = Array.from(tr.cells).indexOf(startCell);

  rows.forEach(function(r, i){
    var cols = r.split(/\t/);
    var targetRow = tbody.rows[rowIndex + i];
    if(!targetRow){
      targetRow = tbody.insertRow();
      for(var k=0;k<COLUNAS_FIXAS;k++){
        var td = targetRow.insertCell();
        td.contentEditable = "true";
        td.addEventListener("paste", handlePaste);
      }
    }
    cols.forEach(function(c, j){
      var td = targetRow.cells[colIndex + j];
      if(td) td.innerText = c;
    });
  });
}

/* Valores */
function dataHoje_ptBR(){
  return new Date().toLocaleDateString("pt-BR");
}

function normalizeQTD(str){
  var s = String(str || "0").trim();
  // aceita -5, 1.234,56, etc.
  var v = parseFloat(s.replace(/\./g,"").replace(",", "."));
  if (isNaN(v)) v = 0;
  return v;
}

// ABS garantido AQUI (mesmo que algu√©m chame errado)
function absQTDNumFromText(txt){
  return Math.abs(normalizeQTD(txt));
}

function formatQtdTxtFromNum(n){
  n = Math.abs(Number(n) || 0); // GARANTE POSITIVO
  if (Number.isInteger(n)) return String(n);
  var s = n.toFixed(3).replace(".", ",");
  s = s.replace(/0+$/,"").replace(/,$/,"");
  return s;
}

function baixarComoTXT(nome, texto){
  var blob = new Blob([texto],{type:"text/plain"});
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = nome + ".txt";
  a.click();
}

/* Config Transfer */
function salvarCfgTransfer(){
  var v = String($("cfgLocalOutro").value || "").trim();
  if(!v) return alert("Informe o outro local (ex: 4044).");
  LOCAL_OUTRO_TRANSFER = v;
  localStorage.setItem("LOCAL_OUTRO_TRANSFER", v);
  alert("Salvo!");
}

function carregarCfgTransferUI(){
  if($("cfgLocalOutro")) $("cfgLocalOutro").value = LOCAL_OUTRO_TRANSFER;
}

/* Permiss√µes */
function aplicarPermissoesUI(){
  $("m_transferencia").style.display = (PERMS.transferencia === "BLOQUEAR") ? "none" : "";
  $("m_zeramento").style.display = (PERMS.zeramento === "BLOQUEAR") ? "none" : "";
  $("m_requisicao").style.display = (PERMS.requisicao === "BLOQUEAR") ? "none" : "";

  $("btnAdminMenu").classList.toggle("hidden", NIVEL !== "ADMIN");
  $("btnAdminEmail").classList.toggle("hidden", NIVEL !== "ADMIN");
}

/* Backend helpers */
async function mapearOuCadastrar(chave){
  var key = String(chave || "").trim();
  if(!key) return "";
  var norm = key.toLowerCase();

  if(codCache.has(norm)) return codCache.get(norm);

  var res = await api("cod_get", key);
  if(res.ok && res.found){
    codCache.set(norm, res.value);
    return res.value;
  }

  var saida = prompt('CHAVE n√£o cadastrada (COD A/B):\n"'+key+'"\nDigite o que deve sair no TXT:');
  if(saida === null) throw new Error("Cadastro cancelado: " + key);

  var out = String(saida || "").trim();
  if(!out) throw new Error("Sa√≠da vazia: " + key);

  var saved = await api("cod_set", key, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar COD");

  codCache.set(norm, out);
  return out;
}

async function getLocalPorItem(codigoItem){
  var code = String(codigoItem || "").trim();
  if(!code) return "";

  var res = await api("cod_get_local", code);
  if(res.ok && res.found) return res.value;

  var local = prompt('LOCAL n√£o cadastrado para item "'+code+'" (COD D/E).\nDigite o LOCAL (ex: 164):');
  if(local === null) throw new Error("Cadastro de local cancelado.");

  var out = String(local || "").trim();
  if(!out) throw new Error("LOCAL vazio.");

  var saved = await api("cod_set_local", code, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar local.");

  return out;
}

async function getRequisitantePorUsuario(usuario){
  var u = String(usuario || "").trim().toLowerCase();
  if(!u) return "74";

  var res = await api("req_get", u);
  if(res.ok && res.found) return res.value;

  var req = prompt('Requisitante n√£o cadastrado para "'+u+'".\nDigite o valor (ex: 74):');
  if(req === null) throw new Error("Cadastro cancelado.");

  var out = String(req || "").trim();
  if(!out) throw new Error("Requisitante vazio.");

  var saved = await api("req_set", u, out);
  if(!saved.ok) throw new Error(saved.msg || "Erro ao salvar requisitante.");

  return out;
}

/* Auth */
async function entrar(){
  if(API_URL.indexOf(https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgYXXJe6aFBSWs4driFdDCn0LrqfQsqa4aMmCMCHKnAQp_nVhWDuVQlbc44beUSG8JFM7PpQ3X-zbj4WQdZ_He9ndHfSPovqKA7x52Osw8do8oT74cSS1cNj7eT8ErJBEXkxx6waJT6vsBRmlM8wA0zwduesHJLtunwnN2QfGkrIO1NIDSw-5_0FYViVePF5pAcn8DcUZDaJqftoyMBATHVOCqr571G8lVrR7TC61UL3HOOfyQZNfTlgetXTzzcubeVRBiGyi0980YBxYrbYWSyEObDLw&lib=McTwOPg6EjKgsOsf3ykd3XBrns8elDHiD) >= 0) return alert("Cole sua URL /exec em API_URL no index.html");

  var u = $("usuario").value;
  var s = $("senha").value;

  var res = await api("login", u, s);
  if(!res.ok) return alert(res.msg || "Usu√°rio ou senha inv√°lidos");

  NIVEL = res.nivel;
  USUARIO_LOGADO = res.usuario;
  PERMS = res.perms || PERMS;

  $("pillUser").textContent = res.usuario;
  $("pillNivel").textContent = res.nivel;

  document.body.classList.remove("lock");
  $("loginBox").classList.add("hidden");
  $("cadastro").classList.add("hidden");
  $("recuperar").classList.add("hidden");

  $("sistema").classList.remove("hidden");

  criarTabela("transferencia",10,COLUNAS_FIXAS);
  criarTabela("zeramento",10,COLUNAS_FIXAS);
  criarTabela("requisicao",10,COLUNAS_FIXAS);

  carregarCfgTransferUI();
  aplicarPermissoesUI();
  abrir("transferencia");

  if(NIVEL === "ADMIN") await adminRecarregar();
}

async function cadastrar(){
  var res = await api("cadastrar", $("cUser").value, $("cSenha").value, $("cEmail").value);
  alert(res.ok ? "Conta criada!" : (res.msg || "Erro"));
  if(res.ok) showLogin("loginBox");
}

async function recuperarSenha(){
  var res = await api("recuperar", $("rUser").value);
  alert(res.ok ? "Email enviado!" : (res.msg || "Erro"));
}

function logout(){
  NIVEL = ""; USUARIO_LOGADO = "";
  $("sistema").classList.add("hidden");
  $("loginBox").classList.remove("hidden");
  document.body.classList.add("lock");
  $("senha").value = "";
}

/* IMPORTA√á√ÉO: NEGATIVOS SEMPRE POSITIVOS + N√ÉO EXPORTA 0 */
async function importacaoTransferencia(){
  try{
    var rows = document.querySelectorAll("#transferencia .tabela-colagem tbody tr");
    var hoje = dataHoje_ptBR();
    var saida = [];

    for (var r=0; r<rows.length; r++){
      var tr = rows[r];
      var c = Array.from(tr.cells).map(function(td){ return String(td.innerText||"").trim(); });
      while(c.length < 9) c.push("");

      var codigo = c[0];
      var chave5 = c[2], chave6 = c[3], chave7 = c[4];

      var qtd1 = normalizeQTD(c[5]||"0");
      var qtd2 = normalizeQTD(c[6]||"0");

      var qtd3AbsNum = absQTDNumFromText(c[7]||"0");
      if(qtd3AbsNum === 0) continue;

      var qtd3Txt = formatQtdTxtFromNum(qtd3AbsNum);

      var localInformado = (c[8]||"164").trim() || "164";
      var outroLocal = String(LOCAL_OUTRO_TRANSFER || "4044").trim();

      if(!codigo && !chave5 && !chave6 && !chave7 && qtd1===0 && qtd2===0) continue;

      var f5 = await mapearOuCadastrar(chave5);
      var f6 = await mapearOuCadastrar(chave6);
      var f7 = await mapearOuCadastrar(chave7);

      // DE/PARA (n√£o √© mais 4044 fixo)
      var origem = localInformado, destino = outroLocal;
      if(qtd2 > qtd1){ origem = outroLocal; destino = localInformado; }

      // valor sempre positivo
      var valor = (qtd3AbsNum * 0.01).toFixed(2).replace(".", ",");

      saida.push(["M1","T",hoje,codigo,f5,f6,f7,origem,destino,qtd3Txt,"0,01",valor,"5949"].join("|"));
    }

    if(!saida.length) return alert("Nada para importar.");
    baixarComoTXT("importacao_transferencia", saida.join("\n"));
  } catch(err){
    alert("Erro: " + err.message);
  }
}

async function importacaoZeramento(){
  try{
    var rows = document.querySelectorAll("#zeramento .tabela-colagem tbody tr");
    var hoje = dataHoje_ptBR();
    var saida = [];

    for (var r=0; r<rows.length; r++){
      var tr = rows[r];
      var c = Array.from(tr.cells).map(function(td){ return String(td.innerText||"").trim(); });
      while(c.length < 9) c.push("");

      var codigo = c[0];
      var chave5 = c[2], chave6 = c[3], chave7 = c[4];

      var qtd1 = normalizeQTD(c[5]||"0");
      var qtd2 = normalizeQTD(c[6]||"0");

      var qtd3AbsNum = absQTDNumFromText(c[7]||"0");
      if(qtd3AbsNum === 0) continue;
      var qtd3Txt = formatQtdTxtFromNum(qtd3AbsNum);

      var local = (c[8]||"164").trim() || "164";

      if(!codigo && !chave5 && !chave6 && !chave7 && qtd1===0 && qtd2===0) continue;

      var f5 = await mapearOuCadastrar(chave5);
      var f6 = await mapearOuCadastrar(chave6);
      var f7 = await mapearOuCadastrar(chave7);

      var tipo = (qtd2 > qtd1) ? "E" : "S";
      var final = (qtd2 > qtd1) ? "1905" : "5906";

      var valor = (qtd3AbsNum * 0.01).toFixed(2).replace(".", ",");

      saida.push(["M1",tipo,hoje,codigo,f5,f6,f7,local,qtd3Txt,"0,01",valor,final].join("|"));
    }

    if(!saida.length) return alert("Nada para importar.");
    baixarComoTXT("importacao_zeramento", saida.join("\n"));
  } catch(err){
    alert("Erro: " + err.message);
  }
}

async function importacaoRequisicao(){
  try{
    var rows = document.querySelectorAll("#requisicao .tabela-colagem tbody tr");
    var hoje = dataHoje_ptBR();
    var requisitante = await getRequisitantePorUsuario(USUARIO_LOGADO);

    var pedidos = new Map();

    for (var r=0; r<rows.length; r++){
      var tr = rows[r];
      var raw = Array.from(tr.cells).map(function(td){ return String(td.innerText||"").trim(); });
      if(raw.every(function(x){return !x;})) continue;

      var pedido = (raw[0]||"").trim();
      var cliente = (raw[1]||"").trim();
      var codigo = (raw[2]||"").trim();
      var k5 = (raw[3]||"").trim();
      var k6 = (raw[4]||"").trim();
      var k7 = (raw[5]||"").trim();

      var qtdAbsNum = absQTDNumFromText(raw[6]||"0");
      if(qtdAbsNum === 0) continue;
      var qtdTxt = formatQtdTxtFromNum(qtdAbsNum);

      if(!pedido || !codigo) continue;

      if(!pedidos.has(pedido)) pedidos.set(pedido, {cliente:cliente, itens:[]});
      if(!pedidos.get(pedido).cliente && cliente) pedidos.get(pedido).cliente = cliente;

      pedidos.get(pedido).itens.push({codigo:codigo, k5:k5, k6:k6, k7:k7, qtd:qtdTxt});
    }

    var out = [];
    pedidos.forEach(async function(){});
    for (const [pedido, obj] of pedidos.entries()){
      out.push(["R",hoje,"1","1",requisitante,"27",pedido+"  -  "+(obj.cliente||""),pedido,"0","0"].join("|"));
      for (var i=0;i<obj.itens.length;i++){
        var it = obj.itens[i];
        var local = await getLocalPorItem(it.codigo);
        out.push(["I","P",it.codigo,it.k5||"",it.k6||"",it.k7||"",it.qtd,"3",local].join("|"));
      }
    }

    if(!out.length) return alert("Nada para importar.");
    baixarComoTXT("importacao_requisicao", out.join("\n"));
  } catch(err){
    alert("Erro: " + err.message);
  }
}

/* Admin */
async function adminRecarregar(){
  var res = await api("admin_listarUsuarios", USUARIO_LOGADO);
  if(!res.ok) return alert(res.msg || "Erro ao listar usu√°rios");

  var sel = $("admEmailUser");
  if(sel){
    sel.innerHTML = "";
    res.usuarios.forEach(function(u){
      var op = document.createElement("option");
      op.value = u.usuario;
      op.textContent = u.usuario + " ("+u.nivel+")";
      sel.appendChild(op);
    });
  }

  renderPermsTable(res.usuarios);
}

async function adminSalvarEmail(){
  var alvo = $("admEmailUser").value;
  var novo = $("admEmailNovo").value;
  var r = await api("admin_alterarEmail", USUARIO_LOGADO, alvo, novo);
  alert(r.ok ? "Email atualizado!" : (r.msg || "Erro"));
}

function renderPermsTable(users){
  var wrap = $("adminPermsWrap");
  if(!wrap) return;
  wrap.innerHTML = "";

  var table = document.createElement("table");
  table.className = "table-admin";

  table.innerHTML =
    "<thead><tr>"+
    "<th>Usu√°rio</th><th>N√≠vel</th><th>Transfer√™ncia</th><th>Zeramento</th><th>Requisi√ß√£o</th><th>A√ß√£o</th>"+
    "</tr></thead>";

  var tb = document.createElement("tbody");

  var niveis = ["ADMIN","OPERADOR","CONSULTA","USER"];
  var perms = ["EDITAR","VISUALIZAR","BLOQUEAR"];

  users.forEach(function(u){
    var tr = document.createElement("tr");

    var selNivel = mkSelect(niveis, u.nivel);
    var selT = mkSelect(perms, u.perms.transferencia);
    var selZ = mkSelect(perms, u.perms.zeramento);
    var selR = mkSelect(perms, u.perms.requisicao);

    var btn = document.createElement("button");
    btn.className = "btn";
    btn.style.margin = "0";
    btn.style.padding = "10px 12px";
    btn.textContent = "Salvar";
    btn.onclick = async function(){
      var resp = await api("admin_salvarPermissoes", USUARIO_LOGADO, u.usuario, selNivel.value, selT.value, selZ.value, selR.value);
      alert(resp.ok ? "Salvo!" : (resp.msg || "Erro"));
    };

    tr.appendChild(tdText(u.usuario));
    tr.appendChild(tdWrap(selNivel));
    tr.appendChild(tdWrap(selT));
    tr.appendChild(tdWrap(selZ));
    tr.appendChild(tdWrap(selR));
    tr.appendChild(tdWrap(btn));
    tb.appendChild(tr);
  });

  table.appendChild(tb);
  wrap.appendChild(table);

  function mkSelect(opts, current){
    var s = document.createElement("select");
    opts.forEach(function(o){
      var op = document.createElement("option");
      op.value = o; op.textContent = o;
      if(String(current||"").toUpperCase() === o) op.selected = true;
      s.appendChild(op);
    });
    return s;
  }
  function tdText(t){ var td=document.createElement("td"); td.textContent=t; return td; }
  function tdWrap(el){ var td=document.createElement("td"); td.appendChild(el); return td; }
}

/* Config shortcut */
function openConfig(){
  abrir("cfgTransfer");
}

/* Enter no login */
$("usuario").addEventListener("keyup", function(e){ if(e.key === "Enter") entrar(); });
$("senha").addEventListener("keyup", function(e){ if(e.key === "Enter") entrar(); });

</script>
</body>
</html>
